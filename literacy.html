<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Geospatial Literacy</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Geist&family=Geist+Mono&display=swap" rel="stylesheet">
  <style>
    /* Add box-sizing to all elements for consistent box model behavior */
    *, *::before, *::after {
      box-sizing: border-box;
    }

    /* Text selection styling */
    ::selection {
      background: red; /* Red background when selecting text */
      color: white; /* White text on selection */
    }

    body {
      font-family: 'Geist Mono', monospace;
      background: #f2f2f2;
      margin: 0;
      padding: 0;
      overflow: hidden; /* Prevents body from scrolling horizontally */
      display: flex;
      flex-direction: column;
      height: 100vh;
    }
    .nav {
      display: flex;
      justify-content: flex-start;
      align-items: center;
      padding: 4px 40px 4px 20px; /* Increased top padding to move lower */
      font-size: 18px;
      font-weight: bold;
      color: #000;
      gap: 10px;
      background: #ff3636;
    }
    .nav a {
      font-size: 18px;
      text-decoration: none;
      color: #9b1414;
      border-bottom: none;
      padding: 5px 10px;
    }
    .nav a:hover {
      color: #000;
    }
    .nav a.active {
      color: #000;
    }
    .csv-upload {
      display: none;
    }
    .stats {
      font-size: 96px; /* Same as the counter text */
      padding-top: 20px;
      padding-bottom: 10px;
      padding-left: 20px;
      color: #000;
    }
    .filter-container {
      padding: 0;
      background: #f2f2f2;
    }
    .filter-group {
      background: #fff;
      border: none;
      border-radius: 0;
      margin-bottom: 0;
      overflow: hidden;
    }
    .filter-group:not(:first-child) {
      border-top: 1px solid #000;
    }
    .filter-group-header {
      padding: 10px 30px;
      font-size: 18px;
      font-weight: bold;
      background: #e6e6e6;
      cursor: pointer;
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-bottom: none;
      color: #999; /* Faint grey when inactive */
    }

    /* New rule for filter group headers when filters are generally active */
    body.filters-active .filter-group-header {
        color: #000; /* Black when main filter toggle is on */
    }


    .filter-group-content {
      max-height: 0;
      overflow: hidden;
      transition: max-height 0.3s ease-out;
      padding: 0 20px;
      background-color: #e6e6e6;
    }
    .filter-group.active .filter-group-content {
      max-height: 600px;
      padding-bottom: 15px;
    }
    .filter-title {
      font-size: 14px; /* Made smaller */
      font-weight: bold;
      margin-top: 15px;
      margin-bottom: 8px;
      color: #666; /* Closer to background gray */
    }
    .filter-group-content .filter-title:first-of-type {
        margin-top: 0;
    }
    .filter-pills {
      display: flex;
      flex-wrap: nowrap; /* Ensures horizontal scrolling */
      gap: 8px;
      overflow-x: auto; /* Enables horizontal scrolling */
      padding-bottom: 8px;
      -webkit-overflow-scrolling: touch; /* Smoother scrolling on iOS */
    }
    .filter-pills::-webkit-scrollbar {
        display: none; /* Hide scrollbar for Webkit browsers */
    }
    .filter-pills {
        -ms-overflow-style: none; /* Hide scrollbar for IE/Edge */
        scrollbar-width: none; /* Hide scrollbar for Firefox */
    }
    .pill {
      flex-shrink: 0;
      padding: 6px 12px;
      border-radius: 16px;
      border: 1px solid #999;
      background: transparent;
      cursor: pointer;
      font-size: 13px;
      transition: all 0.2s ease;
      color: #000;
    }
    .pill:hover {
      background: rgba(0, 0, 0, 0.1);
    }
    .pill.active {
      background: #000;
      color: white;
      border-color: #000;
    }
    .year-range-filter {
      display: flex;
      gap: 10px;
      margin-top: 8px;
      align-items: center; /* Vertically align items */
    }
    .year-range-filter input[type="number"] {
      padding: 6px 10px;
      border: 1px solid #999;
      background: transparent;
      border-radius: 10px;
      font-size: 13px;
      width: 80px;
      color: #000;
    }
    .table-view-container, .quote-only-view-container, .terms-view-container {
      margin: 0;
      flex-grow: 1;
      overflow-y: auto;
      overflow-x: auto; /* Allows horizontal scrolling for the table */
      position: relative;
      background: #f2f2f2;
    }
    table {
      width: 100%;
      min-width: 900px; /* Ensures table doesn't shrink too much on smaller screens */
      border-collapse: collapse;
      background: #fff;
      table-layout: fixed; /* Added this line */
    }
    th, td {
      text-align: left;
      padding: 4px 12px;
      border-bottom: 1px solid #D3D3D3;
      border-top: 1px solid #D3D3D3;
      font-family: 'Geist Mono', monospace;
      vertical-align: top;
      font-size: 13px;
      word-wrap: break-word; /* Allows text to break to the next line */
    }

    /* Specific styles for all columns (since all are now primary data) */
    th, td {
      border-bottom: 1px solid #000; /* All main rows have black bottom border */
    }
    th {
      border-top: none; /* No top border for header cells */
    }
    td {
      border-top: 1px solid #000; /* All data cells have black top border */
    }

    /* Fixed width for specific columns */
    th:nth-child(1), td:nth-child(1) { width: 8%; min-width: 8%; max-width: 8%; } /* Year */
    th:nth-child(2), td:nth-child(2) { width: 20%; min-width: 20%; max-width: 20%; } /* Title */
    th:nth-child(3), td:nth-child(3) { width: 5%; min-width: 5%; max-width: 5%; } /* Link */
    th:nth-child(4), td:nth-child(4) { width: 12%; min-width: 12%; max-width: 12%; } /* Author */
    th:nth-child(5), td:nth-child(5) { width: 12%; min-width: 12%; max-width: 12%; } /* Platform/Publisher */
    th:nth-child(6), td:nth-child(6) { width: 10%; min-width: 10%; max-width: 10%; } /* Category */
    th:nth-child(7), td:nth-child(7) { width: 8%; min-width: 8%; max-width: 8%; } /* Type */
    th:nth-child(8), td:nth-child(8) { width: 25%; min-width: 25%; max-width: 25%; } /* Quote(s) */

    thead {
      position: sticky;
      top: 0;
      z-index: 10;
    }
    th {
      background: #000;
      color: white;
      border-top: none;
      border-bottom: 1px solid #000;
    }
    a {
      color: #ff3636;
      text-decoration: none;
      border-bottom: none;
    }
    .month {
      color: gray;
    }

    /* Toggle Switches Container */
    .toggles-container {
      background: #f2f2f2;
      padding: 0 40px 10px 30px;
      display: flex;
      justify-content: flex-start;
      align-items: center;
      gap: 20px; /* Space between the two toggle groups */
      margin-top: 10px; /* Space between filter toggle and view toggle */
    }

    .filter-toggle-group, .view-toggle-group {
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .filter-toggle-label, .view-toggle-label {
      font-size: 18px;
      font-weight: 700;
      color: #000;
    }

    /* The switch - the box around the slider */
    .switch {
      position: relative;
      display: inline-block;
      width: 40px;
      height: 24px;
    }

    /* Hide default HTML checkbox */
    .switch input {
      opacity: 0;
      width: 0;
      height: 0;
    }

    /* The slider */
    .slider {
      position: absolute;
      cursor: pointer;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: #ccc;
      -webkit-transition: .4s;
      transition: .4s;
      border-radius: 24px;
    }

    .slider:before {
      position: absolute;
      content: "";
      height: 18px;
      width: 18px;
      left: 3px;
      bottom: 3px;
      background-color: white;
      -webkit-transition: .4s;
      transition: .4s;
      border-radius: 50%;
    }

    input:checked + .slider {
      background-color: #000;
    }

    input:focus + .slider {
      box-shadow: 0 0 1px #000;
    }

    input:checked + .slider:before {
      -webkit-transform: translateX(16px);
      -ms-transform: translateX(16px);
      transform: translateX(16px);
    }

    /* Overlay styles */
    .overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: transparent;
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 1000;
      font-size: 10em;
      font-weight: bold;
      color: #333;
      text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
      pointer-events: none;
      opacity: 1;
      transition: opacity 0.5s ease-out;
    }
    .overlay.hidden {
      opacity: 0;
      visibility: hidden;
    }

    /* Show/Hide View Containers */
    .table-view-container.hidden,
    .quote-only-view-container.hidden,
    .terms-view-container.hidden {
      display: none;
    }

    /* Quote-Only View Specific Styles */
    .quote-only-view-container {
      padding: 20px 40px;
      background: #fff;
      overflow-y: auto;
      border-top: 1px solid #000;
    }

    .quote-only-view-container .literature-quote-item {
      font-size: 80px; /* Increased font size */
      font-weight: bold;
      margin-bottom: 20px;
      line-height: 1.2;
      color: #000;
      border-bottom: 1px solid #eee; /* Light separator */
      padding-bottom: 15px;
      cursor: default; /* Changed to default as quotes are no longer clickable */
      display: flex; /* Changed to flex to align author to bottom */
      flex-direction: column; /* Stack quote and author vertically */
      justify-content: flex-start; /* Align content to the start (top) */
      text-decoration: none; /* Remove underline from link */
      text-transform: uppercase; /* All caps */
      white-space: normal; /* Allow text to wrap */
      overflow: visible; /* Allow content to be visible */
      text-overflow: clip; /* Remove ellipsis */
      font-family: 'Geist', sans-serif; /* Use Geist font */
    }

    .quote-only-view-container .literature-quote-item:last-child {
      border-bottom: none; /* No border for the last item */
      margin-bottom: 0;
    }
    .quote-only-view-container .literature-quote-item a {
        color: inherit; /* Inherit color from parent div */
        text-decoration: none; /* No underline */
    }

    .quote-author {
      font-size: 14px; /* Author font size */
      font-weight: normal; /* Author not bold */
      color: #555; /* A bit lighter color for author */
      margin-top: 5px; /* Reduced space above author, closer to quote */
      text-align: left; /* Aligned to the left */
      text-transform: none; /* Author should not be all caps */
      /* Add some padding to differentiate from the quote if needed */
      padding-left: 10px; /* Example: add a small indent */
      font-family: 'Geist Mono', monospace; /* Use Geist Mono for author/source/year */
    }

    /* Terms View Specific Styles */
    .terms-view-container {
        padding: 20px 40px;
        background: #fff;
        overflow-y: auto;
        border-top: 1px solid #000;
        display: grid;
        grid-template-columns: repeat(4, 1fr); /* 4 columns */
        gap: 20px; /* Gap between columns and rows */
    }

    .terms-view-container .term-column {
        display: flex;
        flex-direction: column;
        gap: 5px; /* Space between terms within a column */
    }

    .terms-view-container .term-letter {
        font-size: 18px; /* Small letter for each section */
        font-weight: bold;
        color: #000;
        margin-bottom: 0; /* Remove extra margin */
        margin-top: 20px;
        text-transform: uppercase;
        border-bottom: none; /* Removed the underline */
        padding-bottom: 0; /* Removed padding */
    }

    .terms-view-container .term-item {
        font-size: 48px; /* Large font size for individual terms */
        line-height: 0.9; /* Adjusted line height to be smaller */
        color: #000;
        margin-top: 10px; /* Add margin for spacing between terms and letter */
        cursor: pointer; /* Indicate clickability */
    }

    .term-definition {
        font-family: 'Geist Mono', monospace;
        font-size: 14px;
        line-height: 1.2; /* Adjust for readability */
        color: #333; /* Darker grey than term, but not black */
        margin-top: 5px; /* Small space below term */
        margin-bottom: 15px; /* Space before next term or letter */
        padding: 2px; /* Some padding around the definition */
        background-color: #ffffff; /* Light background for definition box */
        border-radius: 4px; /* Slightly rounded corners */
        display: none; /* Initially hidden */
        word-break: break-word; /* Ensure long words break */
    }

    .term-definition.active {
        display: block; /* Show when active */
    }

    /* Spacing for article count numbers */
    .article-count-number {
      margin-left: 30px; /* Default for desktop */
    }

    sup .article-count-number {
      margin-left: 1px; /* Default for desktop superscript */
    }

    /* --- Responsive Design --- */

    /* For screens smaller than 768px (tablets and smaller) */
    @media (max-width: 768px) {
      .nav {
        padding: 15px 20px 15px 15px;
        font-size: 18px;
        gap: 5px;
      }
      .nav a {
        font-size: 18px;
        padding: 3px 8px;
      }
      .stats {
        font-size: 60px;
        padding: 15px 20px 5px 20px;
      }
      .toggles-container {
        padding: 0 20px 10px 15px;
        gap: 15px;
      }
      .filter-toggle-label, .view-toggle-label {
        font-size: 16px;
      }
      .filter-group-header {
        font-size: 16px;
        padding: 8px 15px;
      }
      .filter-group-content {
        padding: 0 15px;
      }
      .filter-title {
        font-size: 12px;
      }
      .pill {
        font-size: 12px;
        padding: 5px 10px;
      }
      .year-range-filter input[type="number"] {
        font-size: 12px;
        width: 60px;
      }
      th, td {
        font-size: 12px;
        padding: 6px 8px;
      }
      table {
        min-width: 700px;
      }
      .overlay {
        font-size: 7em;
      }
      .quote-only-view-container {
        padding: 15px 20px;
      }
      .quote-only-view-container .literature-quote-item {
        font-size: 40px; /* Half of 80px -> 40px */
        margin-bottom: 15px;
        padding-bottom: 10px;
      }
      .quote-author {
        font-size: 12px; /* Smaller author font size */
        margin-top: 8px;
        padding-left: 8px;
      }
      .terms-view-container {
          padding: 15px 20px;
          grid-template-columns: repeat(2, 1fr); /* 2 columns on tablets */
          gap: 15px;
      }
      .terms-view-container .term-letter {
          font-size: 16px; /* Adjusted for responsive */
      }
      .terms-view-container .term-item {
          font-size: 36px; /* Adjusted for responsive */
      }
      .term-definition {
          font-size: 16px;
      }
    }

    /* For screens smaller than 480px (mobile phones) */
    @media (max-width: 480px) {
      .nav {
        padding: 5px 20px 5px 5px;
        font-size: 18px;
        gap: 5px;
      }
      .nav a {
        font-size: 17px;
        padding: 3px 8px;
      }
      .stats {
        font-size: 44px;
        padding-top: 30px;
        padding-left: 10px;
      }
      .filter-group-header {
        font-size: 16px;
        padding: 6px 15px;
      }
      .filter-group-content {
        padding: 0 10px;
      }
      .filter-title {
        font-size: 12px;
      }
      .pill {
        font-size: 12px;
        padding: 5px 10px;
      }
      .year-range-filter input[type="number"] {
        width: 60px;
        padding: 5px 16px;
      }
      /* HIDE ALL COLUMNS FROM THE 4TH ONWARDS FOR SMALL VIEWPORT */
      th:nth-child(n+4),
      td:nth-child(n+4) {
        display: none;
      }
      /* Adjust widths for the first three visible columns to fill the viewport */
      th:nth-child(1),
      td:nth-child(1) {
        width: 15%; /* Year */
        min-width: 15%;
        max-width: 15%;
      }
      th:nth-child(2),
      td:nth-child(2) {
        width: 60%; /* Title */
        min-width: 60%;
        max-width: 60%;
      }
      th:nth-child(3),
      td:nth-child(3) {
        width: 15%; /* Link */
        min-width: 15%;
        max-width: 15%;
      }
      th, td {
        font-size: 12.5px;
        padding: 6px 8px;
      }
      table {
        min-width: 300px;
      }
      .overlay {
        font-size: 4em;
      }
      .toggles-container {
        padding: 0 10px 10px 10px;
        flex-wrap: wrap; /* Allow toggles to wrap */
      }
      .filter-toggle-label, .view-toggle-label {
        font-size: 14px; /* Slightly smaller labels on mobile */
      }
      /* Smaller toggle switch on mobile */
      .switch {
        width: 34px; /* Slightly smaller width */
        height: 20px; /* Slightly smaller height */
      }
      .slider:before {
        height: 14px; /* Slightly smaller circle */
        width: 14px; /* Slightly smaller circle */
        left: 3px;
        bottom: 3px; /* Keep consistent with remaining space */
      }
      input:checked + .slider:before {
        -webkit-transform: translateX(14px); /* (34 - 3 - 14) = 17. Adjust based on new width and circle size */
        -ms-transform: translateX(14px);
        transform: translateX(14px);
      }
      .quote-only-view-container {
        padding: 10px 15px;
      }
      .quote-only-view-container .literature-quote-item {
        font-size: 25px; /* Adjusted for responsive */
        margin-bottom: 10px;
        padding-bottom: 8px;
      }
      .quote-author {
        font-size: 10px; /* Even smaller author font size */
        margin-top: 5px;
        padding-left: 5px;
      }
      .terms-view-container {
          padding: 10px 15px;
          grid-template-columns: 1fr; /* 1 column on mobile */
          gap: 10px;
      }
      .terms-view-container .term-letter {
          font-size: 14px; /* Adjusted for responsive */
      }
      .terms-view-container .term-item {
          font-size: 28px; /* Adjusted for responsive */
      }
      .term-definition {
          font-size: 14px;
      }
      /* Mobile-specific spacing for article count numbers */
      .article-count-number {
        margin-left: 20px;
      }

      sup .article-count-number {
        margin-left: 0px;
      }
    }
  </style>
</head>
<body>
  <div id="fixed-header-area">
    <div class="nav">
      <a href="index.html">Index</a>
      <a href="literacy.html" class="active">Literacy</a>
      <a href="about.html">About</a>
    </div>
    <div class="stats">
      <span id="loadingStatus">Loading data...</span>
      <div id="statsDisplay" style="display: none;"></div>
    </div>

    <div class="toggles-container">
        <div class="filter-toggle-group">
            <span class="filter-toggle-label">FILTERS</span>
            <label class="switch">
                <input type="checkbox" id="filterToggle">
                <span class="slider"></span>
            </label>
        </div>
        <div class="view-toggle-group">
            <span class="view-toggle-label">QUOTES</span>
            <label class="switch">
                <input type="checkbox" id="quotesToggle">
                <span class="slider"></span>
            </label>
        </div>
        <div class="view-toggle-group">
            <span class="view-toggle-label">TERMS</span>
            <label class="switch">
                <input type="checkbox" id="termsToggle">
                <span class="slider"></span>
            </label>
        </div>
    </div>

    <div class="filter-container">
      <div class="filter-group" id="literature-group">
          <div class="filter-group-header">LITERATURE</div>
          <div class="filter-group-content">
              <div class="filter-title">Publication Year Range:</div>
              <div class="year-range-filter">
                  <button class="pill active" data-type="publicationYear" data-value="all">All</button>
                  <input type="number" id="fromYearInput" placeholder="Year">
                  <input type="number" id="toYearInput" placeholder="Year">
              </div>

              <div class="filter-title">Category:</div>
              <div class="filter-pills" id="category-filter-pills">
                  <button class="pill active" data-type="category" data-value="all">All</button>
              </div>

              <div class="filter-title">Media Type:</div>
              <div class="filter-pills" id="type-filter-pills">
                  <button class="pill active" data-type="type" data-value="all">All</button>
              </div>
          </div>
      </div>

      <div class="filter-group" id="terms-filter-group">
          <div class="filter-group-header">TERMS</div>
          <div class="filter-group-content">
              <div class="filter-title">Meaning Type:</div>
              <div class="filter-pills" id="meaning-type-filter-pills">
                  <button class="pill active" data-type="meaning-type" data-value="all">All</button>
                  <button class="pill" data-type="meaning-type" data-value="technical/scientific">Technical/Scientific</button>
                  <button class="pill" data-type="meaning-type" data-value="media theoretical/philosophical">Media Theoretical/Philosophical</button>
              </div>
          </div>
      </div>

    </div>
  </div>

  <div id="tableViewContainer" class="table-view-container">
    <table>
      <thead>
        <tr>
          <th>Year</th>
          <th>Title</th>
          <th>Link</th>
          <th>Author</th>
          <th>Platform/Publisher</th>
          <th>Category</th>
          <th>Type</th>
          <th>Quote(s)</th>
        </tr>
      </thead>
      <tbody>
        </tbody>
    </table>
  </div>

  <div id="quoteOnlyViewContainer" class="quote-only-view-container hidden">
    </div>

  <div id="termsViewContainer" class="terms-view-container hidden">
    </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
  <script>
    let allData = [];
    let termsData = {}; // To store terms loaded from CSV
    let filtersActive = false;
    let currentView = 'table'; // 'table', 'quote', or 'terms'
    let currentOpenDefinitionElement = null; // Global variable to track the currently open definition

    // --- GLOBAL FUNCTIONS ---
    function extractYears(yearString) {
        if (!yearString) return [];
        const yearMatches = String(yearString).match(/\b\d{4}\b/g); // Ensure it's treated as string
        return yearMatches ? Array.from(new Set(yearMatches)).sort() : [];
    }

    function adjustContentViewHeight() {
      const fixedHeader = document.getElementById('fixed-header-area');
      const togglesContainer = document.querySelector('.toggles-container');
      const tableViewContainer = document.getElementById('tableViewContainer');
      const quoteOnlyViewContainer = document.getElementById('quoteOnlyViewContainer');
      const termsViewContainer = document.getElementById('termsViewContainer');

      if (fixedHeader && togglesContainer) {
        const headerHeight = fixedHeader.offsetHeight;
        const togglesHeight = togglesContainer.offsetHeight;
        const remainingHeight = `calc(100vh - ${headerHeight}px - ${togglesHeight}px)`;

        if (tableViewContainer) {
            tableViewContainer.style.height = remainingHeight;
        }
        if (quoteOnlyViewContainer) {
            quoteOnlyViewContainer.style.height = remainingHeight;
        }
        if (termsViewContainer) {
            termsViewContainer.style.height = remainingHeight;
        }
      }
    }

    // Function to format definition text for even line breaks
    function formatDefinitionText(text, maxCharsPerLine) {
        if (!text) return '';
        const words = text.split(' ');
        let lines = [];
        let currentLine = [];
        let currentLineLength = 0;

        words.forEach(word => {
            // Check if adding the next word (plus a space) exceeds maxCharsPerLine
            // If it's the first word in a line, allow it to be longer if necessary (for very long words)
            if (currentLineLength + (currentLine.length > 0 ? 1 : 0) + word.length > maxCharsPerLine && currentLine.length > 0) {
                lines.push(currentLine.join(' '));
                currentLine = [word];
                currentLineLength = word.length;
            } else {
                currentLine.push(word);
                currentLineLength += (currentLine.length > 1 ? 1 : 0) + word.length;
            }
        });
        lines.push(currentLine.join(' ')); // Add the last line

        return lines.join('<br>');
    }

    // --- END GLOBAL FUNCTIONS ---

    document.addEventListener('DOMContentLoaded', function() {
  // Year Range "All" button behavior
  const yearAllButton = document.querySelector('.pill[data-type="publicationYear"][data-value="all"]');
  const fromYearInput = document.getElementById('fromYearInput');
  const toYearInput = document.getElementById('toYearInput');

  // Set correct active state on "All" click
  yearAllButton.addEventListener('click', function () {
    fromYearInput.value = '';
    toYearInput.value = '';
    yearAllButton.classList.add('active');
    filterTable();
  });

  // Clear active state of "All" when typing into year inputs
  [fromYearInput, toYearInput].forEach(input => {
    input.addEventListener('input', () => {
      if (fromYearInput.value || toYearInput.value) {
        yearAllButton.classList.remove('active');
      }
      filterTable();
    });
  });

      // Load both CSVs concurrently
      Promise.all([
        loadLiteratureData(),
        loadTermsData()
      ]).then(() => {
        initializeFilters();
        filterTable(); // Initial render after all data is loaded
        document.getElementById('loadingStatus').style.display = 'none';
        document.getElementById('statsDisplay').style.display = 'block';
      }).catch(error => {
        console.error('Error loading data:', error);
        document.getElementById('loadingStatus').textContent = 'Error loading data. Showing sample data.'; // Display error
        // Fallback to sample data for both if loading fails
        loadSampleLiteratureData();
        loadSampleTermsData();
        initializeFilters();
        filterTable();
        document.getElementById('statsDisplay').style.display = 'block';
      });


      document.querySelectorAll('.filter-pills .pill').forEach(pill => {
        pill.addEventListener('click', handlePillClick);
      });

      document.getElementById('fromYearInput').addEventListener('input', filterTable);
      document.getElementById('toYearInput').addEventListener('input', filterTable);

      document.querySelectorAll('.filter-group-header').forEach(header => {
        header.addEventListener('click', function() {
          const group = this.closest('.filter-group');
          if (filtersActive) {
            group.classList.toggle('active');
            adjustContentViewHeight();
          }
        });
      });

      const filterToggle = document.getElementById('filterToggle');
      filterToggle.addEventListener('change', function() {
        filtersActive = this.checked;
        if (filtersActive) {
            document.body.classList.add('filters-active');
        } else {
            document.body.classList.remove('filters-active');
        }
        toggleAllFilters(true);
        filterTable();
      });

      const quotesToggle = document.getElementById('quotesToggle');
      quotesToggle.addEventListener('change', function() {
          if (this.checked) {
              currentView = 'quote';
              document.getElementById('termsToggle').checked = false; // Uncheck terms toggle
          } else if (!document.getElementById('termsToggle').checked) {
              currentView = 'table';
          }
          updateView();
      });

      const termsToggle = document.getElementById('termsToggle');
      termsToggle.addEventListener('change', function() {
          if (this.checked) {
              currentView = 'terms';
              document.getElementById('quotesToggle').checked = false; // Uncheck quotes toggle
          } else if (!document.getElementById('quotesToggle').checked) {
              currentView = 'table';
          }
          updateView();
      });

      const currentPath = window.location.pathname.split('/').pop();
      document.querySelectorAll('.nav a').forEach(link => {
        if (link.getAttribute('href') === currentPath && link.getAttribute('href') !== 'index.html') {
          document.querySelector('.nav a[href="index.html"]').classList.remove('active');
          link.classList.add('active');
        } else if (currentPath === '' && link.getAttribute('href') === 'index.html') {
          // This ensures index.html is active when directly loading the root or index.html
        }
      });

      adjustContentViewHeight();
      window.addEventListener('resize', adjustContentViewHeight);

      const initialOverlay = document.getElementById('initialOverlay');
      const hideOverlay = () => {
        if (initialOverlay && !initialOverlay.classList.contains('hidden')) {
          initialOverlay.classList.add('hidden');
          document.removeEventListener('mousemove', hideOverlay);
          document.removeEventListener('scroll', hideOverlay);
          document.removeEventListener('click', hideOverlay);
          document.removeEventListener('keydown', hideOverlay);
        }
      };

      document.addEventListener('mousemove', hideOverlay);
      document.addEventListener('scroll', hideOverlay);
      document.addEventListener('click', hideOverlay);
      document.addEventListener('keydown', hideOverlay);
    });

    function handlePillClick(event) {
      const clickedPill = event.target;
      const dataType = clickedPill.dataset.type;
      const value = clickedPill.dataset.value;
      const parentContainer = clickedPill.closest('.filter-pills');

      // If "All" is clicked, activate "All" and deactivate others
      if (value === 'all') {
        parentContainer.querySelectorAll('.pill').forEach(pill => {
          pill.classList.remove('active');
        });
        clickedPill.classList.add('active');
      } else {
        // Deactivate "All" if another pill is clicked
        parentContainer.querySelector('.pill[data-value="all"]').classList.remove('active');
        clickedPill.classList.toggle('active');

        // If no other pills are active, reactivate "All"
        const activePills = parentContainer.querySelectorAll('.pill.active:not([data-value="all"])');
        if (activePills.length === 0) {
          parentContainer.querySelector('.pill[data-value="all"]').classList.add('active');
        }
      }
      filterTable();
    }

    function toggleAllFilters(forceClose = false) {
        document.querySelectorAll('.filter-group').forEach(group => {
            if (forceClose || !filtersActive) {
                group.classList.remove('active');
            } else {
                // If filters become active and not forced close, keep previous state or open
                // For simplicity, let's keep them closed by default when filterToggle is activated
            }
        });
        adjustContentViewHeight(); // Adjust height after toggling filters
    }

    function updateView() {
        const tableViewContainer = document.getElementById('tableViewContainer');
        const quoteOnlyViewContainer = document.getElementById('quoteOnlyViewContainer');
        const termsViewContainer = document.getElementById('termsViewContainer');

        tableViewContainer.classList.add('hidden');
        quoteOnlyViewContainer.classList.add('hidden');
        termsViewContainer.classList.add('hidden');

        if (currentView === 'table') {
            tableViewContainer.classList.remove('hidden');
            renderTable(allData);
        } else if (currentView === 'quote') {
            quoteOnlyViewContainer.classList.remove('hidden');
            renderQuotes();
        } else if (currentView === 'terms') {
            termsViewContainer.classList.remove('hidden');
            renderTerms();
        }
        adjustContentViewHeight();
        updateFilterCount(allData.length); // Update counter after view change
    }

    async function loadLiteratureData() {
      const loadingStatus = document.getElementById('loadingStatus');
      try {
        loadingStatus.textContent = 'Loading literature data...';
        const response = await fetch('./literature.csv');
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        const csvText = await response.text();
        Papa.parse(csvText, {
          header: true,
          skipEmptyLines: true,
          dynamicTyping: false,
          complete: function(results) {
            allData = results.data.map(row => ({
                ...row,
                publicationYear: row.Year ? parseInt(row.Year, 10) : null
            }));
            populateFilterPills('category', 'category-filter-pills');
            populateFilterPills('type', 'type-filter-pills');
            filterTable();
          }
        });
      } catch (error) {
        console.error('Error loading literature data:', error);
        loadingStatus.textContent = 'Error loading literature data. Showing sample data.';
        loadSampleLiteratureData();
      }
    }

    function loadSampleLiteratureData() {
        allData = [
            { Year: "2023", Title: "Sample Article 1", Link: "http://example.com/1", Author: "John Doe", "Platform/Publisher": "Journal A", Category: "Remote Sensing", Type: "Paper", Quote: "This is a sample quote from article 1." },
            { Year: "2022", Title: "Sample Article 2", Link: "http://example.com/2", Author: "Jane Smith", "Platform/Publisher": "Conference B", Category: "GIS", Type: "Presentation", Quote: "Another quote from sample article 2." },
            { Year: "2023", Title: "Sample Article 3", Link: "http://example.com/3", Author: "Peter Jones", "Platform/Publisher": "Book C", Category: "Cartography", Type: "Book Chapter", Quote: "Third sample quote." },
            { Year: "2021", Title: "Sample Article 4", Link: "http://example.com/4", Author: "Alice Brown", "Platform/Publisher": "Journal D", Category: "Remote Sensing", Type: "Paper", Quote: "Fourth quote, very insightful." },
            { Year: "2020", Title: "Sample Article 5", Link: "http://example.com/5", Author: "Bob White", "Platform/Publisher": "Blog E", Category: "GIS", Type: "Web Article", Quote: "Fifth quote for testing." }
        ].map(row => ({
            ...row,
            publicationYear: row.Year ? parseInt(row.Year, 10) : null
        }));
        populateFilterPills('category', 'category-filter-pills');
        populateFilterPills('type', 'type-filter-pills');
        filterTable();
    }

    async function loadTermsData() {
        const loadingStatus = document.getElementById('loadingStatus');
        try {
            loadingStatus.textContent = 'Loading terms data...';
            const response = await fetch('./terms.csv');
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            const csvText = await response.text();
            Papa.parse(csvText, {
                header: true,
                skipEmptyLines: true,
                dynamicTyping: false,
                complete: function(results) {
                    termsData = {}; // Clear previous data
                    results.data.forEach(row => {
                        const term = row.Term || '';
                        const meaning = row.Meaning || '';
                        const meaningType = row['Meaning Type'] || '';
                        if (term && meaning) {
                            const firstLetter = term.charAt(0).toUpperCase();
                            if (!termsData[firstLetter]) {
                                termsData[firstLetter] = [];
                            }
                            termsData[firstLetter].push({ term, meaning, meaningType });
                        }
                    });
                    // Sort terms alphabetically within each letter group
                    for (const letter in termsData) {
                        termsData[letter].sort((a, b) => a.term.localeCompare(b.term));
                    }
                    filterTable();
                }
            });
        } catch (error) {
            console.error('Error loading terms data:', error);
            loadingStatus.textContent = 'Error loading terms data. Showing sample data.';
            loadSampleTermsData();
        }
    }

    function loadSampleTermsData() {
        termsData = {
            A: [
                { term: "Algorithm", meaning: "A set of rules to be followed in calculations or other problem-solving operations.", "Meaning Type": "technical/scientific" },
                { term: "Anomaly", meaning: "Something that deviates from what is standard, normal, or expected.", "Meaning Type": "general" }
            ],
            C: [
                { term: "Cartography", meaning: "The science or practice of drawing maps.", "Meaning Type": "technical/scientific" },
                { term: "Cybernetics", meaning: "The science of communications and automatic control systems in both machines and living things.", "Meaning Type": "media theoretical/philosophical" }
            ]
        };
        filterTable();
    }


    function populateFilterPills(dataType, containerId) {
      const container = document.getElementById(containerId);
      if (!container) return; // Ensure container exists

      // Clear existing pills except "All"
      container.querySelectorAll('.pill:not([data-value="all"])').forEach(pill => pill.remove());

      const uniqueValues = new Set();
      allData.forEach(item => {
        if (item[capitalizeFirstLetter(dataType)]) { // Use item['Category'] or item['Type']
          item[capitalizeFirstLetter(dataType)].split(/[,;]/).forEach(value => {
            const trimmedValue = value.trim();
            if (trimmedValue) {
              uniqueValues.add(trimmedValue);
            }
          });
        }
      });

      const sortedValues = Array.from(uniqueValues).sort();

      sortedValues.forEach(value => {
        const button = document.createElement('button');
        button.classList.add('pill');
        button.dataset.type = dataType;
        button.dataset.value = value;
        button.textContent = value;
        button.addEventListener('click', handlePillClick);
        container.appendChild(button);
      });
    }

    function capitalizeFirstLetter(string) {
      return string.charAt(0).toUpperCase() + string.slice(1);
    }

    function filterTable() {
      let filteredData = [...allData];
      let filteredTerms = {};

      const hasActiveLiteratureFilters = document.querySelectorAll('.filter-pills .pill.active[data-type="category"]:not([data-value="all"])').length > 0 ||
                                       document.querySelectorAll('.filter-pills .pill.active[data-type="type"]:not([data-value="all"])').length > 0 ||
                                       document.getElementById('fromYearInput').value !== '' ||
                                       document.getElementById('toYearInput').value !== '';

      const hasActiveTermsFilters = document.querySelectorAll('.pill.active[data-type="meaning-type"]:not([data-value="all"])').length > 0;

      // Apply literature filters only if filterToggle is active and literature filters are applied
      if (filtersActive && hasActiveLiteratureFilters) {
          const activeCategories = Array.from(document.querySelectorAll('.pill.active[data-type="category"]:not([data-value="all"])')).map(pill => pill.dataset.value);
          const activeTypes = Array.from(document.querySelectorAll('.pill.active[data-type="type"]:not([data-value="all"])')).map(pill => pill.dataset.value);
          const fromYear = parseInt(document.getElementById('fromYearInput').value, 10);
          const toYear = parseInt(document.getElementById('toYearInput').value, 10);

          filteredData = filteredData.filter(item => {
              let matchesCategory = true;
              if (activeCategories.length > 0 && item.Category) {
                  matchesCategory = activeCategories.some(cat => item.Category.split(/[,;]/).map(s => s.trim()).includes(cat));
              }

              let matchesType = true;
              if (activeTypes.length > 0 && item.Type) {
                  matchesType = activeTypes.some(type => item.Type.split(/[,;]/).map(s => s.trim()).includes(type));
              }

              let matchesYear = true;
              if (!isNaN(fromYear) && item.publicationYear < fromYear) {
                  matchesYear = false;
              }
              if (!isNaN(toYear) && item.publicationYear > toYear) {
                  matchesYear = false;
              }
              return matchesCategory && matchesType && matchesYear;
          });
      }

      // Apply terms filters only if filterToggle is active and terms filters are applied
      if (filtersActive && hasActiveTermsFilters) {
          const activeMeaningTypes = Array.from(document.querySelectorAll('.pill.active[data-type="meaning-type"]:not([data-value="all"])')).map(pill => pill.dataset.value);
          
          for (const letter in termsData) {
              const termsInLetter = termsData[letter].filter(termItem => {
                  let matchesMeaningType = true;
                  if (activeMeaningTypes.length > 0 && termItem['Meaning Type']) {
                      matchesMeaningType = activeMeaningTypes.includes(termItem['Meaning Type']);
                  }
                  return matchesMeaningType;
              });
              if (termsInLetter.length > 0) {
                  filteredTerms[letter] = termsInLetter;
              }
          }
      } else {
          // If no terms filters are active, or filterToggle is off, show all terms
          filteredTerms = { ...termsData };
      }

      // Render based on current view
      if (currentView === 'table') {
        renderTable(filteredData);
        updateFilterCount(filteredData.length);
      } else if (currentView === 'quote') {
        const quotesData = filteredData.filter(item => item.Quote);
        renderQuotes(quotesData);
        updateFilterCount(quotesData.length);
      } else if (currentView === 'terms') {
          renderTerms(filteredTerms);
          let totalFilteredTermsCount = 0;
          for (const letter in filteredTerms) {
              totalFilteredTermsCount += filteredTerms[letter].length;
          }
          updateFilterCount(totalFilteredTermsCount);
      }
    }


    function renderTable(data) {
      const tbody = document.querySelector('#tableViewContainer tbody');
      if (!tbody) return; // Ensure tbody exists
      tbody.innerHTML = ''; // Clear existing table rows

      data.forEach(item => {
        const row = tbody.insertRow();
        row.insertCell().textContent = item.Year || '';
        row.insertCell().textContent = item.Title || '';
        const linkCell = row.insertCell();
        if (item.Link) {
          const link = document.createElement('a');
          link.href = item.Link;
          link.textContent = 'Link';
          link.target = '_blank';
          linkCell.appendChild(link);
        } else {
          linkCell.textContent = '';
        }
        row.insertCell().textContent = item.Author || '';
        row.insertCell().textContent = item['Platform/Publisher'] || '';
        row.insertCell().textContent = item.Category || '';
        row.insertCell().textContent = item.Type || '';
        row.insertCell().textContent = item.Quote || '';
      });
    }

    function renderQuotes(data) {
        const quoteContainer = document.getElementById('quoteOnlyViewContainer');
        quoteContainer.innerHTML = ''; // Clear existing quotes

        data.forEach(item => {
            if (item.Quote) {
                const quoteItem = document.createElement('div');
                quoteItem.classList.add('literature-quote-item');

                // The quote itself
                const quoteText = document.createElement('span');
                quoteText.textContent = `"${item.Quote}"`;
                quoteItem.appendChild(quoteText);

                // Author and source details below the quote
                const details = document.createElement('div');
                details.classList.add('quote-author');
                const author = item.Author ? `${item.Author}` : '';
                const title = item.Title ? `"${item.Title}"` : '';
                const publisher = item['Platform/Publisher'] ? `${item['Platform/Publisher']}` : '';
                const year = item.Year ? `${item.Year}` : '';

                const parts = [];
                if (author) parts.push(author);
                if (title) parts.push(title);
                if (publisher) parts.push(publisher);
                if (year) parts.push(year);

                details.textContent = parts.join(', ');
                quoteItem.appendChild(details);

                quoteContainer.appendChild(quoteItem);
            }
        });
    }

    function renderTerms(data) {
        const termsContainer = document.getElementById('termsViewContainer');
        termsContainer.innerHTML = ''; // Clear existing terms

        // Sort the letters (keys) alphabetically
        const sortedLetters = Object.keys(data).sort();

        sortedLetters.forEach(letter => {
            const column = document.createElement('div');
            column.classList.add('term-column');

            const letterHeader = document.createElement('div');
            letterHeader.classList.add('term-letter');
            letterHeader.textContent = letter;
            column.appendChild(letterHeader);

            data[letter].forEach(termItem => {
                const termElement = document.createElement('div');
                termElement.classList.add('term-item');
                termElement.textContent = termItem.term;
                termElement.dataset.term = termItem.term; // Store term for identification
                termElement.addEventListener('click', function() {
                    const definition = this.nextElementSibling; // Get the definition element
                    if (definition) {
                        // Close previously open definition if it's not this one
                        if (currentOpenDefinitionElement && currentOpenDefinitionElement !== definition) {
                            currentOpenDefinitionElement.classList.remove('active');
                        }
                        definition.classList.toggle('active'); // Toggle visibility of current definition
                        currentOpenDefinitionElement = definition.classList.contains('active') ? definition : null; // Update tracker
                    }
                });
                column.appendChild(termElement);

                const definitionElement = document.createElement('div');
                definitionElement.classList.add('term-definition');
                // Format the definition text for better readability
                definitionElement.innerHTML = formatDefinitionText(termItem.meaning, 70); // Adjust maxCharsPerLine as needed
                column.appendChild(definitionElement);
            });
            termsContainer.appendChild(column);
        });
    }

    function updateFilterCount(filteredCount) {
      const totalCount = allData.length;
      const statsDisplay = document.getElementById('statsDisplay');
      if (statsDisplay) {
        // Determine if any filters are actively narrowing down the literature data
        const hasActiveLiteratureFilters = document.querySelectorAll('.filter-pills .pill.active[data-type="category"]:not([data-value="all"])').length > 0 ||
                                         document.querySelectorAll('.filter-pills .pill.active[data-type="type"]:not([data-value="all"])').length > 0 ||
                                         document.getElementById('fromYearInput').value !== '' ||
                                         document.getElementById('toYearInput').value !== '';
        // Determine if any filters are actively narrowing down the terms data
        const hasActiveTermsFilters = document.querySelectorAll('.pill.active[data-type="meaning-type"]:not([data-value="all"])').length > 0;

        // Add a class for the span that will contain the numbers
        const numberSpanClass = 'article-count-number';

        if (currentView === 'table') { // Literature data
          const totalLiterature = allData.length;
          if (hasActiveLiteratureFilters && filtersActive) {
             statsDisplay.innerHTML = `Literature:<span class="${numberSpanClass}">${filteredCount}</span><sup style="font-size: 0.5em; vertical-align: super; color: lightgrey;">/<span class="${numberSpanClass}">${totalLiterature}</span></sup>`;
          } else {
             statsDisplay.innerHTML = `Literature:<span class="${numberSpanClass}">${totalLiterature}</span>`;
          }
        } else if (currentView === 'quote') {
          const totalQuotes = allData.filter(item => item.Quote).length;
          if (hasActiveLiteratureFilters && filtersActive) {
             statsDisplay.innerHTML = `Quotes:<span class="${numberSpanClass}">${filteredCount}</span><sup style="font-size: 0.5em; vertical-align: super; color: lightgrey;">/<span class="${numberSpanClass}">${totalQuotes}</span></sup>`;
          } else {
             statsDisplay.innerHTML = `Quotes:<span class="${numberSpanClass}">${totalQuotes}</span>`;
          }
        } else if (currentView === 'terms') {
            let totalTermsCount = 0;
            for (const letter in termsData) {
                totalTermsCount += termsData[letter].length;
            }
            if (hasActiveTermsFilters && filtersActive) {
                statsDisplay.innerHTML = `Terms:<span class="${numberSpanClass}">${filteredCount}</span><sup style="font-size: 0.5em; vertical-align: super; color: lightgrey;">/<span class="${numberSpanClass}">${totalTermsCount}</span></sup>`;
            } else {
                statsDisplay.innerHTML = `Terms:<span class="${numberSpanClass}">${totalTermsCount}</span>`;
            }
        }
      }
    }
  </script>
</body>
</html>
