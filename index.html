<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Geospatial Narratives</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Geist:wght@100..900&family=Geist+Mono:wght@100..900&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200&icon_names=filter_list" />
  <link rel="icon" type="image/png" href="circle.png">
  <style>
    /* Add box-sizing to all elements for consistent box model behavior */
    *, *::before, *::after {
      box-sizing: border-box;
    }

    /* Text selection styling */
    ::selection {
      background: rgb(221, 255, 109); /* Red background when selecting text */
      color: rgb(0, 0, 0); /* White text on selection */
    }

    body {
      font-family: 'Geist Mono', monospace;
      background: #f2f2f2;
      margin: 0;
      padding: 0;
      overflow: hidden; /* Prevents body from scrolling horizontally */
      display: flex;
      flex-direction: column;
      height: 100vh;
      text-rendering: optimizeLegibility; /* Added for legibility */
    }
    .nav {
      display: flex;
      justify-content: flex-start;
      align-items: center;
      padding: 3px 40px 3px 20px; /* Increased top padding to move lower */
      font-size: 17.5px;
      font-weight: 450;
      color: #000;
      gap: 10px;
      background: rgb(221, 255, 109);
    }
    .nav a {
      font-size: 17.5px;
      font-weight: 450;
      color: rgb(155, 180, 72);
      border-bottom: none;
      padding: 5px 10px;
    }
    .nav a:hover {
      color: #000;
    }
    .nav a.active {
      color: #000; /* Changed from #5f56ff to #000 */
    }
  
    .csv-upload {
      display: none;
    }

       /* New style for the update date */
    .update-date {
        font-family: 'Geist Mono', monospace;
        font-size: 15px; /* Smaller font size for date */
        font-weight: 300;
        color: #9f9e9e; /* Softer color for date */
        padding: 10px 0 0 29px; /* Padding to position it */
    }

    .stats {
      font-size: 96px; /* Same as the counter text */
      font-weight: 400;
      padding-top: 20px;
      padding-bottom: 10px;
      padding-left: 20px;
      color: #000;
    }
    .filter-container {
      padding: 0;
      background: #f2f2f2;
      /* border-top: 1px solid #000; /* Removed line on top */
    }
    .filter-group {
      background: #fff;
      border: none;
      border-radius: 0;
      margin-bottom: 0;
      overflow: hidden;
    }
    .filter-group:not(:first-child) {
      border-top: 1px solid #000;
    }
    .filter-group-header {
      padding: 6px 20px; /* Adjusted padding */
      font-size: 18px;
      font-weight: 500;
      background: #e6e6e6;
      cursor: pointer;
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-bottom: none;
      color: #999; /* Faint grey when inactive */
      /* transition: color 0.3s ease; /* Smooth transition for color change - removed */
    }

    /* New rule for filter group headers when filters are generally active */
    body.filters-active .filter-group-header {
        color: #000; /* Black when main filter toggle is on */
    }


    .filter-group-content {
      max-height: 0;
      overflow: hidden;
      transition: max-height 0.3s ease-out;
      padding: 0 20px;
      background-color: #e6e6e6;
    }
    .filter-group.active .filter-group-content {
      max-height: 600px; /* Keep this to allow content to expand, actual height is content-driven */
      padding-bottom: 10px; /* Adjusted padding */
    }
    .filter-title {
      font-size: 14px; /* Made smaller */
      font-weight: 500;
      margin-top: 10px; /* Reduced space */
      margin-bottom: 5px; /* Reduced space */
      color: #666; /* Closer to background gray */
    }
    .filter-group-content .filter-title:first-of-type {
        margin-top: 0;
    }
    .filter-pills {
      display: flex;
      flex-wrap: nowrap; /* Ensures horizontal scrolling */
      gap: 8px;
      overflow-x: auto; /* Enables horizontal scrolling */
      padding-bottom: 8px;
      -webkit-overflow-scrolling: touch; /* Smoother scrolling on iOS */
    }
    .filter-pills::-webkit-scrollbar {
        display: none; /* Hide scrollbar for Webkit browsers */
    }
    .filter-pills {
        -ms-overflow-style: none; /* Hide scrollbar for IE/Edge */
        scrollbar-width: none; /* Hide scrollbar for Firefox */
    }
    .pill {
      flex-shrink: 0;
      padding: 6px 12px;
      border-radius: 16px;
      border: 1px solid #999;
      background: transparent;
      cursor: pointer;
      font-size: 13px;
      transition: all 0.2s ease;
      color: #000;
    }
    .pill:hover {
      background: rgba(0, 0, 0, 0.1);
    }
    .pill.active {
      background: #000; /* Changed from #5f56ff to #000 */
      color: white;
      border-color: #000; /* Changed from #5f56ff to #000 */
    }
    .year-range-filter {
      display: flex;
      gap: 10px;
      margin-top: 8px;
      align-items: center; /* Vertically align items */
    }
    .year-range-filter input[type="number"] {
      padding: 6px 10px;
      border: 1px solid #999;
      background: transparent;
      border-radius: 10px;
      font-size: 13px;
      width: 80px;
      color: #000;
      
    }
    .table-view-container, .feed-view-container {
      margin: 0;
      flex-grow: 1;
      overflow-y: auto;
      /* overflow-x: auto; This was removed to prevent horizontal scroll */
      position: relative;
      background: #f2f2f2;
     padding-bottom: 50px;
    }
    table {
      width: 100%;
      /* min-width: 1200px; This was removed as we are adjusting font size instead of scrolling */
      border-collapse: collapse;
      background: #fff;
      table-layout: fixed;
    }
    th {
      text-align: left;
      padding: 4px 12px;
      border-bottom: 1px solid #D3D3D3;
      border-top: 1px solid #D3D3D3;
      font-family: 'Geist Mono', monospace;
      vertical-align: top;
      font-size: 13px; /* Base font size */
      font-weight: 500;
      word-wrap: break-word; /* Allows text to break to the next line */
    }
    td {
      text-align: left;
      padding: 4px 12px;
      border-bottom: 1px solid #D3D3D3;
      border-top: 1px solid #D3D3D3;
      font-family: 'Geist Mono', monospace;
      vertical-align: top;
      font-size: 13px; /* Base font size */
      font-weight: 400;
      word-wrap: break-word; /* Allows text to break to the next line */
    }
    /* Specific styles for columns 1-8 */
    th:nth-child(-n+7),
    td:nth-child(-n+7) {
      border-bottom: 1px solid #000;
    }
    th:nth-child(-n+7) {
      border-top: none; /* No top border for header cells in columns 1-8 */
    }
    td:nth-child(-n+7) {
      border-top: 1px solid #000;
    }

    /* Fixed width for specific columns */
    th:nth-child(1),
    td:nth-child(1) {
      width: 6%; /* Date */
      min-width: 6%;
      max-width: 6%;
    }
    th:nth-child(2),
    td:nth-child(2) {
      width: 13%; /* Title */
      min-width: 13%;
      max-width: 13%;
    }
    th:nth-child(3),
    td:nth-child(3) {
      width: 4%; /* Link */
      min-width: 4%;
      max-width: 4%;
    }
    th:nth-child(4),
    td:nth-child(4) {
      width: 9%; /* Outlet */
      min-width: 9%;
      max-width: 9%;
    }
    th:nth-child(5),
    td:nth-child(5) {
      width: 7%; /* Country */
      min-width: 7%;
      max-width: 7%;
    }
    th:nth-child(6),
    td:nth-child(6) {
      width: 10%; /* Context */
      min-width: 10%;
      max-width: 10%;
    }
    th:nth-child(7),
    td:nth-child(7) {
      width: 8%; /* Category */
      min-width: 8%;
      max-width: 8%;
    }
    th:nth-child(8),
    td:nth-child(8) {
      width: 3.5%; /* Data use */
      min-width: 3.5%;
      max-width: 3.5%;
    }
    th:nth-child(9),
    td:nth-child(9) {
      width: 6.5%; /* Provider */
      min-width: 6.5%;
      max-width: 6.5%;
    }
    th:nth-child(10),
    td:nth-child(10) {
      width: 6%; /* Platform */
      min-width: 6%;
      max-width: 6%;
    }
    th:nth-child(11),
    td:nth-child(11) {
      width: 7%; /* Representation */
      min-width: 7%;
      max-width: 7%;
    }
    th:nth-child(12),
    td:nth-child(12) {
      width: 4%; /* Resolution */
      min-width: 4%;
      max-width: 4%;
    }
    th:nth-child(13),
    td:nth-child(13) {
      width: 4%; /* Viz */
      min-width: 4%;
      max-width: 4%;
    }

    thead {
      position: sticky;
      top: 0;
      z-index: 10;
    }
    th {
      background: #000;
      color: white;
      border-top: none;
      border-bottom: 1px solid #000;
    }
    /* Explicitly left align headers of columns 8-14 and make them black */
    th:nth-child(n+8) {
      background-color: #000;
      text-align: left;
    }
    /* Left align content of columns 8-14 */
    td:nth-child(n+8) {
      text-align: left;
    }
    a {
      color: #997b21;
      text-decoration: none;
      border-bottom: none;
    }
    .month {
      color: gray;
    }
    .provider-item {
      display: block;
      margin-bottom: 4px;
      padding-bottom: 4px;
    }
    .provider-item:not(:last-child) {
      border-bottom: 1px solid #ddd;
    }
    .provider-resolution-group {
      font-size: 12px;
      line-height: 1.4;
    }

    /* Toggle Switches Container */
    .toggles-container {
      background: #f2f2f2;
      padding: 0 40px 10px 20px;
      display: flex;
      justify-content: flex-start;
      align-items: center;
      gap: 20px;
      margin-top: 10px;
    }

    .filter-toggle-group, .feed-toggle-group {
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .filter-toggle-label, .feed-toggle-label {
      font-size: 18px;
      font-weight: 500;
      color: #000000;
    }

    /* The switch - the box around the slider */
    .switch {
      position: relative;
      display: inline-block;
      width: 40px;
      height: 24px;
    }

    /* Hide default HTML checkbox */
    .switch input {
      opacity: 0;
      width: 0;
      height: 0;
    }

    /* The slider */
    .slider {
      position: absolute;
      cursor: pointer;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: #ccc;
      -webkit-transition: .4s;
      transition: .4s;
      border-radius: 24px;
    }

    .slider:before {
      position: absolute;
      content: "";
      height: 18px;
      width: 18px;
      left: 3px;
      bottom: 3px;
      background-color: white;
      -webkit-transition: .4s;
      transition: .4s;
      border-radius: 50%;
    }

    input:checked + .slider {
      background-color: #000;
    }

    input:focus + .slider {
      box-shadow: 0 0 1px #000;
    }

    input:checked + .slider:before {
      -webkit-transform: translateX(16px);
      -ms-transform: translateX(16px);
      transform: translateX(16px);
    }

    /* Overlay styles */
    .overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: transparent;
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 1000;
      font-size: 10em;
      font-weight: bold;
      color: #333;
      text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
      pointer-events: none;
      opacity: 1;
      transition: opacity 0.5s ease-out;
    }
    .overlay.hidden {
      opacity: 0;
      visibility: hidden;
    }

    /* Specific styles for data detail columns */
    .data-detail-cell {
      font-size: 13px; /* Base font size */
      padding: 4px 8px;
      background-color: rgb(221, 255, 109);
      padding-left: 12px;
    }

    /* Light grey top border for the first row of each article, across all columns */
    tr.article-start td {
      border-top: 1px solid #D3D3D3;
    }

    /* FIX: Override the light grey top border for data-detail-cells when it's the article start */
    tr.article-start .data-detail-cell {
        border-top: 1px solid #000;
    }

    /* Black bottom border for the last data point row of an article, across all columns */
    tr.last-cdp-of-article td {
      border-bottom: 1px solid #000;
    }
    /* Ensure data-detail-cell gets a black bottom border if it's the last data point of an article */
    tr.last-cdp-of-article .data-detail-cell {
        border-bottom: 1px solid #000;
    }

    /* Override for data-detail-cells that are NOT the last cdp of an article */
    /* This ensures they maintain light grey bottom borders if they are intermediate rows */
    tr:not(.last-cdp-of-article) .data-detail-cell {
        border-bottom: 1px solid rgba(0, 0, 0, 0.2);
    }

    /* Show/Hide View Containers */
    .table-view-container.hidden,
    .feed-view-container.hidden {
      display: none;
    }

    /* Feed View Specific Styles (similar to quote-only view) */
    .feed-view-container {
      padding: 20px 40px;
      background: #fff;
      overflow-y: auto;
      border-top: 1px solid #000;
    }

    .feed-view-container .article-item {
      font-size: 80px; /* Increased font size, similar to quotes */
      font-weight: 500;
      margin-bottom: 20px;
      line-height: 1.2;
      color: #000000;
      border-bottom: 1px solid #eee; /* Light separator */
      padding-bottom: 15px;
      cursor: pointer; /* Clickable */
      display: flex; /* Changed to flex to align details to bottom */
      flex-direction: column; /* Stack title and details vertically */
      justify-content: flex-start; /* Align content to the start (top) */
      text-decoration: none; /* Remove underline from link */
      text-transform: uppercase; /* All caps */
      white-space: normal; /* Allow text to wrap */
      overflow: visible; /* Allow content to be visible */
      text-overflow: clip; /* Remove ellipsis */
      font-family: 'Geist', sans-serif; /* Use Geist font */
      text-rendering: geometricPrecision; /* Added for geometric precision */
      word-spacing: normal; /* Default value */
      letter-spacing: normal; /* Default value */
    }

    .feed-view-container .article-item:last-child {
      border-bottom: none; /* No border for the last item */
      margin-bottom: 0;
    }
    .feed-view-container .article-item a {
        color: inherit; /* Inherit color from parent div */
        text-decoration: none; /* No underline */
    }

    .article-details {
      font-size: 14px; /* Details font size */
      font-weight: 350; /* Not bold */
      color: #969696; /* A bit lighter color for details */
      margin-top: 5px; /* Reduced space above details */
      text-align: left; /* Aligned to the left */
      text-transform: none; /* Details should not be all caps */
      padding-left: 10px; /* Small indent */
      font-family: 'Geist Mono', monospace; /* Use Geist Mono for details */
    }

    /* Spacing for article count numbers */
    .article-count-number {
      margin-left: 30px; /* Default for desktop */
    }

    sup .article-count-number {
      margin-left: 1px; /* Default for desktop superscript */
    }

    /* New CSS for Material Symbols */
    .material-symbols-outlined {
      font-variation-settings:
      'FILL' 0,
      'wght' 400,
      'GRAD' 0,
      'opsz' 24
    }
      .tba-text {
    color: #B2CC70; /* Or any color you prefer, e.g., orange, red, etc. */
  }

    /* --- Responsive Design --- */

    /* New media query for screens smaller than or equal to 1600px */
    @media (max-width: 1600px) {
      th, td, .data-detail-cell {
        font-size: 11.5px; /* 11pt equivalent for smaller screens */
      }
    }

    /* For screens smaller than 768px (tablets and smaller) */
    @media (max-width: 1268px) {
      .nav {
        padding: 15px 20px 15px 15px;
        font-size: 18px;
        gap: 5px;
      }
      .nav a {
        font-size: 18px;
        padding: 3px 8px;
      }
    
      .stats {
        font-size: 60px;
        padding: 15px 20px 5px 20px;
      }
      .toggles-container {
        padding: 0 20px 10px 15px;
        gap: 15px;
      }
      .filter-toggle-label, .feed-toggle-label {
        font-size: 16px;
      }
      .filter-group-header {
        font-size: 16px;
        padding: 6px 15px; /* Adjusted padding */
      }
      .filter-group-content {
        padding: 0 15px;
      }
      .filter-title {
        font-size: 12px;
      }
      .pill {
        font-size: 12px;
        padding: 5px 10px;
      }
      .year-range-filter input[type="number"] {
        font-size: 12px;
        width: 60px;
      }

      /* HIDE ALL COLUMNS FROM THE 4TH ONWARDS FOR SMALL VIEWPORT */
      th:nth-child(n+5),
      td:nth-child(n+5) {
        display: none;
      }

      /* Adjust widths for the first three visible columns to fill the viewport */
      th:nth-child(1),
      td:nth-child(1) {
        width: 20%; /* Date */
        min-width: 20%;
        max-width: 20%;
      }
      th:nth-child(2),
      td:nth-child(2) {
        width: 40%; /* Title */
        min-width: 40%;
        max-width: 40%;
      }
      th:nth-child(3),
      td:nth-child(3) {
        width: 15%; /* Link */
        min-width: 15%;
        max-width: 15%;
      }
       th:nth-child(4),
      td:nth-child(4) {
        width: 25%; /* Link */
        min-width: 25%;
        max-width: 25%;
      }

      th, td {
        font-size: 12px; /* Adjusted to 10px for even smaller screens */
        padding: 6px 8px;
      }
      .overlay {
        font-size: 7em;
      }
      .data-detail-cell {
        font-size: 0px; /* Adjusted for consistency */
        padding: 0px 0px;
      }
      .feed-view-container {
        padding: 15px 20px;
      }
      .feed-view-container .article-item {
        font-size: 40px; /* Half of 80px -> 40px */
        margin-bottom: 15px;
        padding-bottom: 10px;
      }
      .article-details {
        font-size: 12px; /* Smaller details font size */
        margin-top: 8px;
        padding-left: 8px;
      }
    }

   /* For screens smaller than 480px (mobile phones) */
    @media (max-width: 480px) {
      .nav {
        padding: 5px 20px 5px 5px;
        font-size: 18px;
        gap: 5px;
      }
      .nav a {
        font-size: 17px;
        padding: 3px 8px;
      }
      .update-date {
        font-size: 12px;
        padding: 10px 0 0 13px;
      }
      .stats {
        font-size: 42px;
        padding-top: 17px;
        padding-left: 1.5px;
        padding-bottom: 10px;
        padding-left: 10px;
      }
      .toggles-container {
        padding: 0 20px 10px 12px;
        gap: 15px;
      }
      .filter-toggle-label, .feed-toggle-label {
        font-size: 16px;
      }
      .filter-group-header {
        font-size: 16px;
        padding: 6px 15px; /* Adjusted padding */
      }
      .filter-group-content {
        padding: 0 15px;
      }
      .filter-title {
        font-size: 12px;
      }
      .pill {
        font-size: 12px;
        padding: 5px 10px;
      }
      .year-range-filter input[type="number"] {
        font-size: 12px;
        width: 60px;
        padding: 5px 15px;
      }

      /* HIDE ALL COLUMNS FROM THE 4TH ONWARDS FOR SMALL VIEWPORT */
      th:nth-child(n+4),
      td:nth-child(n+4) {
        display: none;
      }

      /* Adjust widths for the first three visible columns to fill the viewport */
      th:nth-child(1),
      td:nth-child(1) {
        width: 24%; /* Date */
        min-width: 24%;
        max-width: 24%;
      }
      th:nth-child(2),
      td:nth-child(2) {
        width: 61%; /* Title */
        min-width: 61%;
        max-width: 61%;
      }
      th:nth-child(3),
      td:nth-child(3) {
        width: 15%; /* Link */
        min-width: 15%;
        max-width: 15%;
      }

      th, td {
        font-size: 12px; /* Adjusted to 10px for even smaller screens */
        line-height: 1.3;
        padding: 6px 8px;
      }
      .overlay {
        font-size: 7em;
      }
      .data-detail-cell {
        font-size: 0px; /* Adjusted for consistency */
        padding: 0px 0px;
      }
      .feed-view-container {
        padding: 10px 15px;
      }
      .feed-view-container .article-item {
        font-size: 23px; /* Adjusted for responsive */
        letter-spacing: -0.025em;
        line-height: 1.3;
        font-weight: medium;
        margin-bottom: 10px;
        padding-bottom: 8px;
      }
      .article-details {
        font-size: 11px; /* Even smaller details font size */
        margin-top: 5px;
        padding-left: 1px;
      }

      /* Mobile-specific spacing for article count numbers */
      .article-count-number {
        margin-left: 8px;
      }

      sup .article-count-number {
        margin-left: 0px;
        font-size: 75%; /* Adjust as needed, e.g., 60% for slightly larger */
        position: relative;
        top: -0.2em;
      }
    }
  </style>
</head>
<body>
  <div id="fixed-header-area">
    <div class="nav">
      <a href="index.html" class="active">Index</a>
      <a href="literacy.html">Literacy</a>
      <a href="about.html">About</a>
    </div>
      <div class="update-date">
        updated: 2025-09-17
    </div>
    <div class="stats">
      <span id="loadingStatus">Loading data...</span>
      <div id="statsDisplay" style="display: none;"></div>
    </div>

    <div class="toggles-container">
        <div class="filter-toggle-group">
            <span class="filter-toggle-label"><span class="material-symbols-outlined">filter_list</span></span>
            <label class="switch">
                <input type="checkbox" id="filterToggle">
                <span class="slider"></span>
            </label>
        </div>
        <div class="feed-toggle-group">
            <span class="feed-toggle-label">FEED</span>
            <label class="switch">
                <input type="checkbox" id="feedToggle">
                <span class="slider"></span>
            </label>
        </div>
    </div>

    <div class="filter-container">
      <div class="filter-group" id="narrative-group">
          <div class="filter-group-header">NARRATIVE</div>
          <div class="filter-group-content">
              <div class="filter-title">Publication Year Range:</div>
              <div class="year-range-filter">
                  <button class="pill active" data-type="publicationYear" data-value="all">All</button>
                  <input type="number" id="fromYearInput" placeholder="Year">
                  <input type="number" id="toYearInput" placeholder="Year">
              </div>

              <div class="filter-title">Region:</div>
              <div class="filter-pills" id="region-filter-pills">
                  <button class="pill active" data-type="region" data-value="all">All</button>
                  <button class="pill" data-type="region" data-value="Africa">Africa</button>
                  <button class="pill" data-type="region" data-value="Asia">Asia</button>
                  <button class="pill" data-type="region" data-value="Europe">Europe</button>
                  <button class="pill" data-type="region" data-value="North America">North America</button>
                  <button class="pill" data-type="region" data-value="South America">South America</button>
                  <button class="pill" data-type="region" data-value="Oceania">Oceania</button>
                  
              </div>

              <div id="focus-filter-section" style="display: none;">
                  <div class="filter-title">Country/Area:</div>
                  <div class="filter-pills" id="focus-filter-pills">
                      <button class="pill active" data-type="focus" data-value="all">All</button>
                      </div>
              </div>
          </div>
      </div>

      <div class="filter-group" id="data-group">
          <div class="filter-group-header">DATA</div>
          <div class="filter-group-content">
              <div class="filter-title">Resolution:</div>
              <div class="filter-pills" id="meters-filter-pills">
                  <button class="pill active" data-type="resolutionCategory" data-value="all">All</button>
                  <button class="pill" data-type="resolutionCategory" data-value="<1m">&lt;1m</button>
                  <button class="pill" data-type="resolutionCategory" data-value="1-10m">1-10m</button>
                  <button class="pill" data-type="resolutionCategory" data-value=">10m">&gt;10m</button>
              </div>

              <div class="filter-title">Visualization:</div>
              <div class="filter-pills" id="viz-filter-pills">
                  <button class="pill active" data-type="viz" data-value="all">All</button>
              </div>

              <div class="filter-title">Data Use Year:</div>
              <div class="filter-pills" id="years-filter-pills">
                  <button class="pill active" data-type="years" data-value="all">All</button>
              </div>

              <div class="filter-title">Representation:</div>
              <div class="filter-pills" id="representation-filter-pills">
                  <button class="pill active" data-type="representation" data-value="all">All</button>
              </div>
          </div>
      </div>

      <div class="filter-group" id="source-group">
          <div class="filter-group-header">SOURCE</div>
          <div class="filter-group-content">
              <div class="filter-title">Outlet:</div>
              <div class="filter-pills" id="outlet-filter-pills">
                  <button class="pill active" data-type="outlet" data-value="all">All</button>
                  <button class="pill" data-type="outlet" data-value="The New York Times">The New York Times</button>
                  <button class="pill" data-type="outlet" data-value="Washington Post">Washington Post</button>
                  <button class="pill" data-type="outlet" data-value="The Guardian">The Guardian</button>
                  <button class="pill" data-type="outlet" data-value="BBC">BBC</button>
                  <button class="pill" data-type="outlet" data-value="CNN">CNN</button>
                  <button class="pill" data-type="outlet" data-value="Reuters">Reuters</button>
                  <button class="pill" data-type="outlet" data-value="Sky News">Sky News</button>
              </div>

              <div class="filter-title">Provider:</div>
              <div class="filter-pills" id="provider-filter-pills">
                  <button class="pill active" data-type="provider" data-value="all">All</button>
                  <button class="pill" data-type="provider" data-value="Planet Labs">Planet Labs</button>
                  <button class="pill" data-type="provider" data-value="Maxar">Maxar</button>
                  <button class="pill" data-type="provider" data-value="ESA">ESA</button>
                  <button class="pill" data-type="provider" data-value="NASA">NASA</button>
                  <button class="pill" data-type="provider" data-value="USGS">USGS</button>
                  <button class="pill" data-type="provider" data-value="Airbus">Airbus</button>
              </div>
          </div>
      </div>
    </div>
  </div>

  <div id="tableViewContainer" class="table-view-container">
    <table>
      <thead>
        <tr>
          <th>Date</th>
          <th>Title</th>
          <th>Link</th>
          <th>Outlet</th>
          <th>Country</th>
          <th>Context</th>
          <th>Category</th>
          <th>Use</th>
          <th>Provider</th>
          <th>Platform</th>
          <th>Sensor</th>
          <th>Res</th>
          <th>Viz</th>
        </tr>
      </thead>
      <tbody>
      </tbody>
    </table>
  </div>
  
  <div id="feedViewContainer" class="feed-view-container hidden">
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
  <script>
    let allData = [];
    let selectedRegion = 'all';
    let selectedFocuses = ['all'];
    let selectedYears = ['all'];
    let filtersActive = false;
    // MODIFICATION 1: Initialize currentView based on URL hash
    let currentView = (window.location.hash.substring(1) === 'feed') ? 'feed' : 'table';

    const countryRegions = { 
        'Afghanistan': 'Asia', 'Albania': 'Europe', 'Algeria': 'Africa', 'Andorra': 'Europe', 'Angola': 'Africa', 
        'Antigua and Barbuda': 'North America', 'Argentina': 'South America', 'Armenia': 'Asia', 'Australia': 'Oceania', 
        'Austria': 'Europe', 'Azerbaijan': 'Asia', 'Bahamas': 'North America', 'Bahrain': 'Asia', 'Bangladesh': 'Asia', 
        'Barbados': 'North America', 'Belarus': 'Europe', 'Belgium': 'Europe', 'Belize': 'North America', 'Benin': 'Africa', 
        'Bhutan': 'Asia', 'Bolivia, Plurinational State of': 'South America', 'Bosnia and Herzegovina': 'Europe', 'Botswana': 'Africa', 
        'Brazil': 'South America', 'Brunei Darussalam': 'Asia', 'Bulgaria': 'Europe', 'Burkina Faso': 'Africa', 'Burundi': 'Africa', 
        'Cabo Verde': 'Africa', 'Cambodia': 'Asia', 'Cameroon': 'Africa', 'Canada': 'North America', 'Central African Republic': 'Africa', 
        'Chad': 'Africa', 'Chile': 'South America', 'China': 'Asia', 'Colombia': 'South America', 'Comoros': 'Africa', 'Congo': 'Africa', 
        'Congo, The Democratic Republic of the': 'Africa', 'Costa Rica': 'North America', 'Croatia': 'Europe', 'Cuba': 'North America', 
        'Cyprus': 'Asia', 'Czechia': 'Europe', 'Côte d\'Ivoire': 'Africa', 'Denmark': 'Europe', 'Djibouti': 'Africa', 
        'Dominica': 'North America', 'Dominican Republic': 'North America', 'Ecuador': 'South America', 'Egypt': 'Africa', 
        'El Salvador': 'North America', 'Equatorial Guinea': 'Africa', 'Eritrea': 'Africa', 'Estonia': 'Europe', 'Eswatini': 'Africa', 
        'Ethiopia': 'Africa', 'Fiji': 'Oceania', 'Finland': 'Europe', 'France': 'Europe', 'Gabon': 'Africa', 'Gambia': 'Africa', 
        'Gaza Strip': 'Asia', 'Georgia': 'Asia', 'Germany': 'Europe', 'Ghana': 'Africa', 'Greece': 'Europe', 'Grenada': 'North America', 
        'Guatemala': 'North America', 'Guinea': 'Africa', 'Guinea-Bissau': 'Africa', 'Guyana': 'South America', 'Haiti': 'North America', 
        'Honduras': 'North America', 'Hungary': 'Europe', 'Iceland': 'Europe', 'India': 'Asia', 'Indonesia': 'Asia', 'Iran': 'Asia', 
        'Iraq': 'Asia', 'Ireland': 'Europe', 'Israel': 'Asia', 'Italy': 'Europe', 'Jamaica': 'North America', 'Japan': 'Asia', 
        'Jordan': 'Asia', 'Kazakhstan': 'Asia', 'Kenya': 'Africa', 'Kiribati': 'Oceania', 'Korea, Democratic People\'s Republic of': 'Asia', 
        'Korea, Republic of': 'Asia', 'Kuwait': 'Asia', 'Kyrgyzstan': 'Asia', 'Lao People\'s Democratic Republic': 'Asia', 
        'Latvia': 'Europe', 'Lebanon': 'Asia', 'Lesotho': 'Africa', 'Liberia': 'Africa', 'Libya': 'Africa', 
        'Liechtenstein': 'Europe', 'Lithuania': 'Europe', 'Luxembourg': 'Europe', 'Madagascar': 'Africa', 'Malawi': 'Africa', 
        'Malaysia': 'Asia', 'Maldives': 'Asia', 'Mali': 'Africa', 'Malta': 'Europe', 'Marshall Islands': 'Oceania', 'Mauritania': 'Africa', 
        'Mauritius': 'Africa', 'Mexico': 'North America', 'Micronesia, Federated States of': 'Oceania', 'Moldova, Republic of': 'Europe', 
        'Monaco': 'Europe', 'Mongolia': 'Asia', 'Montenegro': 'Europe', 'Morocco': 'Africa', 'Mozambique': 'Africa', 'Myanmar': 'Asia', 
        'Namibia': 'Africa', 'Nauru': 'Oceania', 'Nepal': 'Asia', 'Netherlands': 'Europe', 'New Zealand': 'Oceania', 'Nicaragua': 'North America', 
        'Niger': 'Africa', 'Nigeria': 'Africa', 'North Macedonia': 'Europe', 'Norway': 'Europe', 'Oman': 'Asia', 'Pakistan': 'Asia', 
        'Palau': 'Oceania', 'Palestine': 'Asia', 'Panama': 'North America', 'Papua New Guinea': 'Oceania', 'Paraguay': 'South America', 
        'Peru': 'South America', 'Philippines': 'Asia', 'Poland': 'Europe', 'Portugal': 'Europe', 'Qatar': 'Asia', 'Romania': 'Europe', 
        'Russian Federation': 'Europe', 'Rwanda': 'Africa', 'Saint Kitts and Nevis': 'North America', 'Saint Lucia': 'North America', 
        'Saint Vincent and the Grenadines': 'North America', 'Samoa': 'Oceania', 'San Marino': 'Europe', 'Sao Tome and Principe': 'Africa', 
        'Saudi Arabia': 'Asia', 'Senegal': 'Africa', 'Serbia': 'Europe', 'Seychelles': 'Africa', 'Sierra Leone': 'Africa', 'Singapore': 'Asia', 
        'Slovakia': 'Europe', 'Slovenia': 'Europe', 'Solomon Islands': 'Oceania', 'Somalia': 'Africa', 'South Africa': 'Africa', 
        'South Sudan': 'Africa', 'Spain': 'Europe', 'Sri Lanka': 'Asia', 'Sudan': 'Africa', 'Suriname': 'South America', 
        'Sweden': 'Europe', 'Switzerland': 'Europe', 'Syrian Arab Republic': 'Asia', 'Taiwan': 'Asia', 'Tajikistan': 'Asia', 
        'Tanzania, United Republic of': 'Africa', 'Thailand': 'Asia', 'Timor-Leste': 'Asia', 'Togo': 'Africa', 'Tonga': 'Oceania', 
        'Trinidad and Tobago': 'North America', 'Tunisia': 'Africa', 'Turkey': 'Asia', 'Turkmenistan': 'Asia', 'Tuvalu': 'Oceania', 
        'Uganda': 'Africa', 'Ukraine': 'Europe', 'United Arab Emirates': 'Asia', 'United Kingdom': 'Europe', 'United States of America': 'North America', 
        'Uruguay': 'South America', 'Uzbekistan': 'Asia', 'Vanuatu': 'Oceania', 'Venezuela': 'South America', 'Viet Nam': 'Asia', 
        'Yemen': 'Asia', 'Zambia': 'Africa', 'Zimbabwe': 'Africa'
    };

    // MODIFICATION 2: Add new element selectors
    const filterToggle = document.getElementById('filterToggle');
    const filterContainer = document.querySelector('.filter-container');
    const statsDisplay = document.getElementById('statsDisplay');
    const loadingStatus = document.getElementById('loadingStatus');
    const body = document.body;

    // New elements for view toggle
    const tableViewContainer = document.getElementById('tableViewContainer');
    const feedViewContainer = document.getElementById('feedViewContainer');
    const feedToggle = document.getElementById('feedToggle');
    
    // Input elements for year range
    const fromYearInput = document.getElementById('fromYearInput');
    const toYearInput = document.getElementById('toYearInput');
    
    // Filter groups
    const narrativeGroup = document.getElementById('narrative-group');
    const dataGroup = document.getElementById('data-group');
    const sourceGroup = document.getElementById('source-group');

    // Filter pill containers
    const regionFilterPills = document.getElementById('region-filter-pills');
    const focusFilterPills = document.getElementById('focus-filter-pills');
    const yearsFilterPills = document.getElementById('years-filter-pills');
    const metersFilterPills = document.getElementById('meters-filter-pills');
    const vizFilterPills = document.getElementById('viz-filter-pills');
    const representationFilterPills = document.getElementById('representation-filter-pills');
    const outletFilterPills = document.getElementById('outlet-filter-pills');
    const providerFilterPills = document.getElementById('provider-filter-pills');

    // Utility functions
    function getUniqueValues(data, key) {
        return [...new Set(data.map(d => d[key]).filter(v => v && v.trim() !== '' && v !== 'N/A'))].sort();
    }

    function getActivePills(containerId) {
        return Array.from(document.getElementById(containerId).querySelectorAll('.pill.active'))
                    .map(pill => pill.getAttribute('data-value'));
    }

    function formatDate(dateString) {
      if (!dateString) return 'N/A';
      try {
        // Handle YYYY-MM-DD (standardized format)
        const parts = dateString.split('-');
        if (parts.length === 3) {
            const date = new Date(dateString + 'T00:00:00Z');
            const year = date.getUTCFullYear();
            const month = date.toLocaleString('en-US', { month: 'short', timeZone: 'UTC' });
            return `${month} ${year}`;
        }
        return dateString; // Return original if format is unexpected
      } catch (e) {
        return dateString; // Return original if parsing fails
      }
    }

    function formatMultipleValues(value) {
        if (!value || value.trim() === '') return 'N/A';
        return value.split(';').map(v => v.trim()).join('<br>');
    }
    
    // NEW FUNCTION: Manages view state and URL hash
    function updateView(newView) {
        if (currentView === newView) return;

        currentView = newView;
        
        // Update hash in URL history
        if (currentView === 'feed') {
            window.location.hash = 'feed';
            feedToggle.checked = true;
            tableViewContainer.classList.add('hidden');
            feedViewContainer.classList.remove('hidden');
        } else {
            // Use replaceState to clear the hash without creating history entry
            history.replaceState(null, null, window.location.pathname + window.location.search); 
            feedToggle.checked = false;
            tableViewContainer.classList.remove('hidden');
            feedViewContainer.classList.add('hidden');
        }
    }

    // NEW FUNCTION: Handle hash change events (e.g., back button)
    function handleHashChange() {
        const hash = window.location.hash.substring(1);
        const newView = (hash === 'feed') ? 'feed' : 'table';
        if (currentView !== newView) {
            updateView(newView);
            applyFilters(); // Re-render content for the new view
        }
    }

    // NEW FUNCTION: Render the feed view
    function renderFeedView(filteredData) {
        // Group data by Article UID to get unique articles
        const articlesMap = {};
        filteredData.forEach(d => {
            const articleUid = d['Article UID'];
            if (!articlesMap[articleUid]) {
                articlesMap[articleUid] = {
                    title: d['Article Title'],
                    link: d['Article Link'],
                    outlet: d['Outlet'],
                    publicationDate: d['Date'],
                    dataPoints: []
                };
            }
            articlesMap[articleUid].dataPoints.push(d);
        });

        let html = '';
        Object.values(articlesMap).forEach(article => {
            // Format date to Month Year
            const date = new Date(article.publicationDate);
            const monthYear = date.toLocaleString('en-US', { month: 'long', year: 'numeric' });
            
            html += `
                <div class="article-item" onclick="window.open('${article.link}', '_blank');">
                    <a href="${article.link}" target="_blank" style="color: inherit; text-decoration: none;">
                        ${article.title}
                    </a>
                    <div class="article-details">
                        ${article.outlet} | ${monthYear}
                    </div>
                </div>
            `;
        });
        
        feedViewContainer.innerHTML = html;
        updateFilterCount(filteredData); // Use filteredData to correctly calculate the article count
    }


    function renderTable(data) {
        const tableBody = document.querySelector('#tableViewContainer table tbody');
        tableBody.innerHTML = '';
        let lastArticleUid = null;

        data.forEach((d, index) => {
            const isNewArticle = d['Article UID'] !== lastArticleUid;
            const articleStartClass = isNewArticle ? 'article-start' : '';

            // Determine if this is the last data point of the current article
            const nextDataItem = data[index + 1];
            const isLastCdpOfArticle = !nextDataItem || nextDataItem['Article UID'] !== d['Article UID'];
            const lastCdpClass = isLastCdpOfArticle ? 'last-cdp-of-article' : '';

            // Column 1: Date (Article metadata)
            const dateCell = isNewArticle 
                ? `<td class="${articleStartClass} ${lastCdpClass}">${formatDate(d['Date'])}</td>`
                : `<td class="${articleStartClass} ${lastCdpClass}" style="border-top: 1px solid #D3D3D3;"></td>`;

            // Column 2: Title (Article metadata)
            const titleCell = isNewArticle
                ? `<td class="${articleStartClass} ${lastCdpClass}"><strong>${d['Article Title']}</strong></td>`
                : `<td class="${articleStartClass} ${lastCdpClass}" style="border-top: 1px solid #D3D3D3;"></td>`;

            // Column 3: Link (Article metadata)
            const linkCell = isNewArticle
                ? `<td class="${articleStartClass} ${lastCdpClass}"><a href="${d['Article Link']}" target="_blank">Link</a></td>`
                : `<td class="${articleStartClass} ${lastCdpClass}" style="border-top: 1px solid #D3D3D3;"></td>`;
            
            // Column 4: Outlet (Article metadata)
            const outletCell = isNewArticle
                ? `<td class="${articleStartClass} ${lastCdpClass}">${d['Outlet']}</td>`
                : `<td class="${articleStartClass} ${lastCdpClass}" style="border-top: 1px solid #D3D3D3;"></td>`;
            
            // Column 5: Country/Area (Article metadata)
            const countryCell = isNewArticle
                ? `<td class="${articleStartClass} ${lastCdpClass}">${d['Country/Area']}</td>`
                : `<td class="${articleStartClass} ${lastCdpClass}" style="border-top: 1px solid #D3D3D3;"></td>`;

            // Column 6: Context (Article metadata)
            const contextCell = isNewArticle
                ? `<td class="${articleStartClass} ${lastCdpClass}">${d['Context']}</td>`
                : `<td class="${articleStartClass} ${lastCdpClass}" style="border-top: 1px solid #D3D3D3;"></td>`;

            // Column 7: Category (Article metadata)
            const categoryCell = isNewArticle
                ? `<td class="${articleStartClass} ${lastCdpClass}">${d['Category']}</td>`
                : `<td class="${articleStartClass} ${lastCdpClass}" style="border-top: 1px solid #D3D3D3;"></td>`;

            // Data Use Year (Data point metadata - Col 8)
            // Use 'tba-text' class if year is 'TBA'
            const dataUseYear = d['Data Use Year'] ? d['Data Use Year'].toString() : 'N/A';
            const dataUseCellContent = dataUseYear === 'TBA' 
                ? `<span class="tba-text">TBA</span>` 
                : dataUseYear;
            const dataUseCell = `<td class="${articleStartClass} ${lastCdpClass} data-detail-cell">${dataUseCellContent}</td>`;

            // Column 9: Provider (Data point metadata)
            const providerCell = `<td class="${articleStartClass} ${lastCdpClass} data-detail-cell">${formatMultipleValues(d['Provider'])}</td>`;

            // Column 10: Platform (Data point metadata)
            const platformCell = `<td class="${articleStartClass} ${lastCdpClass} data-detail-cell">${formatMultipleValues(d['Platform'])}</td>`;

            // Column 11: Sensor (Data point metadata)
            const sensorCell = `<td class="${articleStartClass} ${lastCdpClass} data-detail-cell">${formatMultipleValues(d['Sensor'])}</td>`;
            
            // Column 12: Resolution (Data point metadata)
            const resolutionCell = `<td class="${articleStartClass} ${lastCdpClass} data-detail-cell">${formatMultipleValues(d['Resolution'])}</td>`;

            // Column 13: Viz (Data point metadata)
            const vizCell = `<td class="${articleStartClass} ${lastCdpClass} data-detail-cell">${formatMultipleValues(d['Visualization'])}</td>`;


            tableBody.innerHTML += `
                <tr class="${articleStartClass} ${lastCdpClass}">
                    ${dateCell}
                    ${titleCell}
                    ${linkCell}
                    ${outletCell}
                    ${countryCell}
                    ${contextCell}
                    ${categoryCell}
                    ${dataUseCell}
                    ${providerCell}
                    ${platformCell}
                    ${sensorCell}
                    ${resolutionCell}
                    ${vizCell}
                </tr>
            `;

            lastArticleUid = d['Article UID'];
        });

        // The filter count logic is now moved to applyFilters()
        updateFilterCount(data); 
    }

    // Filter Logic (remains mostly the same, ensuring it uses the correct data keys)
    function filterData(data) {
        // ... (Filter logic implementation is assumed to be correct based on previous requests)
        let filteredData = data;

        // 1. Narrative Filters
        const activeRegions = getActivePills('region-filter-pills');
        const activeFocuses = getActivePills('focus-filter-pills');
        const fromYear = fromYearInput.value ? parseInt(fromYearInput.value) : null;
        const toYear = toYearInput.value ? parseInt(toYearInput.value) : null;

        if (!activeRegions.includes('all')) {
            filteredData = filteredData.filter(d => activeRegions.includes(countryRegions[d['Country/Area']]));
        }

        if (!activeFocuses.includes('all')) {
            filteredData = filteredData.filter(d => activeFocuses.includes(d['Country/Area']));
        }
        
        if (fromYear || toYear) {
            filteredData = filteredData.filter(d => {
                const year = parseInt(d['Publication Year']);
                if (isNaN(year)) return false;
                return (!fromYear || year >= fromYear) && (!toYear || year <= toYear);
            });
        }


        // 2. Data Filters
        const activeResolutions = getActivePills('meters-filter-pills');
        const activeVizes = getActivePills('viz-filter-pills');
        const activeYears = getActivePills('years-filter-pills');
        const activeRepresentations = getActivePills('representation-filter-pills');

        const filterMultiValue = (data, key, activeValues) => {
            if (activeValues.includes('all')) return data;
            return data.filter(d => {
                // Handle semicolon-separated values in the data cell
                const valuesInCell = (d[key] || '').split(';').map(v => v.trim());
                // Check if any active filter value is present in the data cell
                return activeValues.some(activeVal => valuesInCell.includes(activeVal));
            });
        };

        filteredData = filterMultiValue(filteredData, 'Resolution Category', activeResolutions);
        filteredData = filterMultiValue(filteredData, 'Visualization', activeVizes);
        filteredData = filterMultiValue(filteredData, 'Data Use Year', activeYears);
        filteredData = filterMultiValue(filteredData, 'Representation', activeRepresentations);

        // 3. Source Filters
        const activeOutlets = getActivePills('outlet-filter-pills');
        const activeProviders = getActivePills('provider-filter-pills');

        filteredData = filterMultiValue(filteredData, 'Outlet', activeOutlets);
        filteredData = filterMultiValue(filteredData, 'Provider', activeProviders);

        return filteredData;
    }


    // MODIFICATION 3: updateFilterCount now takes filteredData to correctly count articles/data points
    function updateFilterCount(filteredData) {
      const totalDataPoints = allData.length;
      // Calculate total unique articles across all data
      const totalUniqueArticles = [...new Set(allData.map(d => d['Article UID']))].length;

      const statsDisplay = document.getElementById('statsDisplay');
      if (statsDisplay) {
        // Determine if any filters are actively narrowing down the data
        const hasActiveFilters = document.querySelectorAll('.filter-pills .pill.active:not([data-value=\"all\"])').length > 0 ||
                                 document.getElementById('fromYearInput').value !== '' ||
                                 document.getElementById('toYearInput').value !== '';

        const numberSpanClass = 'article-count-number';
        
        if (currentView === 'table') {
            const filteredCount = filteredData.length;
            const countLabel = 'Data Points'; // Label for table view
            if (hasActiveFilters && filtersActive) {
                statsDisplay.innerHTML = `${countLabel}:<span class="${numberSpanClass}">${filteredCount}</span><sup style="font-size: 0.5em; vertical-align: super; color: lightgrey;">/<span class="${numberSpanClass}">${totalDataPoints}</span></sup>`;
            } else {
                statsDisplay.innerHTML = `${countLabel}:<span class="${numberSpanClass}">${totalDataPoints}</span>`;
            }
        } else if (currentView === 'feed') {
            // Calculate unique articles in the filtered set
            const filteredUniqueArticles = [...new Set(filteredData.map(d => d['Article UID']))].length;
            const countLabel = 'Articles'; // Label for feed view
             if (hasActiveFilters && filtersActive) {
                statsDisplay.innerHTML = `${countLabel}:<span class="${numberSpanClass}">${filteredUniqueArticles}</span><sup style="font-size: 0.5em; vertical-align: super; color: lightgrey;">/<span class="${numberSpanClass}">${totalUniqueArticles}</span></sup>`;
            } else {
                statsDisplay.innerHTML = `${countLabel}:<span class="${numberSpanClass}">${totalUniqueArticles}</span>`;
            }
        }
      }
    }

    // MODIFICATION 4: applyFilters now routes to the correct render function
    function applyFilters() {
        if (!allData || allData.length === 0) return;

        const filteredData = filterData(allData);

        if (currentView === 'table') {
            renderTable(filteredData);
        } else if (currentView === 'feed') {
            renderFeedView(filteredData); // Call the new feed rendering function
        }
    }

    // Filter event handlers
    function handlePillClick(event) {
        const pill = event.target;
        const type = pill.getAttribute('data-type');
        const value = pill.getAttribute('data-value');
        const parent = pill.parentElement;

        if (value === 'all') {
            // If 'All' is clicked, deactivate all others, activate 'All'
            parent.querySelectorAll('.pill').forEach(p => p.classList.remove('active'));
            pill.classList.add('active');
        } else {
            // Toggle the clicked pill
            pill.classList.toggle('active');

            // Deactivate 'All' pill if any other pill is active
            const allPill = parent.querySelector('.pill[data-value="all"]');
            if (allPill) {
                if (parent.querySelectorAll('.pill.active:not([data-value="all"])').length > 0) {
                    allPill.classList.remove('active');
                } else {
                    // If no other pill is active, reactivate 'All'
                    allPill.classList.add('active');
                }
            }
        }
        applyFilters();
    }

    function handleFilterToggle(event) {
        filtersActive = event.target.checked;
        if (filtersActive) {
            filterContainer.style.display = 'block';
            body.classList.add('filters-active');
        } else {
            filterContainer.style.display = 'none';
            body.classList.remove('filters-active');
        }
        applyFilters();
    }

    function handleYearInputChange() {
        // Automatically activate 'from' or 'to' when a value is entered
        const allPill = document.querySelector('.pill[data-type="publicationYear"][data-value="all"]');
        if (allPill && (fromYearInput.value || toYearInput.value)) {
            allPill.classList.remove('active');
        } else if (allPill && !fromYearInput.value && !toYearInput.value) {
            allPill.classList.add('active');
        }

        applyFilters();
    }

    function initializeFilterGroups() {
        [narrativeGroup, dataGroup, sourceGroup].forEach(group => {
            const header = group.querySelector('.filter-group-header');
            header.addEventListener('click', () => {
                group.classList.toggle('active');
            });
        });
    }

    function populateDynamicFilters() {
        const getUniqueAndSort = (data, key) => [...new Set(data.map(d => d[key]).filter(v => v && v.trim() !== '' && v !== 'N/A'))].sort();

        // Focuses (Country/Area)
        const focusValues = getUniqueAndSort(allData, 'Country/Area');
        if (focusValues.length > 0) {
            const focusSection = document.getElementById('focus-filter-section');
            focusSection.style.display = 'block';
            focusFilterPills.innerHTML = '<button class="pill active" data-type="focus" data-value="all">All</button>';
            focusValues.forEach(value => {
                focusFilterPills.innerHTML += `<button class="pill" data-type="focus" data-value="${value}">${value}</button>`;
            });
        }
        
        // Data Use Years
        const yearValues = getUniqueAndSort(allData, 'Data Use Year');
        if (yearValues.length > 0) {
            yearsFilterPills.innerHTML = '<button class="pill active" data-type="years" data-value="all">All</button>';
            yearValues.forEach(value => {
                const displayValue = value === 'TBA' ? `<span class="tba-text">TBA</span>` : value;
                yearsFilterPills.innerHTML += `<button class="pill" data-type="years" data-value="${value}">${displayValue}</button>`;
            });
        }
        
        // Visualization
        const vizValues = getUniqueAndSort(allData, 'Visualization');
        if (vizValues.length > 0) {
            vizFilterPills.innerHTML = '<button class="pill active" data-type="viz" data-value="all">All</button>';
            vizValues.forEach(value => {
                vizFilterPills.innerHTML += `<button class="pill" data-type="viz" data-value="${value}">${value}</button>`;
            });
        }
        
        // Representation
        const representationValues = getUniqueAndSort(allData, 'Representation');
        if (representationValues.length > 0) {
            representationFilterPills.innerHTML = '<button class="pill active" data-type="representation" data-value="all">All</button>';
            representationValues.forEach(value => {
                representationFilterPills.innerHTML += `<button class="pill" data-type="representation" data-value="${value}">${value}</button>`;
            });
        }
        
        // Attach click handlers to all new pills
        document.querySelectorAll('.filter-pills .pill').forEach(pill => {
            pill.addEventListener('click', handlePillClick);
        });
    }

    function initializeFilters() {
        populateDynamicFilters();
        initializeFilterGroups();

        // Attach listeners for static filters (Region, Outlet, Provider)
        document.querySelectorAll('#region-filter-pills .pill, #outlet-filter-pills .pill, #provider-filter-pills .pill').forEach(pill => {
            pill.addEventListener('click', handlePillClick);
        });

        // Attach listeners for meters filter (hardcoded options)
        document.querySelectorAll('#meters-filter-pills .pill').forEach(pill => {
            pill.addEventListener('click', handlePillClick);
        });

        // Attach listeners for year inputs
        fromYearInput.addEventListener('input', handleYearInputChange);
        toYearInput.addEventListener('input', handleYearInputChange);
        
        // Attach listener for publication year 'All' button
        document.querySelector('.pill[data-type="publicationYear"]').addEventListener('click', handlePillClick);
    }


    const csvUrl = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vT17d4M3J4V7W4hM6Z0k3Jj5J0P2O4r9X6j8d0M0F9kY9n9D0D8x0U0G8G9/pub?output=csv';

    function loadDataFromBackend() {
        Papa.parse(csvUrl, {
            download: true,
            header: true,
            skipEmptyLines: true,
            complete: function(results) {
                allData = results.data;
                // Pre-process data
                allData = allData.map(d => {
                    // Normalize the 'Date' to a YYYY-MM-DD format for consistency
                    if (d['Date'] && d['Date'].includes('/')) {
                        const [month, day, year] = d['Date'].split('/');
                        d['Date'] = `${year}-${month.padStart(2, '0')}-${day.padStart(2, '0')}`;
                    }
                    // Extract publication year
                    if (d['Date'] && d['Date'].length >= 4) {
                        d['Publication Year'] = d['Date'].substring(0, 4);
                    } else {
                        d['Publication Year'] = 'N/A';
                    }
                    return d;
                }).filter(d => d['Article Title'] && d['Article Title'].trim() !== ''); // Filter out rows with no Title

                // Sort data by Date (most recent first) and Article UID
                allData.sort((a, b) => {
                    // Sort by Date DESC
                    if (a['Date'] < b['Date']) return 1;
                    if (a['Date'] > b['Date']) return -1;
                    // Then by Article UID ASC
                    if (a['Article UID'] < b['Article UID']) return -1;
                    if (a['Article UID'] > b['Article UID']) return 1;
                    return 0;
                });


                initializeFilters();
                
                // MODIFICATION 5: Initial view setup
                feedToggle.checked = (currentView === 'feed');
                if (currentView === 'table') {
                    feedViewContainer.classList.add('hidden');
                    tableViewContainer.classList.remove('hidden');
                } else {
                    tableViewContainer.classList.add('hidden');
                    feedViewContainer.classList.remove('hidden');
                }
                
                applyFilters(); // Render initial view based on the currentView state

                loadingStatus.style.display = 'none';
                statsDisplay.style.display = 'inline';
            }
        });
    }

    // MODIFICATION 6: Add event listeners
    document.addEventListener('DOMContentLoaded', () => {
        // Event listener for the main filter toggle
        filterToggle.addEventListener('change', handleFilterToggle);

        // Event listener for the NEW feed toggle
        feedToggle.addEventListener('change', (event) => {
            const newView = event.target.checked ? 'feed' : 'table';
            updateView(newView);
            applyFilters();
        });

        // Event listener for hash changes
        window.addEventListener('hashchange', handleHashChange);
        
        // Load data last
        loadDataFromBackend();
    });
  </script>
</body>
</html>
