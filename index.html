<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Geospatial Narratives</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Geist:wght@100..900&family=Geist+Mono:wght@100..900&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200&icon_names=filter_list" />
  <style>
    /* Add box-sizing to all elements for consistent box model behavior */
    *, *::before, *::after {
      box-sizing: border-box;
    }

    /* Text selection styling */
    ::selection {
      background: rgb(221, 255, 109); /* Red background when selecting text */
      color: rgb(0, 0, 0); /* White text on selection */
    }

    body {
      font-family: 'Geist Mono', monospace;
      background: #f2f2f2;
      margin: 0;
      padding: 0;
      overflow: hidden; /* Prevents body from scrolling horizontally */
      display: flex;
      flex-direction: column;
      height: 100vh;
      text-rendering: optimizeLegibility; /* Added for legibility */
    }
    .nav {
      display: flex;
      justify-content: flex-start;
      align-items: center;
      padding: 3px 40px 3px 20px; /* Increased top padding to move lower */
      font-size: 17.5px;
      font-weight: 450;
      color: #000;
      gap: 10px;
      background: rgb(221, 255, 109);
    }
    .nav a {
      font-size: 17.5px;
      font-weight: 450;
      color: rgb(155, 180, 72);
      border-bottom: none;
      padding: 5px 10px;
    }
    .nav a:hover {
      color: #000;
    }
    .nav a.active {
      color: #000; /* Changed from #5f56ff to #000 */
    }
    .csv-upload {
      display: none;
    }

       /* New style for the update date */
    .update-date {
        font-family: 'Geist Mono', monospace;
        font-size: 15px; /* Smaller font size for date */
        font-weight: 300;
        color: #9f9e9e; /* Softer color for date */
        padding: 10px 0 0 29px; /* Padding to position it */
    }

    .stats {
      font-size: 96px; /* Same as the counter text */
      font-weight: 400;
      padding-top: 20px;
      padding-bottom: 10px;
      padding-left: 20px;
      color: #000;
    }
    .filter-container {
      padding: 0;
      background: #f2f2f2;
      /* border-top: 1px solid #000; /* Removed line on top */
    }
    .filter-group {
      background: #fff;
      border: none;
      border-radius: 0;
      margin-bottom: 0;
      overflow: hidden;
    }
    .filter-group:not(:first-child) {
      border-top: 1px solid #000;
    }
    .filter-group-header {
      padding: 6px 20px; /* Adjusted padding */
      font-size: 18px;
      font-weight: 500;
      background: #e6e6e6;
      cursor: pointer;
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-bottom: none;
      color: #999; /* Faint grey when inactive */
      /* transition: color 0.3s ease; /* Smooth transition for color change - removed */
    }

    /* New rule for filter group headers when filters are generally active */
    body.filters-active .filter-group-header {
        color: #000; /* Black when main filter toggle is on */
    }


    .filter-group-content {
      max-height: 0;
      overflow: hidden;
      transition: max-height 0.3s ease-out;
      padding: 0 20px;
      background-color: #e6e6e6;
    }
    .filter-group.active .filter-group-content {
      max-height: 600px; /* Keep this to allow content to expand, actual height is content-driven */
      padding-bottom: 10px; /* Adjusted padding */
    }
    .filter-title {
      font-size: 14px; /* Made smaller */
      font-weight: 500;
      margin-top: 10px; /* Reduced space */
      margin-bottom: 5px; /* Reduced space */
      color: #666; /* Closer to background gray */
    }
    .filter-group-content .filter-title:first-of-type {
        margin-top: 0;
    }
    .filter-pills {
      display: flex;
      flex-wrap: nowrap; /* Ensures horizontal scrolling */
      gap: 8px;
      overflow-x: auto; /* Enables horizontal scrolling */
      padding-bottom: 8px;
      -webkit-overflow-scrolling: touch; /* Smoother scrolling on iOS */
    }
    .filter-pills::-webkit-scrollbar {
        display: none; /* Hide scrollbar for Webkit browsers */
    }
    .filter-pills {
        -ms-overflow-style: none; /* Hide scrollbar for IE/Edge */
        scrollbar-width: none; /* Hide scrollbar for Firefox */
    }
    .pill {
      flex-shrink: 0;
      padding: 6px 12px;
      border-radius: 16px;
      border: 1px solid #999;
      background: transparent;
      cursor: pointer;
      font-size: 13px;
      transition: all 0.2s ease;
      color: #000;
    }
    .pill:hover {
      background: rgba(0, 0, 0, 0.1);
    }
    .pill.active {
      background: #000; /* Changed from #5f56ff to #000 */
      color: white;
      border-color: #000; /* Changed from #5f56ff to #000 */
    }
    .year-range-filter {
      display: flex;
      gap: 10px;
      margin-top: 8px;
      align-items: center; /* Vertically align items */
    }
    .year-range-filter input[type="number"] {
      padding: 6px 10px;
      border: 1px solid #999;
      background: transparent;
      border-radius: 10px;
      font-size: 13px;
      width: 80px;
      color: #000;
      
    }
    .table-view-container, .feed-view-container {
      margin: 0;
      flex-grow: 1;
      overflow-y: auto;
      /* overflow-x: auto; This was removed to prevent horizontal scroll */
      position: relative;
      background: #f2f2f2;
    }
    table {
      width: 100%;
      /* min-width: 1200px; This was removed as we are adjusting font size instead of scrolling */
      border-collapse: collapse;
      background: #fff;
      table-layout: fixed;
    }
    th {
      text-align: left;
      padding: 4px 12px;
      border-bottom: 1px solid #D3D3D3;
      border-top: 1px solid #D3D3D3;
      font-family: 'Geist Mono', monospace;
      vertical-align: top;
      font-size: 13px; /* Base font size */
      font-weight: 500;
      word-wrap: break-word; /* Allows text to break to the next line */
    }
    td {
      text-align: left;
      padding: 4px 12px;
      border-bottom: 1px solid #D3D3D3;
      border-top: 1px solid #D3D3D3;
      font-family: 'Geist Mono', monospace;
      vertical-align: top;
      font-size: 13px; /* Base font size */
      font-weight: 400;
      word-wrap: break-word; /* Allows text to break to the next line */
    }
    /* Specific styles for columns 1-8 */
    th:nth-child(-n+7),
    td:nth-child(-n+7) {
      border-bottom: 1px solid #000;
    }
    th:nth-child(-n+7) {
      border-top: none; /* No top border for header cells in columns 1-8 */
    }
    td:nth-child(-n+7) {
      border-top: 1px solid #000;
    }

    /* Fixed width for specific columns */
    th:nth-child(1),
    td:nth-child(1) {
      width: 6%; /* Date */
      min-width: 6%;
      max-width: 6%;
    }
    th:nth-child(2),
    td:nth-child(2) {
      width: 13%; /* Title */
      min-width: 13%;
      max-width: 13%;
    }
    th:nth-child(3),
    td:nth-child(3) {
      width: 4%; /* Link */
      min-width: 4%;
      max-width: 4%;
    }
    th:nth-child(4),
    td:nth-child(4) {
      width: 9%; /* Outlet */
      min-width: 9%;
      max-width: 9%;
    }
    th:nth-child(5),
    td:nth-child(5) {
      width: 7%; /* Country */
      min-width: 7%;
      max-width: 7%;
    }
    th:nth-child(6),
    td:nth-child(6) {
      width: 10%; /* Context */
      min-width: 10%;
      max-width: 10%;
    }
    th:nth-child(7),
    td:nth-child(7) {
      width: 8%; /* Category */
      min-width: 8%;
      max-width: 8%;
    }
    th:nth-child(8),
    td:nth-child(8) {
      width: 3.5%; /* Data use */
      min-width: 3.5%;
      max-width: 3.5%;
    }
    th:nth-child(9),
    td:nth-child(9) {
      width: 6.5%; /* Provider */
      min-width: 6.5%;
      max-width: 6.5%;
    }
    th:nth-child(10),
    td:nth-child(10) {
      width: 6%; /* Platform */
      min-width: 6%;
      max-width: 6%;
    }
    th:nth-child(11),
    td:nth-child(11) {
      width: 7%; /* Representation */
      min-width: 7%;
      max-width: 7%;
    }
    th:nth-child(12),
    td:nth-child(12) {
      width: 4%; /* Resolution */
      min-width: 4%;
      max-width: 4%;
    }
    th:nth-child(13),
    td:nth-child(13) {
      width: 4%; /* Viz */
      min-width: 4%;
      max-width: 4%;
    }

    thead {
      position: sticky;
      top: 0;
      z-index: 10;
    }
    th {
      background: #000;
      color: white;
      border-top: none;
      border-bottom: 1px solid #000;
    }
    /* Explicitly left align headers of columns 8-14 and make them black */
    th:nth-child(n+8) {
      background-color: #000;
      text-align: left;
    }
    /* Left align content of columns 8-14 */
    td:nth-child(n+8) {
      text-align: left;
    }
    a {
      color: #997b21;
      text-decoration: none;
      border-bottom: none;
    }
    .month {
      color: gray;
    }
    .provider-item {
      display: block;
      margin-bottom: 4px;
      padding-bottom: 4px;
    }
    .provider-item:not(:last-child) {
      border-bottom: 1px solid #ddd;
    }
    .provider-resolution-group {
      font-size: 12px;
      line-height: 1.4;
    }

    /* Toggle Switches Container */
    .toggles-container {
      background: #f2f2f2;
      padding: 0 40px 10px 20px;
      display: flex;
      justify-content: flex-start;
      align-items: center;
      gap: 20px;
      margin-top: 10px;
    }

    .filter-toggle-group, .feed-toggle-group {
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .filter-toggle-label, .feed-toggle-label {
      font-size: 18px;
      font-weight: 500;
      color: #000000;
    }

    /* The switch - the box around the slider */
    .switch {
      position: relative;
      display: inline-block;
      width: 40px;
      height: 24px;
    }

    /* Hide default HTML checkbox */
    .switch input {
      opacity: 0;
      width: 0;
      height: 0;
    }

    /* The slider */
    .slider {
      position: absolute;
      cursor: pointer;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: #ccc;
      -webkit-transition: .4s;
      transition: .4s;
      border-radius: 24px;
    }

    .slider:before {
      position: absolute;
      content: "";
      height: 18px;
      width: 18px;
      left: 3px;
      bottom: 3px;
      background-color: white;
      -webkit-transition: .4s;
      transition: .4s;
      border-radius: 50%;
    }

    input:checked + .slider {
      background-color: #000;
    }

    input:focus + .slider {
      box-shadow: 0 0 1px #000;
    }

    input:checked + .slider:before {
      -webkit-transform: translateX(16px);
      -ms-transform: translateX(16px);
      transform: translateX(16px);
    }

    /* Overlay styles */
    .overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: transparent;
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 1000;
      font-size: 10em;
      font-weight: bold;
      color: #333;
      text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
      pointer-events: none;
      opacity: 1;
      transition: opacity 0.5s ease-out;
    }
    .overlay.hidden {
      opacity: 0;
      visibility: hidden;
    }

    /* Specific styles for data detail columns */
    .data-detail-cell {
      font-size: 13px; /* Base font size */
      padding: 4px 8px;
      background-color: rgb(221, 255, 109);
      padding-left: 12px;
    }

    /* Light grey top border for the first row of each article, across all columns */
    tr.article-start td {
      border-top: 1px solid #D3D3D3;
    }

    /* FIX: Override the light grey top border for data-detail-cells when it's the article start */
    tr.article-start .data-detail-cell {
        border-top: 1px solid #000;
    }

    /* Black bottom border for the last data point row of an article, across all columns */
    tr.last-cdp-of-article td {
      border-bottom: 1px solid #000;
    }
    /* Ensure data-detail-cell gets a black bottom border if it's the last data point of an article */
    tr.last-cdp-of-article .data-detail-cell {
        border-bottom: 1px solid #000;
    }

    /* Override for data-detail-cells that are NOT the last cdp of an article */
    /* This ensures they maintain light grey bottom borders if they are intermediate rows */
    tr:not(.last-cdp-of-article) .data-detail-cell {
        border-bottom: 1px solid rgba(0, 0, 0, 0.2);
    }

    /* Show/Hide View Containers */
    .table-view-container.hidden,
    .feed-view-container.hidden {
      display: none;
    }

    /* Feed View Specific Styles (similar to quote-only view) */
    .feed-view-container {
      padding: 20px 40px;
      background: #fff;
      overflow-y: auto;
      border-top: 1px solid #000;
    }

    .feed-view-container .article-item {
      font-size: 80px; /* Increased font size, similar to quotes */
      font-weight: 500;
      margin-bottom: 20px;
      line-height: 1.2;
      color: #000000;
      border-bottom: 1px solid #eee; /* Light separator */
      padding-bottom: 15px;
      cursor: pointer; /* Clickable */
      display: flex; /* Changed to flex to align details to bottom */
      flex-direction: column; /* Stack title and details vertically */
      justify-content: flex-start; /* Align content to the start (top) */
      text-decoration: none; /* Remove underline from link */
      text-transform: uppercase; /* All caps */
      white-space: normal; /* Allow text to wrap */
      overflow: visible; /* Allow content to be visible */
      text-overflow: clip; /* Remove ellipsis */
      font-family: 'Geist', sans-serif; /* Use Geist font */
      text-rendering: geometricPrecision; /* Added for geometric precision */
      word-spacing: normal; /* Default value */
      letter-spacing: normal; /* Default value */
    }

    .feed-view-container .article-item:last-child {
      border-bottom: none; /* No border for the last item */
      margin-bottom: 0;
    }
    .feed-view-container .article-item a {
        color: inherit; /* Inherit color from parent div */
        text-decoration: none; /* No underline */
    }

    .article-details {
      font-size: 14px; /* Details font size */
      font-weight: 350; /* Not bold */
      color: #969696; /* A bit lighter color for details */
      margin-top: 5px; /* Reduced space above details */
      text-align: left; /* Aligned to the left */
      text-transform: none; /* Details should not be all caps */
      padding-left: 10px; /* Small indent */
      font-family: 'Geist Mono', monospace; /* Use Geist Mono for details */
    }

    /* Spacing for article count numbers */
    .article-count-number {
      margin-left: 30px; /* Default for desktop */
    }

    sup .article-count-number {
      margin-left: 1px; /* Default for desktop superscript */
    }

    /* New CSS for Material Symbols */
    .material-symbols-outlined {
      font-variation-settings:
      'FILL' 0,
      'wght' 400,
      'GRAD' 0,
      'opsz' 24
    }

    /* New style for PENDING status */
    .pending-status {
        color: blue;
    }

    /* --- Responsive Design --- */

    /* New media query for screens smaller than or equal to 1600px */
    @media (max-width: 1600px) {
      th, td, .data-detail-cell {
        font-size: 11.5px; /* 11pt equivalent for smaller screens */
      }
    }

    /* For screens smaller than 768px (tablets and smaller) */
    @media (max-width: 1268px) {
      .nav {
        padding: 15px 20px 15px 15px;
        font-size: 18px;
        gap: 5px;
      }
      .nav a {
        font-size: 18px;
        padding: 3px 8px;
      }
    
      .stats {
        font-size: 60px;
        padding: 15px 20px 5px 20px;
      }
      .toggles-container {
        padding: 0 20px 10px 15px;
        gap: 15px;
      }
      .filter-toggle-label, .feed-toggle-label {
        font-size: 16px;
      }
      .filter-group-header {
        font-size: 16px;
        padding: 6px 15px; /* Adjusted padding */
      }
      .filter-group-content {
        padding: 0 15px;
      }
      .filter-title {
        font-size: 12px;
      }
      .pill {
        font-size: 12px;
        padding: 5px 10px;
      }
      .year-range-filter input[type="number"] {
        font-size: 12px;
        width: 60px;
      }

      /* HIDE ALL COLUMNS FROM THE 4TH ONWARDS FOR SMALL VIEWPORT */
      th:nth-child(n+5),
      td:nth-child(n+5) {
        display: none;
      }

      /* Adjust widths for the first three visible columns to fill the viewport */
      th:nth-child(1),
      td:nth-child(1) {
        width: 20%; /* Date */
        min-width: 20%;
        max-width: 20%;
      }
      th:nth-child(2),
      td:nth-child(2) {
        width: 40%; /* Title */
        min-width: 40%;
        max-width: 40%;
      }
      th:nth-child(3),
      td:nth-child(3) {
        width: 15%; /* Link */
        min-width: 15%;
        max-width: 15%;
      }
       th:nth-child(4),
      td:nth-child(4) {
        width: 25%; /* Link */
        min-width: 25%;
        max-width: 25%;
      }

      th, td {
        font-size: 12px; /* Adjusted to 10px for even smaller screens */
        padding: 6px 8px;
      }
      .overlay {
        font-size: 7em;
      }
      .data-detail-cell {
        font-size: 0px; /* Adjusted for consistency */
        padding: 0px 0px;
      }
      .feed-view-container {
        padding: 15px 20px;
      }
      .feed-view-container .article-item {
        font-size: 40px; /* Half of 80px -> 40px */
        margin-bottom: 15px;
        padding-bottom: 10px;
      }
      .article-details {
        font-size: 12px; /* Smaller details font size */
        margin-top: 8px;
        padding-left: 8px;
      }
    }

   /* For screens smaller than 480px (mobile phones) */
    @media (max-width: 480px) {
      .nav {
        padding: 5px 20px 5px 5px;
        font-size: 18px;
        gap: 5px;
      }
      .nav a {
        font-size: 17px;
        padding: 3px 8px;
      }
      .update-date {
        font-size: 12px;
        padding: 10px 0 0 13px;
      }
      .stats {
        font-size: 42px;
        padding-top: 17px;
        padding-left: 1.5px;
        padding-bottom: 10px;
        padding-left: 10px;
      }
      .toggles-container {
        padding: 0 20px 10px 12px;
        gap: 15px;
      }
      .filter-toggle-label, .feed-toggle-label {
        font-size: 16px;
      }
      .filter-group-header {
        font-size: 16px;
        padding: 6px 15px; /* Adjusted padding */
      }
      .filter-group-content {
        padding: 0 15px;
      }
      .filter-title {
        font-size: 12px;
      }
      .pill {
        font-size: 12px;
        padding: 5px 10px;
      }
      .year-range-filter input[type="number"] {
        font-size: 12px;
        width: 60px;
        padding: 5px 15px;
      }

      /* HIDE ALL COLUMNS FROM THE 4TH ONWARDS FOR SMALL VIEWPORT */
      th:nth-child(n+4),
      td:nth-child(n+4) {
        display: none;
      }

      /* Adjust widths for the first three visible columns to fill the viewport */
      th:nth-child(1),
      td:nth-child(1) {
        width: 24%; /* Date */
        min-width: 24%;
        max-width: 24%;
      }
      th:nth-child(2),
      td:nth-child(2) {
        width: 61%; /* Title */
        min-width: 61%;
        max-width: 61%;
      }
      th:nth-child(3),
      td:nth-child(3) {
        width: 15%; /* Link */
        min-width: 15%;
        max-width: 15%;
      }

      th, td {
        font-size: 12px; /* Adjusted to 10px for even smaller screens */
        line-height: 1.3;
        padding: 6px 8px;
      }
      .overlay {
        font-size: 7em;
      }
      .data-detail-cell {
        font-size: 0px; /* Adjusted for consistency */
        padding: 0px 0px;
      }
      .feed-view-container {
        padding: 10px 15px;
      }
      .feed-view-container .article-item {
        font-size: 23px; /* Adjusted for responsive */
        letter-spacing: -0.025em;
        line-height: 1.3;
        font-weight: medium;
        margin-bottom: 10px;
        padding-bottom: 8px;
      }
      .article-details {
        font-size: 11px; /* Even smaller details font size */
        margin-top: 5px;
        padding-left: 1px;
      }

      /* Mobile-specific spacing for article count numbers */
      .article-count-number {
        margin-left: 8px;
      }

      sup .article-count-number {
        margin-left: 0px;
        font-size: 75%; /* Adjust as needed, e.g., 60% for slightly larger */
        position: relative;
        top: -0.2em;
      }
    }
  </style>
</head>
<body>
  <div id="fixed-header-area">
    <div class="nav">
      <a href="index.html" class="active">Index</a>
      <a href="literacy.html">Literacy</a>
      <a href="about.html">About</a>
    </div>
      <div class="update-date">
        updated: 2025-07-15
    </div>
    <div class="stats">
      <span id="loadingStatus">Loading data...</span>
      <div id="statsDisplay" style="display: none;"></div>
    </div>

    <div class="toggles-container">
        <div class="filter-toggle-group">
            <span class="filter-toggle-label"><span class="material-symbols-outlined">filter_list</span></span>
            <label class="switch">
                <input type="checkbox" id="filterToggle">
                <span class="slider"></span>
            </label>
        </div>
        <div class="feed-toggle-group">
            <span class="feed-toggle-label">FEED</span>
            <label class="switch">
                <input type="checkbox" id="feedToggle">
                <span class="slider"></span>
            </label>
        </div>
    </div>

    <div class="filter-container">
      <div class="filter-group" id="narrative-group">
          <div class="filter-group-header">NARRATIVE</div>
          <div class="filter-group-content">
              <div class="filter-title">Publication Year Range:</div>
              <div class="year-range-filter">
                  <button class="pill active" data-type="publicationYear" data-value="all">All</button>
                  <input type="number" id="fromYearInput" placeholder="Year">
                  <input type="number" id="toYearInput" placeholder="Year">
              </div>

              <div class="filter-title">Region:</div>
              <div class="filter-pills" id="region-filter-pills">
                  <button class="pill active" data-type="region" data-value="all">All</button>
                  <button class="pill" data-type="region" data-value="Europe">Europe</button>
                  <button class="pill" data-type="region" data-value="Middle East">Middle East</button>
                  <button class="pill" data-type="region" data-value="Americas">Americas</button>
                  <button class="pill" data-type="region" data-value="Asia">Asia</button>
              </div>

              <div id="focus-filter-section" style="display: none;">
                  <div class="filter-title">Country/Area:</div>
                  <div class="filter-pills" id="focus-filter-pills">
                      <button class="pill active" data-type="focus" data-value="all">All</button>
                      </div>
              </div>
          </div>
      </div>

      <div class="filter-group" id="data-group">
          <div class="filter-group-header">DATA</div>
          <div class="filter-group-content">
              <div class="filter-title">Resolution:</div>
              <div class="filter-pills" id="meters-filter-pills">
                  <button class="pill active" data-type="resolutionCategory" data-value="all">All</button>
                  <button class="pill" data-type="resolutionCategory" data-value="<1m">&lt;1m</button>
                  <button class="pill" data-type="resolutionCategory" data-value="1-10m">1-10m</button>
                  <button class="pill" data-type="resolutionCategory" data-value=">10m">&gt;10m</button>
              </div>

              <div class="filter-title">Visualization:</div>
              <div class="filter-pills" id="viz-filter-pills">
                  <button class="pill active" data-type="viz" data-value="all">All</button>
              </div>

              <div class="filter-title">Data Use Year:</div>
              <div class="filter-pills" id="years-filter-pills">
                  <button class="pill active" data-type="years" data-value="all">All</button>
                  </div>

              <div class="filter-title">Representation:</div>
              <div class="filter-pills" id="representation-filter-pills">
                  <button class="pill active" data-type="representation" data-value="all">All</button>
              </div>
          </div>
      </div>

      <div class="filter-group" id="source-group">
          <div class="filter-group-header">SOURCE</div>
          <div class="filter-group-content">
              <div class="filter-title">Outlet:</div>
              <div class="filter-pills" id="outlet-filter-pills">
                  <button class="pill active" data-type="outlet" data-value="all">All</button>
                  <button class="pill" data-type="outlet" data-value="The New York Times">The New York Times</button>
                  <button class="pill" data-type="outlet" data-value="Washington Post">Washington Post</button>
                  <button class="pill" data-type="outlet" data-value="The Guardian">The Guardian</button>
                  <button class="pill" data-type="outlet" data-value="BBC">BBC</button>
                  <button class="pill" data-type="outlet" data-value="CNN">CNN</button>
                  <button class="pill" data-type="outlet" data-value="Reuters">Reuters</button>
                  <button class="pill" data-type="outlet" data-value="Sky News">Sky News</button>
              </div>

              <div class="filter-title">Provider:</div>
              <div class="filter-pills" id="provider-filter-pills">
                  <button class="pill active" data-type="provider" data-value="all">All</button>
                  <button class="pill" data-type="provider" data-value="Planet Labs">Planet Labs</button>
                  <button class="pill" data-type="provider" data-value="Maxar">Maxar</button>
                  <button class="pill" data-type="provider" data-value="ESA">ESA</button>
                  <button class="pill" data-type="provider" data-value="NASA">NASA</button>
                  <button class="pill" data-type="provider" data-value="USGS">USGS</button>
                  <button class="pill" data-type="provider" data-value="Airbus">Airbus</button>
              </div>
          </div>
      </div>
    </div>
  </div>

  <div id="tableViewContainer" class="table-view-container">
    <table>
      <thead>
        <tr>
          <th>Date</th>
          <th>Title</th>
          <th>Link</th> <th>Outlet</th>
          <th>Country</th> <th>Context</th>
          <th>Category</th>
          <th>Use</th>
          <th>Provider</th>
          <th>Platform</th>
          <th>Sensor</th>
          <th>Res</th>
          <th>Viz</th>
          </tr>
      </thead>
      <tbody>
        </tbody>
    </table>
  </div>

  <div id="feedViewContainer" class="feed-view-container hidden">
    </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
  <script>
    let allData = [];
    let selectedRegion = 'all';
    let selectedFocuses = ['all'];
    let selectedYears = ['all'];
    let filtersActive = false;
    let currentView = 'table'; // 'table' or 'feed'

    const countryRegions = {
      'Gaza Strip': 'Middle East',
      'Ukraine': 'Europe',
      'Russia': 'Europe',
      'Guantanamo Bay': 'Americas',
      'China': 'Asia',
      'Amazon Rainforest': 'Americas',
      'Syria': 'Middle East',
      'Iraq': 'Middle East',
      'Afghanistan': 'Asia',
      'North Korea': 'Asia',
      'United States': 'Americas',
      'Canada': 'Americas',
      'Brazil': 'Americas',
      'Germany': 'Europe',
      'France': 'Europe',
      'United Kingdom': 'Europe',
      'India': 'Asia',
      'Japan': 'Asia',
      'Australia': 'Asia',
      'Egypt': 'Middle East',
      'Iran': 'West Asia', // Added for sample data
      'Sudan': 'Africa', // Added for sample data
      'Italy': 'Europe', // Added for sample data
    };

    // --- GLOBAL FUNCTIONS ---
    // Moved getMeterCategory here to be accessible by both loadDataFromBackend and loadSampleData
    function getMeterCategory(resolution) {
      if (!resolution) return '';
      const lowerCaseResolution = resolution.toLowerCase();
      // Exact string matches first for clarity and direct handling
      if (lowerCaseResolution.includes('<1m')) {
        return '<1m';
      }
      if (lowerCaseResolution.includes('1-10m')) {
        return '1-10m';
      }
      if (lowerCaseResolution.includes('>10m')) {
        return '>10m';
      }
      // Numerical parsing as a fallback or for specific number values
      const numMatch = resolution.match(/(\d+\.?\d*)/);
      if (numMatch) {
        const res = parseFloat(numMatch[1]);
        if (res > 0 && res < 1) {
          return '<1m';
        } else if (res >= 1 && res <= 10) {
          return '1-10m';
        } else if (res > 10) {
          return '>10m';
        }
      }
      return '';
    }

    function extractYears(dataUseString) {
        if (!dataUseString) return [];
        const yearMatches = dataUseString.match(/\b\d{4}\b/g);
        return yearMatches ? Array.from(new Set(yearMatches)).sort() : [];
    }

    function adjustContentViewHeight() {
      const fixedHeader = document.getElementById('fixed-header-area');
      const togglesContainer = document.querySelector('.toggles-container');
      const tableViewContainer = document.getElementById('tableViewContainer');
      const feedViewContainer = document.getElementById('feedViewContainer'); // Changed from titleOnlyViewContainer

      if (fixedHeader && togglesContainer && (tableViewContainer || feedViewContainer)) {
        const headerHeight = fixedHeader.offsetHeight;
        const togglesHeight = togglesContainer.offsetHeight;
        const remainingHeight = `calc(100vh - ${headerHeight}px - ${togglesHeight}px)`;

        if (tableViewContainer) {
            tableViewContainer.style.height = remainingHeight;
        }
        if (feedViewContainer) { // Updated to feedViewContainer
            feedViewContainer.style.height = remainingHeight;
        }
      }
    }
    // --- END GLOBAL FUNCTIONS ---

    document.addEventListener('DOMContentLoaded', function() {
      loadDataFromBackend();

      document.querySelectorAll('.filter-pills .pill').forEach(pill => {
        pill.addEventListener('click', handlePillClick);
      });

      // Event listener for the "All" button in the publication year filter
document.querySelector('.pill[data-type="publicationYear"][data-value="all"]').addEventListener('click', function () {
    document.getElementById('fromYearInput').value = '';
    document.getElementById('toYearInput').value = '';

    document.querySelectorAll('.pill[data-type="publicationYear"]').forEach(pill => {
        pill.classList.remove('active');
    });
    this.classList.add('active');

    filterTable();
});

document.getElementById('fromYearInput').addEventListener('input', function () {
    const allPill = document.querySelector('.pill[data-type="publicationYear"][data-value="all"]');
    allPill.classList.remove('active');
    filterTable();
});
document.getElementById('toYearInput').addEventListener('input', function () {
    const allPill = document.querySelector('.pill[data-type="publicationYear"][data-value="all"]');
    allPill.classList.remove('active');
    filterTable();
});


      document.querySelectorAll('.filter-group-header').forEach(header => {
        header.addEventListener('click', function() {
          const group = this.closest('.filter-group');
          if (filtersActive) { // Only toggle if filters are active
            group.classList.toggle('active');
            adjustContentViewHeight();
          }
        });
      });

      const filterToggle = document.getElementById('filterToggle');
      filterToggle.addEventListener('change', function() {
        filtersActive = this.checked;
        if (filtersActive) {
            document.body.classList.add('filters-active');
            toggleAllFilters(true); // Expand all when toggled on
        } else {
            document.body.classList.remove('filters-active');
            toggleAllFilters(false); // Collapse all when toggled off
        }
        filterTable();
      });

      // Feed Toggle Switch (renamed from feedToggle/titleToggle)
      const feedToggle = document.getElementById('feedToggle');
      feedToggle.addEventListener('change', function() {
        currentView = this.checked ? 'feed' : 'table'; // 'feed' instead of 'title'
        updateView();
      });

      const currentPath = window.location.pathname.split('/').pop();
      document.querySelectorAll('.nav a').forEach(link => {
        if (link.getAttribute('href') === currentPath && link.getAttribute('href') !== 'index.html') {
          document.querySelector('.nav a[href="index.html"]').classList.remove('active');
          link.classList.add('active');
        } else if (currentPath === '' && link.getAttribute('href') === 'index.html') {
          // This ensures index.html is active when directly loading the root or index.html
        }
      });

      adjustContentViewHeight();
      window.addEventListener('resize', adjustContentViewHeight);

      const initialOverlay = document.getElementById('initialOverlay');
      const hideOverlay = () => {
        if (initialOverlay && !initialOverlay.classList.contains('hidden')) {
          initialOverlay.classList.add('hidden');
          document.removeEventListener('mousemove', hideOverlay);
          document.removeEventListener('scroll', hideOverlay);
          document.removeEventListener('click', hideOverlay);
          document.removeEventListener('keydown', hideOverlay);
        }
      };

      document.addEventListener('mousemove', hideOverlay);
      document.addEventListener('scroll', hideOverlay);
      document.addEventListener('click', hideOverlay);
      document.addEventListener('keydown', hideOverlay);
    });

    async function loadDataFromBackend() {
      const loadingStatus = document.getElementById('loadingStatus');
      const statsDisplay = document.getElementById('statsDisplay');
      try {
        loadingStatus.textContent = 'Loading data from server...';
        const response = await fetch('./data.csv');
        if (!response.ok) {
          // If the file is not found or other HTTP error, trigger fallback
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        const csvText = await response.text();
        Papa.parse(csvText, {
          header: true,
          skipEmptyLines: true,
          dynamicTyping: false,
          complete: function(results) {
            const parsedData = results.data;
            allData = parsedData.map(row => {
              // Ensure required fields exist, provide defaults if missing
              const date = row.Date || '';
              const publicationYear = date ? new Date(date).getFullYear() : null;
              const providers = row.Provider ? row.Provider.split(/[,;]/).map(p => p.trim()).filter(p => p) : [''];
              const resolutions = row.Resolution ? row.Resolution.split(/[,;]/).map(r => r.trim()).filter(r => r) : [''];
              const platforms = row.Platform ? row.Platform.split(/[,;]/).map(p => p.trim()).filter(p => p) : [''];
              const representations = row.Representation ? row.Representation.split(/[,;]/).map(r => r.trim()).filter(r => r) : [''];
              const vizs = row.Viz ? row.Viz.split(/[,;]/).map(v => v.trim()).filter(v => v) : [''];
              const dataUseYears = extractYears(row['Data use'] || '');
              if (dataUseYears.length === 0) dataUseYears.push('');

              let combinedDataPoints = [];
              const hasProviderData = providers.some(p => p !== '') || resolutions.some(r => r !== '') || platforms.some(p => p !== '') || representations.some(r => r !== '') || vizs.some(v => v !== '');

              if (!hasProviderData && dataUseYears.length > 0) {
                dataUseYears.forEach(year => {
                  combinedDataPoints.push({ dataUseYear: year, provider: '', platform: '', resolution: '', resolutionCategory: '', representation: '', viz: '' });
                });
              } else if (hasProviderData) {
                dataUseYears.forEach(year => {
                  const currentMaxLength = Math.max(providers.length, resolutions.length, platforms.length, representations.length, vizs.length);
                  for (let i = 0; i < currentMaxLength; i++) {
                    combinedDataPoints.push({
                      dataUseYear: year,
                      provider: providers[i] || providers[0] || '',
                      platform: platforms[i] || platforms[0] || '',
                      resolution: resolutions[i] || resolutions[0] || '',
                      resolutionCategory: getMeterCategory(resolutions[i] || resolutions[0] || ''),
                      representation: representations[i] || representations[0] || '',
                      viz: vizs[i] || vizs[0] || ''
                    });
                  }
                });
              } else {
                combinedDataPoints.push({ dataUseYear: '', provider: '', platform: '', resolution: '', resolutionCategory: '', viz: '' });
              }

              return {
                date: date,
                publicationYear: publicationYear,
                title: row.Title || '',
                link: row.Link || '',
                outlet: row.Outlet || '',
                country: row.Country || '',
                region: countryRegions[row.Country] || '',
                context: row.Context || '',
                category: row.Category || '',
                combinedDataPoints: combinedDataPoints,
              };
            });
            initializeFilters();
            filterTable();
            loadingStatus.style.display = 'none';
            statsDisplay.style.display = 'block';
          }
        });
      } catch (error) {
        console.error('Error loading data from backend, falling back to sample data:', error);
        loadSampleData();
      }
    }

    function loadSampleData() {
      const loadingStatus = document.getElementById('loadingStatus');
      const statsDisplay = document.getElementById('statsDisplay');
      const resolutionsList = ['<1m', '1-10m', '>10m'];
      const sampleData = [
        { Date: '2024-03-15', Title: 'Überschwemmungsgebiete Experts waarschuwen: Rusland bouwt lanceerinstallaties voor hypermoderne kernraket', Link: 'http://example.com/urban-expansion', Outlet: 'The New York Times', Country: 'United States', Context: 'Urban development patterns', Category: 'Environment', 'Data use': '2023; 2024', Provider: 'Planet Labs; Maxar', Platform: 'Sentinel-2; Landsat', Resolution: resolutionsList[Math.floor(Math.random() * resolutionsList.length)], Representation: 'Optical; Hyperspectral', Viz: 'RGB; NRG', },
        { Date: '2023-11-20', Title: 'Deforestation in Amazon', Link: 'http://example.com/deforestation', Outlet: 'The Guardian', Country: 'Brazil', Context: 'Environmental monitoring', Category: 'Environment', 'Data use': '2022', Provider: 'ESA', Platform: 'Sentinel-1', Resolution: resolutionsList[Math.floor(Math.random() * resolutionsList.length)], Representation: 'Optical', Viz: 'NDVI', },
        { Date: '2024-01-05', Title: 'Glacier Retreat in Alps', Link: 'http://example.com/glacier-retreat', Outlet: 'BBC', Country: 'Germany', Context: 'Climate change impact', Category: 'Climate', 'Data use': '2020; 2024', Provider: 'NASA', Platform: 'MODIS', Resolution: resolutionsList[Math.floor(Math.random() * resolutionsList.length)], Representation: 'Hyperspectral', Viz: 'RGB', },
        { Date: '2023-09-01', Title: 'Crop Yield Analysis', Link: 'http://example.com/crop-yield', Outlet: 'Reuters', Country: 'India', Context: 'Agriculture and food security', Category: 'Agriculture', 'Data use': '2023', Provider: 'USGS', Platform: 'Landsat', Resolution: resolutionsList[Math.floor(Math.random() * resolutionsList.length)], Representation: 'Radar', Viz: 'NRG', },
        { Date: '2024-02-10', Title: 'Coastal Erosion Study', Link: 'http://example.com/coastal-erosion', Outlet: 'CNN', Country: 'Japan', Context: 'Disaster preparedness', Category: 'Environment', 'Data use': '2024', Provider: 'Airbus', Platform: 'SPOT', Resolution: resolutionsList[Math.floor(Math.random() * resolutionsList.length)], Representation: 'Optical', Viz: 'NDVI', },
        { Date: '2024-04-22', Title: 'Urban Expansion in Shanghai', Link: 'http://example.com/shanghai-expansion', Outlet: 'The New York Times', Country: 'China', Context: 'City planning and development', Category: 'Urbanization', 'Data use': '2023', Provider: 'Planet Labs', Platform: 'Dove', Resolution: resolutionsList[Math.floor(Math.random() * resolutionsList.length)], Representation: 'Optical', Viz: 'RGB', },
        { Date: '2023-07-18', Title: 'Monitoring Conflict Zones in Syria', Link: 'http://example.com/syria-conflict', Outlet: 'Washington Post', Country: 'Syria', Context: 'Humanitarian crisis', Category: 'Conflict', 'Data use': '2022', Provider: 'Maxar', Platform: 'WorldView-3', Resolution: resolutionsList[Math.floor(Math.random() * resolutionsList.length)], Representation: 'Optical', Viz: 'Pan-sharpened', },
        { Date: '2024-01-25', Title: 'Arctic Ice Melt Acceleration', Link: 'http://example.com/arctic-melt', Outlet: 'The Guardian', Country: 'Canada', Context: 'Climate change research', Category: 'Climate', 'Data use': '2023', Provider: 'ESA', Platform: 'CryoSat-2', Resolution: resolutionsList[Math.floor(Math.random() * resolutionsList.length)], Representation: 'Radar', Viz: 'Altimetry data', },
        { Date: '2023-10-10', Title: 'Drought Impact in East Africa', Link: 'http://example.com/drought-africa', Outlet: 'BBC', Country: 'Sudan', Context: 'Food security and water scarcity', Category: 'Environment', 'Data use': '2023', Provider: 'NASA', Platform: 'GRACE', Resolution: resolutionsList[Math.floor(Math.random() * resolutionsList.length)], Representation: 'Gravimetry', Viz: 'Anomaly maps', },
        { Date: '2024-03-01', Title: 'Electoral Monitoring in Venezuela', Link: 'http://example.com/venezuela-election', Outlet: 'CNN', Country: 'Brazil', Context: 'Political analysis', Category: 'Politics', 'Data use': '2024', Provider: 'USGS', Platform: 'Landsat 8', Resolution: resolutionsList[Math.floor(Math.random() * resolutionsList.length)], Representation: 'Optical', Viz: 'False Color', },
        { Date: '2023-08-05', Title: 'Historical Urban Growth in Rome', Link: 'http://example.com/rome-urban', Outlet: 'Reuters', Country: 'Italy', Context: 'Historical studies', Category: 'Urbanization', 'Data use': '1990; 2020', Provider: 'ESA; USGS', Platform: 'Sentinel-2; Landsat', Resolution: resolutionsList[Math.floor(Math.random() * resolutionsList.length)], Representation: 'Optical', Viz: 'Time-series animation', },
        { Date: '2024-05-10', Title: 'Monitoring Illegal Mining in Amazon', Link: 'http://example.com/illegal-mining', Outlet: 'The Guardian', Country: 'Brazil', Context: 'Environmental crime', Category: 'Environment', 'Data use': '2024', Provider: 'Planet Labs', Platform: 'SkySat', Resolution: resolutionsList[Math.floor(Math.random() * resolutionsList.length)], Representation: 'Optical', Viz: 'High-res imagery', },
        { Date: '2023-12-01', Title: 'Wildfire Tracking in California', Link: 'http://example.com/california-fire', Outlet: 'CNN', Country: 'United States', Context: 'Disaster response', Category: 'Disaster', 'Data use': '2023', Provider: 'NASA', Platform: 'Terra; Aqua', Resolution: resolutionsList[Math.floor(Math.random() * resolutionsList.length)], Representation: 'Thermal', Viz: 'Heat maps', },
        { Date: '2024-06-12', Title: 'Infrastructure Development in Dubai', Link: 'http://example.com/dubai-infra', Outlet: 'BBC', Country: 'Middle East', Context: 'Urban planning', Category: 'Urbanization', 'Data use': '2022; 2024', Provider: 'Maxar; Airbus', Platform: 'WorldView-3; Pleiades', Resolution: resolutionsList[Math.floor(Math.random() * resolutionsList.length)], Representation: 'Optical; SAR', Viz: '3D models', },
        { Date: '2023-09-20', Title: 'Agricultural Land Use Change in France', Link: 'http://example.com/france-agriculture', Outlet: 'Reuters', Country: 'France', Context: 'Agricultural policy', Category: 'Agriculture', 'Data use': '2021; 2023', Provider: 'ESA', Platform: 'Sentinel-2', Resolution: resolutionsList[Math.floor(Math.random() * resolutionsList.length)], Representation: 'Optical', Viz: 'Land cover maps', },
        { Date: '2024-01-01', Title: 'Displacement in Gaza Strip', Link: 'http://example.com/gaza-displacement', Outlet: 'Al Jazeera', Country: 'Gaza Strip', Context: 'Conflict & Humanitarian', Category: 'Conflict', 'Data use': '2023-2024', Provider: 'UNOSAT; Maxar', Platform: 'WorldView-2; Pleiades', Resolution: '<1m', Representation: 'Optical', Viz: 'Damage Assessment', },
        { Date: '2023-10-26', Title: 'War in Ukraine - Infrastructure Damage', Link: 'http://example.com/ukraine-damage', Outlet: 'CNN', Country: 'Ukraine', Context: 'Conflict', Category: 'Conflict', 'Data use': '2022-2023', Provider: 'Maxar', Platform: 'WorldView-3', Resolution: '<1m', Representation: 'Optical', Viz: 'Before/After Comparison', },
        { Date: '2024-02-14', Title: 'North Korea Missile Sites', Link: 'http://example.com/nk-missile', Outlet: 'Reuters', Country: 'North Korea', Context: 'National Security', Category: 'Security', 'Data use': '2024', Provider: 'USGS', Platform: 'Landsat 8', Resolution: '>10m', Representation: 'Optical', Viz: 'Satellite Imagery', },
        { Date: 'PENDING', Title: 'Future Research on Climate Models', Link: 'http://example.com/pending-climate', Outlet: 'PENDING', Country: 'PENDING', Context: 'PENDING', Category: 'Climate', 'Data use': 'PENDING', Provider: 'PENDING', Platform: 'PENDING', Resolution: 'PENDING', Representation: 'PENDING', Viz: 'PENDING', },
        { Date: '2025-01-01', Title: 'New Satellite Launch Analysis', Link: 'http://example.com/new-launch', Outlet: 'Space News', Country: 'United States', Context: 'Space Industry', Category: 'Technology', 'Data use': '2025', Provider: 'PENDING', Platform: 'PENDING', Resolution: 'PENDING', Representation: 'PENDING', Viz: 'PENDING', },
        { Date: '2024-07-20', Title: 'Urban Heat Island Effect Study', Link: 'http://example.com/urban-heat', Outlet: 'Science Daily', Country: 'Germany', Context: 'Environmental Science', Category: 'Environment', 'Data use': '2024', Provider: 'ESA', Platform: 'Sentinel-3', Resolution: '>10m', Representation: 'Thermal', Viz: 'Heat Maps', },
        { Date: '2024-08-01', Title: 'Migration Patterns in Europe', Link: 'http://example.com/migration-europe', Outlet: 'The Guardian', Country: 'Europe', Context: 'Social Studies', Category: 'Social', 'Data use': '2023-2024', Provider: 'PENDING', Platform: 'PENDING', Resolution: 'PENDING', Representation: 'PENDING', Viz: 'PENDING', },
        { Date: '2024-08-15', Title: 'Arctic Shipping Routes', Link: 'http://example.com/arctic-shipping', Outlet: 'Maritime News', Country: 'Arctic', Context: 'Commerce', Category: 'Commerce', 'Data use': '2024', Provider: 'PENDING', Platform: 'PENDING', Resolution: 'PENDING', Representation: 'PENDING', Viz: 'PENDING', },
        { Date: '2024-09-01', Title: 'Volcanic Activity Monitoring', Link: 'http://example.com/volcano-monitor', Outlet: 'Geology Today', Country: 'Japan', Context: 'Natural Hazards', Category: 'Disaster', 'Data use': '2024', Provider: 'PENDING', Platform: 'PENDING', Resolution: 'PENDING', Representation: 'PENDING', Viz: 'PENDING', },
        { Date: '2024-09-10', Title: 'Desertification in Africa', Link: 'http://example.com/desertification-africa', Outlet: 'Environmental Journal', Country: 'Sudan', Context: 'Environmental Degradation', Category: 'Environment', 'Data use': '2023-2024', Provider: 'PENDING', Platform: 'PENDING', Resolution: 'PENDING', Representation: 'PENDING', Viz: 'PENDING', },
        { Date: '2024-09-20', Title: 'New Dam Construction in Asia', Link: 'http://example.com/dam-asia', Outlet: 'Engineering Weekly', Country: 'China', Context: 'Infrastructure', Category: 'Infrastructure', 'Data use': '2024', Provider: 'PENDING', Platform: 'PENDING', Resolution: 'PENDING', Representation: 'PENDING', Viz: 'PENDING', },
      ];

      allData = sampleData.map(row => {
        const date = row.Date || '';
        const publicationYear = date && date !== 'PENDING' ? new Date(date).getFullYear() : null; // Handle PENDING for publicationYear
        const providers = row.Provider ? row.Provider.split(/[,;]/).map(p => p.trim()).filter(p => p) : [''];
        const resolutions = row.Resolution ? row.Resolution.split(/[,;]/).map(r => r.trim()).filter(r => r) : [''];
        const platforms = row.Platform ? row.Platform.split(/[,;]/).map(p => p.trim()).filter(p => p) : [''];
        const representations = row.Representation ? row.Representation.split(/[,;]/).map(r => r.trim()).filter(r => r) : [''];
        const vizs = row.Viz ? row.Viz.split(/[,;]/).map(v => v.trim()).filter(v => v) : [''];
        const dataUseYears = extractYears(row['Data use'] || '');
        if (dataUseYears.length === 0 && row['Data use'] !== 'PENDING') dataUseYears.push(''); // Exclude PENDING from dataUseYears if it's the only value

        let combinedDataPoints = [];
        const hasProviderData = providers.some(p => p !== '' && p !== 'PENDING') || resolutions.some(r => r !== '' && r !== 'PENDING') || platforms.some(p => p !== '' && p !== 'PENDING') || representations.some(r => r !== '' && r !== 'PENDING') || vizs.some(v => v !== '' && v !== 'PENDING');

        if (!hasProviderData && dataUseYears.length > 0) {
            dataUseYears.forEach(year => {
                combinedDataPoints.push({ dataUseYear: year, provider: '', platform: '', resolution: '', resolutionCategory: '', representation: '', viz: '' });
            });
        } else if (hasProviderData) {
            dataUseYears.forEach(year => {
                const currentMaxLength = Math.max(providers.length, resolutions.length, platforms.length, representations.length, vizs.length);
                for (let i = 0; i < currentMaxLength; i++) {
                    combinedDataPoints.push({
                        dataUseYear: (year === 'PENDING' ? '' : year), // Exclude PENDING from dataUseYear if it's explicitly 'PENDING'
                        provider: (providers[i] || providers[0] || ''),
                        platform: (platforms[i] || platforms[0] || ''),
                        resolution: (resolutions[i] || resolutions[0] || ''),
                        resolutionCategory: getMeterCategory(resolutions[i] || resolutions[0] || ''),
                        representation: (representations[i] || representations[0] || ''),
                        viz: (vizs[i] || vizs[0] || '')
                    });
                }
            });
        } else {
             // Handle cases where all fields might be PENDING or empty
            combinedDataPoints.push({
                dataUseYear: '',
                provider: '',
                platform: '',
                resolution: '',
                resolutionCategory: '',
                viz: '',
                representation: ''
            });
        }

        return {
          date: row.Date || '',
          publicationYear: publicationYear,
          title: row.Title || '',
          link: row.Link || '',
          outlet: row.Outlet || '',
          country: row.Country || '',
          region: countryRegions[row.Country] || '',
          context: row.Context || '',
          category: row.Category || '',
          combinedDataPoints: combinedDataPoints,
          isPending: Object.values(row).some(value => typeof value === 'string' && value.toUpperCase().includes('PENDING'))
        };
      });
      initializeFilters();
      filterTable();
      loadingStatus.style.display = 'none';
      statsDisplay.style.display = 'block';
    }


    function initializeFilters() {
      const uniqueRegions = new Set();
      const uniqueFocuses = new Set();
      const uniqueMeters = new Set();
      const uniqueYears = new Set();
      const uniqueVizs = new Set();
      const uniqueOutlets = new Set();
      const uniqueProviders = new Set();
      const uniqueRepresentations = new Set();

      allData.forEach(item => {
        // Exclude 'PENDING' from being added to filter options
        if (item.region && item.region.toUpperCase() !== 'PENDING') uniqueRegions.add(item.region);
        if (item.country && item.country.toUpperCase() !== 'PENDING') uniqueFocuses.add(item.country);
        if (item.outlet && item.outlet.toUpperCase() !== 'PENDING') uniqueOutlets.add(item.outlet);
        if (item.combinedDataPoints) {
            item.combinedDataPoints.forEach(cdp => {
                if (cdp.resolutionCategory && cdp.resolutionCategory.toUpperCase() !== 'PENDING') uniqueMeters.add(cdp.resolutionCategory);
                if (cdp.dataUseYear && cdp.dataUseYear.toUpperCase() !== 'PENDING') uniqueYears.add(cdp.dataUseYear);
                if (cdp.viz && cdp.viz.toUpperCase() !== 'PENDING') uniqueVizs.add(cdp.viz);
                if (cdp.provider && cdp.provider.toUpperCase() !== 'PENDING') uniqueProviders.add(cdp.provider);
                if (cdp.representation && cdp.representation.toUpperCase() !== 'PENDING') uniqueRepresentations.add(cdp.representation);
            });
        }
      });

      populateFilterPills('region-filter-pills', Array.from(uniqueRegions).sort());
      populateFilterPills('focus-filter-pills', Array.from(uniqueFocuses).sort());
      populateFilterPills('meters-filter-pills', Array.from(uniqueMeters).sort((a, b) => {
          const order = {'<1m': 1, '1-10m': 2, '>10m': 3};
          return (order[a] || 99) - (order[b] || 99);
      }));
      populateFilterPills('years-filter-pills', Array.from(uniqueYears).sort());
      populateFilterPills('viz-filter-pills', Array.from(uniqueVizs).sort());
      populateFilterPills('outlet-filter-pills', Array.from(uniqueOutlets).sort());
      populateFilterPills('provider-filter-pills', Array.from(uniqueProviders).sort());
      populateFilterPills('representation-filter-pills', Array.from(uniqueRepresentations).sort());
    }

    function populateFilterPills(containerId, items) {
      const container = document.getElementById(containerId);
      // Remove all existing pills except the "All" button
      Array.from(container.children).forEach(child => {
          if (child.dataset.value !== 'all') {
              container.removeChild(child);
          }
      });

      items.forEach(item => {
        const button = document.createElement('button');
        button.classList.add('pill');
        button.dataset.type = containerId.replace('-filter-pills', '');
        button.dataset.value = item;
        button.textContent = item;
        button.addEventListener('click', handlePillClick);
        container.appendChild(button);
      });
    }

    function handlePillClick(event) {
      const clickedPill = event.target;
      const type = clickedPill.dataset.type;
      const value = clickedPill.dataset.value;
      const parentContainer = clickedPill.closest('.filter-pills');

      // Clear previous active pills for this filter type, unless it's the "All" button
      if (value === 'all') {
          parentContainer.querySelectorAll('.pill').forEach(pill => {
              pill.classList.remove('active');
          });
          clickedPill.classList.add('active');
          // Clear year inputs if "All" is selected for publicationYear
          if (type === 'publicationYear') {
              document.getElementById('fromYearInput').value = '';
              document.getElementById('toYearInput').value = '';
          }
      } else {
          // If a specific pill is clicked, deactivate the "All" pill if it's active
          const allPill = parentContainer.querySelector('.pill[data-value="all"]');
          if (allPill) {
              allPill.classList.remove('active');
          }
          clickedPill.classList.toggle('active');
      }
      filterTable();
    }


    function filterTable() {
        let filteredData = allData;

        const activeFilters = {};
        document.querySelectorAll('.filter-pills').forEach(container => {
            const type = container.id.replace('-filter-pills', '');
            if (type === 'publicationYear') return; // Handled separately
            const selectedPills = Array.from(container.querySelectorAll('.pill.active'))
                                   .map(pill => pill.dataset.value)
                                   .filter(value => value !== 'all');
            if (selectedPills.length > 0) {
                activeFilters[type] = selectedPills;
            }
        });

        const fromYear = document.getElementById('fromYearInput').value;
        const toYear = document.getElementById('toYearInput').value;

        // Apply filters
        if (filtersActive) {
            filteredData = allData.filter(item => {
                // Items with isPending should always pass the filter to be displayed, but not count towards filter logic
                if (item.isPending) {
                    return true;
                }

                let pass = true;

                // Publication Year Filter
                if (item.publicationYear === null || (fromYear && item.publicationYear < parseInt(fromYear)) ||
                    (toYear && item.publicationYear > parseInt(toYear))) {
                    pass = false;
                }

                // General filters (Region, Focus, Outlet, Meters, Years, Viz, Provider, Representation)
                for (const type in activeFilters) {
                    if (activeFilters[type].length > 0) {
                        if (type === 'region') {
                            if (!activeFilters[type].includes(item.region)) {
                                pass = false;
                            }
                        } else if (type === 'focus') {
                            if (!activeFilters[type].includes(item.country)) {
                                pass = false;
                            }
                        } else if (type === 'outlet') {
                            if (!activeFilters[type].includes(item.outlet)) {
                                pass = false;
                            }
                        } else {
                            // For combinedDataPoints related filters (resolutionCategory, years, viz, provider, representation)
                            const matchingCdp = item.combinedDataPoints.some(cdp => {
                                let cdpPass = true;
                                if (type === 'meters') {
                                    if (!activeFilters[type].includes(cdp.resolutionCategory)) cdpPass = false;
                                } else if (type === 'years') {
                                    // Check if any year in the item's dataUseYears matches any selected year filter
                                    if (!activeFilters[type].some(filterYear => cdp.dataUseYear.includes(filterYear))) cdpPass = false;
                                } else if (type === 'viz') {
                                    if (!activeFilters[type].includes(cdp.viz)) cdpPass = false;
                                } else if (type === 'provider') {
                                    if (!activeFilters[type].includes(cdp.provider)) cdpPass = false;
                                } else if (type === 'representation') {
                                    if (!activeFilters[type].includes(cdp.representation)) cdpPass = false;
                                }
                                return cdpPass;
                            });
                            if (!matchingCdp) pass = false;
                        }
                    }
                }
                return pass;
            });
        }

        // Separate pending items for display, without counting them in filteredCount for active filters.
        const pendingItems = allData.filter(item => item.isPending);
        // Filter out pending items from the `filteredData` if `filtersActive` is true
        // This ensures pending items don't affect the count of actually filtered items
        const nonPendingFilteredData = filteredData.filter(item => !item.isPending);

        // Concatenate the filtered non-pending items with all pending items for display
        // Ensure pending items appear at the very end of the table/feed
        const finalDisplayedData = [...nonPendingFilteredData, ...pendingItems];

        updateFilterCount(nonPendingFilteredData.length); // Count only non-pending items for filtering stats
        if (currentView === 'table') {
            renderTable(finalDisplayedData);
        } else {
            renderFeed(finalDisplayedData);
        }
    }


    function renderTable(dataToRender) {
      const tbody = document.querySelector('#tableViewContainer tbody');
      tbody.innerHTML = ''; // Clear existing rows

      dataToRender.forEach(item => {
        const numDataPoints = item.combinedDataPoints.length > 0 ? item.combinedDataPoints.length : 1; // At least 1 row for articles with no data points

        if (!item.combinedDataPoints || item.combinedDataPoints.length === 0) {
            // Case: Article has no data points
            const row = tbody.insertRow();
            row.classList.add('article-start', 'last-cdp-of-article');
            insertArticleCells(row, item, numDataPoints); // Pass numDataPoints for rowspan
            insertDataDetailCells(row, { dataUseYear: '', provider: '', platform: '', sensor: '', resolution: '', viz: '', representation: '' });
        } else {
            item.combinedDataPoints.forEach((cdp, index) => {
                const row = tbody.insertRow();
                const isFirstCdp = index === 0;
                const isLastCdp = index === item.combinedDataPoints.length - 1;

                if (isFirstCdp) {
                    row.classList.add('article-start');
                    insertArticleCells(row, item, numDataPoints); // Pass numDataPoints for rowspan
                }
                if (isLastCdp) {
                    row.classList.add('last-cdp-of-article');
                }

                insertDataDetailCells(row, cdp);
            });
        }
      });
    }

    function insertArticleCells(row, item, rowspanCount) {
        const cells = ['date', 'title', 'link', 'outlet', 'country', 'context', 'category'];
        cells.forEach(key => {
            const cell = row.insertCell();
            cell.rowSpan = rowspanCount; // Apply rowspan here
            
            if (key === 'link') {
                if (item.link && item.link.toUpperCase() !== 'PENDING') {
                    const linkElement = document.createElement('a');
                    linkElement.href = item.link;
                    linkElement.textContent = 'Link';
                    linkElement.target = '_blank';
                    cell.appendChild(linkElement);
                } else {
                    cell.textContent = item.link;
                    if (item.link === 'PENDING') {
                        cell.classList.add('pending-status');
                    }
                }
            } else {
                let content = item[key];
                if (content.toUpperCase().includes('PENDING')) {
                    cell.classList.add('pending-status');
                }
                cell.textContent = content;
            }
        });
    }

    function insertDataDetailCells(row, cdp) {
        const dataDetailCells = ['dataUseYear', 'provider', 'platform', 'sensor', 'resolution', 'representation', 'viz']; // Added 'sensor' based on headers
        dataDetailCells.forEach(key => {
            const cell = row.insertCell();
            cell.classList.add('data-detail-cell');
            let content = cdp[key] || '';
            // For resolution, use the original resolution field if available, otherwise resolutionCategory
            if (key === 'resolution') {
                content = cdp.resolution || cdp.resolutionCategory || '';
            }

            if (content.toUpperCase().includes('PENDING')) {
                cell.classList.add('pending-status');
            }
            cell.textContent = content;
        });
    }


    function renderFeed(dataToRender) {
      const feedViewContainer = document.getElementById('feedViewContainer');
      feedViewContainer.innerHTML = ''; // Clear existing feed items

      dataToRender.forEach(item => {
        const articleItem = document.createElement('div');
        articleItem.classList.add('article-item');

        const titleText = item.title;
        const linkHref = item.link;

        // Check if title or link is PENDING
        const isTitlePending = titleText.toUpperCase().includes('PENDING');
        const isLinkPending = linkHref.toUpperCase().includes('PENDING');

        // Create the title element
        const titleElement = document.createElement('span');
        titleElement.textContent = titleText;
        if (isTitlePending) {
            titleElement.classList.add('pending-status');
        }

        // Create the link wrapper (<a> tag)
        const linkWrapper = document.createElement('a');
        linkWrapper.href = isLinkPending ? '#' : linkHref; // If PENDING, link to # or prevent navigation
        linkWrapper.target = '_blank'; // Open in new tab
        if (isLinkPending) {
            linkWrapper.classList.add('pending-status'); // Apply color to the link
            linkWrapper.style.pointerEvents = 'none'; // Make link unclickable
        }
        linkWrapper.appendChild(titleElement); // Nest title span inside the link

        articleItem.appendChild(linkWrapper);

        // Details
        const details = document.createElement('div');
        details.classList.add('article-details');
        let detailsContent = '';

        if (item.date && item.date.toUpperCase() !== 'PENDING') {
            detailsContent += item.date;
        } else if (item.date.toUpperCase() === 'PENDING') {
            detailsContent += '<span class="pending-status">PENDING</span>';
        }

        if (item.outlet && item.outlet.toUpperCase() !== 'PENDING') {
            if (detailsContent) detailsContent += ' • ';
            detailsContent += item.outlet;
        } else if (item.outlet.toUpperCase() === 'PENDING') {
            if (detailsContent) detailsContent += ' • ';
            detailsContent += '<span class="pending-status">PENDING</span>';
        }

        if (item.country && item.country.toUpperCase() !== 'PENDING') {
            if (detailsContent) detailsContent += ' • ';
            detailsContent += item.country;
        } else if (item.country.toUpperCase() === 'PENDING') {
            if (detailsContent) detailsContent += ' • ';
            detailsContent += '<span class="pending-status">PENDING</span>';
        }

        if (item.category && item.category.toUpperCase() !== 'PENDING') {
            if (detailsContent) detailsContent += ' • ';
            detailsContent += item.category;
        } else if (item.category.toUpperCase() === 'PENDING') {
            if (detailsContent) detailsContent += ' • ';
            detailsContent += '<span class="pending-status">PENDING</span>';
        }

        details.innerHTML = detailsContent;
        articleItem.appendChild(details);

        feedViewContainer.appendChild(articleItem);
      });
    }


    function updateView() {
      const tableViewContainer = document.getElementById('tableViewContainer');
      const feedViewContainer = document.getElementById('feedViewContainer');

      // Re-filter and re-render the data based on current filters and view
      const dataToRender = allData.filter(item => filterItem(item));

      if (currentView === 'table') {
        tableViewContainer.classList.remove('hidden');
        feedViewContainer.classList.add('hidden');
        renderTable(dataToRender);
      } else { // currentView === 'feed'
        tableViewContainer.classList.add('hidden');
        feedViewContainer.classList.remove('hidden');
        renderFeed(dataToRender);
      }
      adjustContentViewHeight();
    }

    function filterItem(item) {
        // PENDING items are always displayed, so they should always pass this filter,
        // but their content should not be used for actual filter logic.
        if (item.isPending) {
            return true;
        }

        if (!filtersActive) {
            return true; // If filters are not active, all non-pending items are displayed
        }

        const fromYear = document.getElementById('fromYearInput').value;
        const toYear = document.getElementById('toYearInput').value;

        // Publication Year Filter
        if (item.publicationYear === null || (fromYear && item.publicationYear < parseInt(fromYear)) ||
            (toYear && item.publicationYear > parseInt(toYear))) {
            return false;
        }

        const activeFilters = {};
        document.querySelectorAll('.filter-pills').forEach(container => {
            const type = container.id.replace('-filter-pills', '');
            if (type === 'publicationYear') return;
            const selectedPills = Array.from(container.querySelectorAll('.pill.active'))
                                   .map(pill => pill.dataset.value)
                                   .filter(value => value !== 'all');
            if (selectedPills.length > 0) {
                activeFilters[type] = selectedPills;
            }
        });

        for (const type in activeFilters) {
            if (activeFilters[type].length > 0) {
                if (type === 'region') {
                    if (!activeFilters[type].includes(item.region)) return false;
                } else if (type === 'focus') {
                    if (!activeFilters[type].includes(item.country)) return false;
                } else if (type === 'outlet') {
                    if (!activeFilters[type].includes(item.outlet)) return false;
                } else {
                    const matchingCdp = item.combinedDataPoints.some(cdp => {
                        let cdpMatches = true;
                        if (type === 'meters' && !activeFilters[type].includes(cdp.resolutionCategory)) cdpMatches = false;
                        if (type === 'years' && !activeFilters[type].some(filterYear => cdp.dataUseYear.includes(filterYear))) cdpMatches = false;
                        if (type === 'viz' && !activeFilters[type].includes(cdp.viz)) cdpMatches = false;
                        if (type === 'provider' && !activeFilters[type].includes(cdp.provider)) cdpMatches = false;
                        if (type === 'representation' && !activeFilters[type].includes(cdp.representation)) cdpMatches = false;
                        return cdpMatches;
                    });
                    if (!matchingCdp) return false;
                }
            }
        }
        return true;
    }


    function toggleAllFilters(open) {
      document.querySelectorAll('.filter-group').forEach(group => {
        if (open) {
          group.classList.add('active');
        } else {
          group.classList.remove('active');
        }
      });
      adjustContentViewHeight();
    }

    function updateFilterCount(filteredCount) {
      const totalCount = allData.length;
      const statsDisplay = document.getElementById('statsDisplay');
      if (statsDisplay) {
        // Determine if any filters are actively narrowing down the literature data
        const hasActiveFilters = document.querySelectorAll('.filter-pills .pill.active:not([data-value=\"all\"])').length > 0 ||
                                 document.getElementById('fromYearInput').value !== '' ||
                                 document.getElementById('toYearInput').value !== '';

        // Add a class for the span that will contain the numbers
        const numberSpanClass = 'article-count-number';

        if (currentView === 'table' || currentView === 'feed') { // Apply to both table and feed views
            if (hasActiveFilters && filtersActive) {
                // Now using the CSS class for spacing instead of inline style
                statsDisplay.innerHTML = `Articles:<span class=\"${numberSpanClass}\">${filteredCount}</span><sup style=\"font-size: 0.5em; vertical-align: super; color: lightgrey;\">/<span class=\"${numberSpanClass}\">${totalCount}</span></sup>`;
            } else {
                // Now using the CSS class for spacing instead of inline style
                statsDisplay.innerHTML = `Articles:<span class=\"${numberSpanClass}\">${totalCount}</span>`;
            }
        }
      }
    }
  </script>
</body>
</html>
