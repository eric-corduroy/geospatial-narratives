<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Geospatial Narratives</title>
  <style>
    body {
      font-family: Helvetica, Arial, sans-serif;
      background: #f2f2f2;
      margin: 0;
      padding: 0;
    }
    .title {
      text-align: left;
      font-size: 20px;
      font-weight: medium;
      color: #000;
      padding: 20px 0 10px 40px;
      background: #f2f2f2;
    }
    .nav {
      display: flex;
      justify-content: flex-start;
      align-items: center;
      padding: 0 40px 20px 20px;
      font-size: 64px;
      font-weight: bold;
      color: #000;
      gap: 10px;
      background: #f2f2f2;
    }
    .nav a {
      font-size: 64px;
      text-decoration: none;
      color: #000;
      border-bottom: 4px solid transparent;
      padding: 10px 20px;
    }
    .nav a:hover {
      border-bottom: 4px solid #000;
    }
    .csv-upload {
      display: none;
    }
    .stats {
      font-size: 24px;
      padding: 20px 40px;
      background: #f2f2f2;
    }
    .filter-container {
      padding: 20px 40px;
      background: #f2f2f2;
    }
    .filter-title {
      font-size: 18px;
      font-weight: bold;
      margin-bottom: 10px;
    }
    .filter-pills {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
    }
    .pill {
      padding: 8px 16px;
      border-radius: 30px;
      border: 1px solid #999;
      background: white;
      cursor: pointer;
      font-size: 14px;
      transition: all 0.2s ease;
    }
    .pill:hover {
      background: #e6e6e6;
    }
    .pill.active {
      background: #0066cc;
      color: white;
      border-color: #0066cc;
    }
    .table-container {
      margin: 0;
      height: calc(100vh - 300px);
      overflow-y: auto;
      position: relative;
      background: #f2f2f2;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      background: #fff;
    }
    th, td {
      text-align: left;
      padding: 8px 12px;
      border-bottom: 1px solid #999;
      font-family: monospace;
      vertical-align: top;
    }
    thead {
      position: sticky;
      top: 0;
      z-index: 10;
    }
    th {
      background: #ccc;
    }
    a {
      color: blue;
      text-decoration: none;
      border-bottom: 1px solid blue;
    }
    .month {
      color: gray;
    }
    .provider-item {
      display: block;
      margin-bottom: 4px;
      padding-bottom: 4px;
    }
    .provider-item:not(:last-child) {
      border-bottom: 1px solid #ddd;
    }
    .provider-resolution-group {
      font-size: 12px;
      line-height: 1.4;
    }
  </style>
</head>
<body>
  <div class="title">Geospatial Narratives</div>
  <div class="nav">
    <a href="index.html">Index</a>
    <a href="about.html">About</a>
  </div>
  
  <div class="stats">
    <span id="loadingStatus">Loading data...</span>
    <div id="statsDisplay" style="display: none;">Filtered: 0<br>Total: 0</div>
  </div>
  
  <div class="filter-container">
    <div class="filter-title">Filter by outlet:</div>
    <div class="filter-pills">
      <button class="pill active" data-type="outlet" data-value="all">All</button>
      <button class="pill" data-type="outlet" data-value="The New York Times">The New York Times</button>
      <button class="pill" data-type="outlet" data-value="Washington Post">Washington Post</button>
      <button class="pill" data-type="outlet" data-value="The Guardian">The Guardian</button>
      <button class="pill" data-type="outlet" data-value="BBC">BBC</button>
      <button class="pill" data-type="outlet" data-value="CNN">CNN</button>
      <button class="pill" data-type="outlet" data-value="Reuters">Reuters</button>
    </div>
    
    <div class="filter-title" style="margin-top: 15px;">Filter by provider:</div>
    <div class="filter-pills">
      <button class="pill active" data-type="provider" data-value="all">All</button>
      <button class="pill" data-type="provider" data-value="Planet Labs">Planet Labs</button>
      <button class="pill" data-type="provider" data-value="Maxar">Maxar</button>
    </div>
  </div>
  
  <div class="table-container">
    <table>
      <thead>
        <tr>
          <th>Date</th>
          <th>MM</th>
          <th>Title (Original)</th>
          <th>Source</th>
          <th>Feed</th>
          <th>Outlet</th>
          <th>Focus</th>
          <th>Context</th>
          <th>Category</th>
          <th>Data use</th>
          <th>Provider</th>
          <th>meters</th>
          <th>Representation</th>
          <th>Interaction</th>
          <th>Viz</th>
          <th>Platform</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td>2023 10 30</td>
          <td class="month">Oct</td>
          <td>A Detailed Satellite View of Israel's Invasion</td>
          <td><a href="#">Link</a></td>
          <td></td>
          <td>The New York Times</td>
          <td>Gaza Strip</td>
          <td>Gaza War</td>
          <td>Armed Conflict</td>
          <td></td>
          <td>Planet Labs</td>
          <td>Single, Compari-</td>
          <td>-</td>
          <td>RGB</td>
          <td></td>
          <td>SkySat</td>
        </tr>
        <tr>
          <td>2023 10 28</td>
          <td class="month">Oct</td>
          <td>Mapping the Destruction in Gaza</td>
          <td><a href="#">Link</a></td>
          <td></td>
          <td>Washington Post</td>
          <td>Gaza Strip</td>
          <td>Gaza War</td>
          <td>Armed Conflict</td>
          <td></td>
          <td>Maxar</td>
          <td>Single, Compari-</td>
          <td>-</td>
          <td>RGB</td>
          <td></td>
          <td>WorldView</td>
        </tr>
        <tr>
          <td>2023 11 05</td>
          <td class="month">Nov</td>
          <td>Satellite Images Reveal Scale of Damage</td>
          <td><a href="#">Link</a></td>
          <td></td>
          <td>BBC</td>
          <td>Gaza Strip</td>
          <td>Gaza War</td>
          <td>Armed Conflict</td>
          <td></td>
          <td>Planet Labs</td>
          <td>Single, Compari-</td>
          <td>-</td>
          <td>RGB</td>
          <td></td>
          <td>SkySat</td>
        </tr>
        <tr>
          <td>2023 11 10</td>
          <td class="month">Nov</td>
          <td>Before and After: Destruction in Northern Gaza</td>
          <td><a href="#">Link</a></td>
          <td></td>
          <td>The Guardian</td>
          <td>Gaza Strip</td>
          <td>Gaza War</td>
          <td>Armed Conflict</td>
          <td></td>
          <td>Planet Labs</td>
          <td>Single, Compari-</td>
          <td>-</td>
          <td>RGB</td>
          <td></td>
          <td>SkySat</td>
        </tr>
        <tr>
          <td>2023 11 15</td>
          <td class="month">Nov</td>
          <td>Satellite Imagery Shows Hospital Complex Damage</td>
          <td><a href="#">Link</a></td>
          <td></td>
          <td>CNN</td>
          <td>Gaza Strip</td>
          <td>Gaza War</td>
          <td>Armed Conflict</td>
          <td></td>
          <td>Maxar</td>
          <td>Single, Compari-</td>
          <td>-</td>
          <td>RGB</td>
          <td></td>
          <td>WorldView</td>
        </tr>
        <tr>
          <td>2023 11 20</td>
          <td class="month">Nov</td>
          <td>War-Torn Gaza: A View From Above</td>
          <td><a href="#">Link</a></td>
          <td></td>
          <td>Reuters</td>
          <td>Gaza Strip</td>
          <td>Gaza War</td>
          <td>Armed Conflict</td>
          <td></td>
          <td>Planet Labs</td>
          <td>Single, Compari-</td>
          <td>-</td>
          <td>RGB</td>
          <td></td>
          <td>SkySat</td>
        </tr>
        <tr>
          <td>2023 12 01</td>
          <td class="month">Dec</td>
          <td>Humanitarian Crisis: Tracking Aid Routes</td>
          <td><a href="#">Link</a></td>
          <td></td>
          <td>The New York Times</td>
          <td>Gaza Strip</td>
          <td>Gaza War</td>
          <td>Armed Conflict</td>
          <td></td>
          <td>Planet Labs</td>
          <td>Single, Compari-</td>
          <td>-</td>
          <td>RGB</td>
          <td></td>
          <td>SkySat</td>
        </tr>
        <tr>
          <td>2023 12 10</td>
          <td class="month">Dec</td>
          <td>Analysis of Urban Damage in Gaza City</td>
          <td><a href="#">Link</a></td>
          <td></td>
          <td>Washington Post</td>
          <td>Gaza Strip</td>
          <td>Gaza War</td>
          <td>Armed Conflict</td>
          <td></td>
          <td>Maxar</td>
          <td>Single, Compari-</td>
          <td>-</td>
          <td>RGB</td>
          <td></td>
          <td>WorldView</td>
        </tr>
        <tr>
          <td>2023 12 15</td>
          <td class="month">Dec</td>
          <td>Displacement Camps: Aerial View</td>
          <td><a href="#">Link</a></td>
          <td></td>
          <td>BBC</td>
          <td>Gaza Strip</td>
          <td>Gaza War</td>
          <td>Armed Conflict</td>
          <td></td>
          <td>Planet Labs</td>
          <td>Single, Compari-</td>
          <td>-</td>
          <td>RGB</td>
          <td></td>
          <td>SkySat</td>
        </tr>
        <tr>
          <td>2024 01 05</td>
          <td class="month">Jan</td>
          <td>Three Months of Conflict: Before and After</td>
          <td><a href="#">Link</a></td>
          <td></td>
          <td>The Guardian</td>
          <td>Gaza Strip</td>
          <td>Gaza War</td>
          <td>Armed Conflict</td>
          <td></td>
          <td>Planet Labs</td>
          <td>Single, Compari-</td>
          <td>-</td>
          <td>RGB</td>
          <td></td>
          <td>SkySat</td>
        </tr>
        <tr>
          <td>2024 01 12</td>
          <td class="month">Jan</td>
          <td>Satellite Analysis: Southern Gaza Operations</td>
          <td><a href="#">Link</a></td>
          <td></td>
          <td>CNN</td>
          <td>Gaza Strip</td>
          <td>Gaza War</td>
          <td>Armed Conflict</td>
          <td></td>
          <td>Maxar</td>
          <td>Single, Compari-</td>
          <td>-</td>
          <td>RGB</td>
          <td></td>
          <td>WorldView</td>
        </tr>
      </tbody>
    </table>
  </div>
  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
  <script>
    let allData = []; // Store all data for filtering
    
    document.addEventListener('DOMContentLoaded', function() {
      // Load data from backend
      loadDataFromBackend();
    });
    
    async function loadDataFromBackend() {
      const loadingStatus = document.getElementById('loadingStatus');
      const statsDisplay = document.getElementById('statsDisplay');
      
      try {
        loadingStatus.textContent = 'Loading data from server...';
        
        // Try to fetch from a CSV file in the same directory
        const response = await fetch('./data.csv');
        
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const csvText = await response.text();
        
        // Parse the CSV data
        Papa.parse(csvText, {
          header: true,
          skipEmptyLines: true,
          dynamicTyping: false,
          complete: function(results) {
            if (results.errors.length > 0) {
              console.warn('CSV parsing warnings:', results.errors);
            }
            
            // Process the CSV data - now handling provider/resolution pairs
            allData = results.data.map(row => {
              const providers = row.Provider ? row.Provider.split(/[,;]/).map(p => p.trim()).filter(p => p) : [];
              const resolutions = row.Resolution ? row.Resolution.split(/[,;]/).map(r => r.trim()).filter(r => r) : [];
              const platforms = row.Platform ? row.Platform.split(/[,;]/).map(p => p.trim()).filter(p => p) : [];
              
              // Create provider-resolution pairs
              let providerResolutionPairs = [];
              if (providers.length > 0) {
                providers.forEach((provider, index) => {
                  providerResolutionPairs.push({
                    provider: provider,
                    resolution: resolutions[index] || resolutions[0] || '',
                    platform: platforms[index] || platforms[0] || ''
                  });
                });
              } else {
                providerResolutionPairs.push({
                  provider: '',
                  resolution: resolutions[0] || '',
                  platform: platforms[0] || ''
                });
              }
              
              return {
                date: row.Date || '',
                mm: row.MM || '',
                title: row['Title (Original)'] || row.Title || '',
                source: row.Source || '',
                feed: row.Feed || '',
                outlet: row.Outlet || '',
                focus: row.Focus || '',
                context: row.Context || '',
                category: row.Category || '',
                dataUse: row['Data use'] || '',
                providerResolutionPairs: providerResolutionPairs,
                representation: row.Representation || '',
                interaction: row.Interaction || '',
                viz: row.Viz || '',
                // Keep original provider array for filtering
                provider: providers.length > 0 ? providers : ['']
              };
            });
            
            // Filter out empty rows
            allData = allData.filter(item => item.title || item.outlet);
            
            updateFilters();
            renderTable();
            updateFilterCount(allData.length);
            
            // Hide loading status and show stats
            loadingStatus.style.display = 'none';
            statsDisplay.style.display = 'block';
            
            console.log(`Loaded ${allData.length} records from backend`);
          },
          error: function(error) {
            throw new Error('CSV parsing error: ' + error.message);
          }
        });
        
      } catch (error) {
        console.error('Error loading data from backend:', error);
        
        // Fallback to sample data if backend fails
        loadingStatus.textContent = 'Backend unavailable, loading sample data...';
        setTimeout(() => {
          loadSampleData();
        }, 1000);
      }
    }
    
    function loadSampleData() {
      const loadingStatus = document.getElementById('loadingStatus');
      const statsDisplay = document.getElementById('statsDisplay');
      
      // Sample data as fallback
      allData = [
        {
          date: '2023-10-30',
          mm: 'Oct',
          title: 'Satellite images show Guantanamo Bay changes as Trump ramps up deportation plans',
          source: 'https://news.sky.com/story/guantanamo-bay-rapidly-readied-in-response-to-trump-deportation-plans-13304271',
          feed: '',
          outlet: 'Sky News',
          focus: 'Guantanamo Bay',
          context: 'Military Infrastructure',
          category: 'Government Policy',
          dataUse: '',
          provider: ['Planet Labs'],
          providerResolutionPairs: [
            { provider: 'Planet Labs', resolution: '<1m', platform: 'SkySat' }
          ],
          representation: 'Optical',
          interaction: 'RGB',
          viz: 'Interactive Map'
        },
        {
          date: '2023-10-28',
          mm: 'Oct',
          title: 'Mapping the Destruction in Gaza',
          source: 'https://washingtonpost.com/gaza-destruction',
          feed: '',
          outlet: 'Washington Post',
          focus: 'Gaza Strip',
          context: 'Gaza War',
          category: 'Armed Conflict',
          dataUse: 'Change Detection',
          provider: ['Maxar', 'Planet Labs'],
          providerResolutionPairs: [
            { provider: 'Maxar', resolution: '1-10m', platform: 'WorldView' },
            { provider: 'Planet Labs', resolution: '<1m', platform: 'SkySat' }
          ],
          representation: 'Optical',
          interaction: 'RGB',
          viz: 'Before/After Slider'
        },
        {
          date: '2023-11-05',
          mm: 'Nov',
          title: 'Satellite Images Reveal Scale of Damage in Northern Gaza',
          source: 'https://bbc.com/news/gaza-damage',
          feed: '',
          outlet: 'BBC',
          focus: 'Gaza Strip',
          context: 'Gaza War',
          category: 'Armed Conflict',
          dataUse: 'Damage Assessment',
          provider: ['Planet Labs'],
          providerResolutionPairs: [
            { provider: 'Planet Labs', resolution: '<1m', platform: 'SkySat' }
          ],
          representation: 'Optical',
          interaction: 'RGB',
          viz: 'Static Images'
        },
        {
          date: '2023-11-10',
          mm: 'Nov',
          title: 'Before and After: Destruction in Northern Gaza',
          source: 'https://theguardian.com/gaza-before-after',
          feed: '',
          outlet: 'The Guardian',
          focus: 'Gaza Strip',
          context: 'Gaza War',
          category: 'Armed Conflict',
          dataUse: 'Temporal Analysis',
          provider: ['Planet Labs', 'Maxar'],
          providerResolutionPairs: [
            { provider: 'Planet Labs', resolution: '<1m', platform: 'SkySat' },
            { provider: 'Maxar', resolution: '1-10m', platform: 'WorldView' }
          ],
          representation: 'Optical',
          interaction: 'RGB',
          viz: 'Interactive Comparison'
        },
        {
          date: '2023-11-15',
          mm: 'Nov',
          title: 'Satellite Imagery Shows Hospital Complex Damage',
          source: 'https://cnn.com/gaza-hospital',
          feed: '',
          outlet: 'CNN',
          focus: 'Gaza Strip',
          context: 'Gaza War',
          category: 'Armed Conflict',
          dataUse: 'Infrastructure Assessment',
          provider: ['Maxar'],
          providerResolutionPairs: [
            { provider: 'Maxar', resolution: '1-10m', platform: 'WorldView' }
          ],
          representation: 'Optical',
          interaction: 'RGB',
          viz: 'Annotated Images'
        },
        {
          date: '2023-11-20',
          mm: 'Nov',
          title: 'War-Torn Gaza: A View From Above',
          source: 'https://reuters.com/gaza-aerial',
          feed: '',
          outlet: 'Reuters',
          focus: 'Gaza Strip',
          context: 'Gaza War',
          category: 'Armed Conflict',
          dataUse: 'Comprehensive Survey',
          provider: ['Planet Labs'],
          providerResolutionPairs: [
            { provider: 'Planet Labs', resolution: '<1m', platform: 'SkySat' }
          ],
          representation: 'Optical',
          interaction: 'RGB',
          viz: 'Photo Gallery'
        }
      ];
      
      updateFilters();
      renderTable();
      updateFilterCount(allData.length);
      
      // Hide loading status and show stats
      loadingStatus.style.display = 'none';
      statsDisplay.style.display = 'block';
      
      console.log(`Loaded ${allData.length} sample records`);
    }
    
    function updateFilters() {
      // Get unique outlets and providers from data
      const outlets = [...new Set(allData.map(item => item.outlet).filter(o => o))];
      const providers = [...new Set(allData.flatMap(item => item.provider).filter(p => p))];
      
      // Update outlet filter pills
      const outletContainer = document.querySelector('.filter-pills');
      const outletPills = outletContainer.querySelectorAll('.pill[data-type="outlet"]:not([data-value="all"])');
      outletPills.forEach(pill => pill.remove());
      
      outlets.forEach(outlet => {
        const pill = document.createElement('button');
        pill.className = 'pill';
        pill.setAttribute('data-type', 'outlet');
        pill.setAttribute('data-value', outlet);
        pill.textContent = outlet;
        pill.addEventListener('click', handlePillClick);
        outletContainer.appendChild(pill);
      });
      
      // Update provider filter pills
      const providerContainer = document.querySelectorAll('.filter-pills')[1];
      const providerPills = providerContainer.querySelectorAll('.pill[data-type="provider"]:not([data-value="all"])');
      providerPills.forEach(pill => pill.remove());
      
      providers.forEach(provider => {
        const pill = document.createElement('button');
        pill.className = 'pill';
        pill.setAttribute('data-type', 'provider');
        pill.setAttribute('data-value', provider);
        pill.textContent = provider;
        pill.addEventListener('click', handlePillClick);
        providerContainer.appendChild(pill);
      });
    }
    
    function handlePillClick() {
      const filterType = this.getAttribute('data-type');
      const filterValue = this.getAttribute('data-value');
      
      if (filterValue === 'all') {
        document.querySelectorAll(`.pill[data-type="${filterType}"]`).forEach(p => {
          p.classList.remove('active');
        });
        this.classList.add('active');
      } else {
        document.querySelector(`.pill[data-type="${filterType}"][data-value="all"]`).classList.remove('active');
        this.classList.toggle('active');
        
        if (document.querySelectorAll(`.pill[data-type="${filterType}"].active`).length === 0) {
          document.querySelector(`.pill[data-type="${filterType}"][data-value="all"]`).classList.add('active');
        }
      }
      
      filterTable();
    }
    
    function renderTable() {
      const tbody = document.querySelector('tbody');
      tbody.innerHTML = '';
      
      allData.forEach(item => {
        const row = document.createElement('tr');
        
        // Create provider column with stacked entries
        let providerColumn = '';
        let metersColumn = '';
        let platformColumn = '';
        
        if (item.providerResolutionPairs && item.providerResolutionPairs.length > 0) {
          item.providerResolutionPairs.forEach((pair, index) => {
            if (index > 0) {
              providerColumn += '<div class="provider-item">';
              metersColumn += '<div class="provider-item">';
              platformColumn += '<div class="provider-item">';
            } else {
              providerColumn += '<div class="provider-item">';
              metersColumn += '<div class="provider-item">';
              platformColumn += '<div class="provider-item">';
            }
            
            providerColumn += `<span class="provider-resolution-group">${pair.provider}</span>`;
            metersColumn += `<span class="provider-resolution-group">${pair.resolution}</span>`;
            platformColumn += `<span class="provider-resolution-group">${pair.platform}</span>`;
            
            providerColumn += '</div>';
            metersColumn += '</div>';
            platformColumn += '</div>';
          });
        } else {
          // Fallback for items without provider pairs
          providerColumn = '<div class="provider-item"><span class="provider-resolution-group">' + (item.provider ? item.provider.join(', ') : '') + '</span></div>';
          metersColumn = '<div class="provider-item"><span class="provider-resolution-group">-</span></div>';
          platformColumn = '<div class="provider-item"><span class="provider-resolution-group">-</span></div>';
        }
        
        row.innerHTML = `
          <td>${item.date}</td>
          <td class="month">${item.mm}</td>
          <td>${item.title}</td>
          <td><a href="${item.source}" target="_blank">Link</a></td>
          <td>${item.feed}</td>
          <td>${item.outlet}</td>
          <td>${item.focus}</td>
          <td>${item.context}</td>
          <td>${item.category}</td>
          <td>${item.dataUse}</td>
          <td>${providerColumn}</td>
          <td>${metersColumn}</td>
          <td>${item.representation}</td>
          <td>${item.interaction}</td>
          <td>${item.viz}</td>
          <td>${platformColumn}</td>
        `;
        tbody.appendChild(row);
      });
    }
    
    function filterTable() {
      const rows = document.querySelectorAll('tbody tr');
      
      // Get outlet filters
      const outletPills = document.querySelectorAll('.pill[data-type="outlet"].active');
      const allOutletsActive = Array.from(outletPills).some(pill => pill.getAttribute('data-value') === 'all');
      const selectedOutlets = Array.from(outletPills)
        .map(pill => pill.getAttribute('data-value'))
        .filter(value => value !== 'all');
        
      // Get provider filters
      const providerPills = document.querySelectorAll('.pill[data-type="provider"].active');
      const allProvidersActive = Array.from(providerPills).some(pill => pill.getAttribute('data-value') === 'all');
      const selectedProviders = Array.from(providerPills)
        .map(pill => pill.getAttribute('data-value'))
        .filter(value => value !== 'all');
      
      // Count for visible rows
      let visibleCount = 0;
      
      // Filter rows using the data array for more accurate filtering
      allData.forEach((item, index) => {
        const outletMatch = allOutletsActive || selectedOutlets.includes(item.outlet);
        
        // Check if any of the item's providers match the selected providers
        const providerMatch = allProvidersActive || 
          item.provider.some(provider => selectedProviders.includes(provider));
        
        const row = rows[index];
        if (row && outletMatch && providerMatch) {
          row.style.display = '';
          visibleCount++;
        } else if (row) {
          row.style.display = 'none';
        }
      });
      
      // Update stats display with filtered count
      updateFilterCount(visibleCount);
    }
    
    function updateFilterCount(filteredCount) {
      const totalCount = allData.length;
      const statsDisplay = document.getElementById('statsDisplay');
      if (statsDisplay) {
        statsDisplay.innerHTML = `Filtered: ${filteredCount}<br>Total: ${totalCount}`;
      }
    }
  </script>
</body>
</html>