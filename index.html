<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Geospatial Narratives</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Geist&family=Geist+Mono&display=swap" rel="stylesheet">
  <style>
    /* Add box-sizing to all elements for consistent box model behavior */
    *, *::before, *::after {
      box-sizing: border-box;
    }

    body {
      font-family: 'Geist', sans-serif; /* Changed to Geist */
      background: #f2f2f2;
      margin: 0;
      padding: 0;
      overflow: hidden; /* Prevents body from scrolling horizontally */
      display: flex;
      flex-direction: column;
      height: 100vh;
    }
    .nav {
      display: flex;
      justify-content: flex-start;
      align-items: center;
      padding: 20px 40px 20px 20px; /* Increased top padding to move lower */
      font-size: 21px;
      font-weight: bold;
      color: #000;
      gap: 10px;
      background: #f2f2f2;
    }
    .nav a {
      font-size: 21px;
      text-decoration: none;
      color: #000;
      border-bottom: 4px solid transparent;
      padding: 5px 10px;
    }
    .nav a:hover {
      border-bottom: 4px solid #000;
    }
    .nav a.active {
      border-bottom: 4px solid #5f56ff; /* Changed to #5f56ff */
      color: #5f56ff; /* Changed to #5f56ff */
    }
    .csv-upload {
      display: none;
    }
    .stats {
      font-size: 96px;
      padding: 20px 40px 10px 40px;
      background: #f2f2f2;
    }
    .filter-container {
      padding: 0;
      background: #f2f2f2;
      /* border-top: 1px solid #000; /* Removed line on top */
    }
    .filter-group {
      background: #fff;
      border: none;
      border-radius: 0;
      margin-bottom: 0;
      overflow: hidden;
    }
    .filter-group:not(:first-child) {
      border-top: 1px solid #000;
    }
    .filter-group-header {
      padding: 10px 20px;
      font-size: 18px;
      font-weight: bold;
      background: #e6e6e6;
      cursor: pointer;
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-bottom: none;
      color: #999; /* Faint grey when inactive */
      transition: color 0.3s ease; /* Smooth transition for color change */
    }
    .filter-group.active .filter-group-header {
        border-bottom: none;
        color: #000; /* Black when active */
    }
    .filter-group-header::after {
      content: '';
    }
    .filter-group-content {
      max-height: 0;
      overflow: hidden;
      transition: max-height 0.3s ease-out;
      padding: 0 20px;
      background-color: #e6e6e6;
    }
    .filter-group.active .filter-group-content {
      max-height: 600px;
      padding-bottom: 15px;
    }
    .filter-title {
      font-size: 14px; /* Made smaller */
      font-weight: bold;
      margin-top: 15px;
      margin-bottom: 8px;
      color: #666; /* Closer to background gray */
    }
    .filter-group-content .filter-title:first-of-type {
        margin-top: 0;
    }
    .filter-pills {
      display: flex;
      flex-wrap: nowrap; /* Ensures horizontal scrolling */
      gap: 8px;
      overflow-x: auto; /* Enables horizontal scrolling */
      padding-bottom: 8px;
      -webkit-overflow-scrolling: touch; /* Smoother scrolling on iOS */
    }
    .filter-pills::-webkit-scrollbar {
        display: none; /* Hide scrollbar for Webkit browsers */
    }
    .filter-pills {
        -ms-overflow-style: none; /* Hide scrollbar for IE/Edge */
        scrollbar-width: none; /* Hide scrollbar for Firefox */
    }
    .pill {
      flex-shrink: 0;
      padding: 6px 12px;
      border-radius: 16px;
      border: 1px solid #999;
      background: transparent;
      cursor: pointer;
      font-size: 13px;
      transition: all 0.2s ease;
      color: #000;
    }
    .pill:hover {
      background: rgba(0, 0, 0, 0.1);
    }
    .pill.active {
      background: #5f56ff; /* Changed to #5f56ff */
      color: white;
      border-color: #5f56ff; /* Changed to #5f56ff */
    }
    .year-range-filter {
      display: flex;
      gap: 10px;
      margin-top: 8px;
    }
    .year-range-filter input[type="number"] {
      padding: 6px 10px;
      border: 1px solid #999;
      border-radius: 4px;
      font-size: 13px;
      width: 80px;
      color: #000;
      background-color: #f9f9f9;
    }
    .table-container {
      margin: 0;
      flex-grow: 1;
      overflow-y: auto;
      overflow-x: auto; /* Allows horizontal scrolling for the table */
      position: relative;
      background: #f2f2f2;
    }
    table {
      width: 100%;
      min-width: 900px; /* Ensures table doesn't shrink too much on smaller screens */
      border-collapse: collapse;
      background: #fff;
    }
    th, td {
      text-align: left;
      padding: 8px 12px;
      border-bottom: 1px solid #999;
      font-family: 'Geist Mono', monospace; /* Changed to Geist Mono */
      vertical-align: top;
      font-size: 14px; /* Default font size for table cells */
    }
    thead {
      position: sticky;
      top: 0;
      z-index: 10;
    }
    th {
      background: #5f56ff; /* Changed to #5f56ff */
      color: white; /* Ensure text is visible on the new background */
    }
    a {
      color: #5f56ff; /* Changed to #5f56ff */
      text-decoration: none;
      border-bottom: 1px solid #5f56ff; /* Changed to #5f56ff */
    }
    .month {
      color: gray;
    }
    .provider-item {
      display: block;
      margin-bottom: 4px;
      padding-bottom: 4px;
    }
    .provider-item:not(:last-child) {
      border-bottom: 1px solid #ddd;
    }
    .provider-resolution-group {
      font-size: 12px;
      line-height: 1.4;
    }

    /* New styles for the filter toggle button */
    .filter-toggle-container {
      background: #f2f2f2;
      padding: 0 40px 10px 20px; /* Adjusted padding to align with nav/stats and remove right padding */
      display: flex;
      justify-content: flex-start; /* Align to the left */
      align-items: center;
      gap: 10px;
      /* border-top: 1px solid #000; /* Removed line on top */
    }

    .filter-toggle-label {
      font-size: 18px;
      font-weight: bold;
      color: #000;
    }

    /* The switch - the box around the slider */
    .switch {
      position: relative;
      display: inline-block;
      width: 40px; /* Smaller width */
      height: 24px; /* Smaller height */
    }

    /* Hide default HTML checkbox */
    .switch input {
      opacity: 0;
      width: 0;
      height: 0;
    }

    /* The slider */
    .slider {
      position: absolute;
      cursor: pointer;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: #ccc;
      -webkit-transition: .4s;
      transition: .4s;
      border-radius: 24px; /* Smaller border-radius */
    }

    .slider:before {
      position: absolute;
      content: "";
      height: 18px; /* Smaller height */
      width: 18px; /* Smaller width */
      left: 3px; /* Adjusted left position */
      bottom: 3px; /* Adjusted bottom position */
      background-color: white;
      -webkit-transition: .4s;
      transition: .4s;
      border-radius: 50%;
    }

    input:checked + .slider {
      background-color: #5f56ff; /* Changed to #5f56ff */
    }

    input:focus + .slider {
      box-shadow: 0 0 1px #5f56ff; /* Changed to #5f56ff */
    }

    input:checked + .slider:before {
      -webkit-transform: translateX(16px); /* Adjusted translation */
      -ms-transform: translateX(16px); /* Adjusted translation */
      transform: translateX(16px); /* Adjusted translation */
    }

    /* Overlay styles */
    .overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: transparent; 
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 1000;
      font-size: 10em; 
      font-weight: bold;
      color: #333;
      text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
      pointer-events: none; /* Allows clicks to pass through to elements below */
      opacity: 1;
      transition: opacity 0.5s ease-out;
    }
    .overlay.hidden {
      opacity: 0;
      visibility: hidden;
    }

    /* --- Responsive Design --- */

    /* For screens smaller than 768px (tablets and smaller) */
    @media (max-width: 768px) {
      .nav {
        padding: 15px 20px 15px 15px;
        font-size: 18px;
        gap: 5px;
      }
      .nav a {
        font-size: 18px;
        padding: 3px 8px;
      }
      .stats {
        font-size: 60px; /* Reduced font size for stats */
        padding: 15px 20px 5px 20px;
      }
      .filter-toggle-container {
        padding: 0 20px 10px 15px; /* Adjusted padding */
      }
      .filter-toggle-label {
        font-size: 16px;
      }
      .filter-group-header {
        font-size: 16px;
        padding: 8px 15px;
      }
      .filter-group-content {
        padding: 0 15px;
      }
      .filter-title {
        font-size: 12px; /* Made smaller for tablets */
      }
      .pill {
        font-size: 12px;
        padding: 5px 10px;
      }
      .year-range-filter input[type="number"] {
        font-size: 12px;
        width: 60px;
      }
      th, td {
        font-size: 12px; /* Smaller font size for table cells */
        padding: 6px 8px;
      }
      table {
        min-width: 700px; /* Adjust minimum width for horizontal scroll */
      }
      .overlay {
        font-size: 7em; /* Scale down overlay text for tablets */
      }
    }

    /* For screens smaller than 480px (mobile phones) */
    @media (max-width: 480px) {
      .nav {
        flex-direction: column; /* Stack nav items vertically */
        align-items: flex-start;
        padding: 10px;
        font-size: 16px;
      }
      .nav a {
        font-size: 16px;
        padding: 2px 5px;
        border-bottom: 2px solid transparent; /* Smaller border */
      }
      .stats {
        font-size: 40px; /* Even smaller font size for stats */
        padding: 10px;
      }
      .filter-group-header {
        font-size: 14px;
        padding: 6px 10px;
      }
      .filter-group-content {
        padding: 0 10px;
      }
      .filter-title {
        font-size: 11px; /* Made smaller for mobile */
      }
      .pill {
        font-size: 11px;
        padding: 4px 8px;
      }
      .year-range-filter input[type="number"] {
        width: 50px;
      }
      th, td {
        font-size: 10px; /* Smallest font size for table cells */
        padding: 4px 6px;
      }
      table {
        min-width: 500px; /* Further adjust minimum width for horizontal scroll */
      }
      .overlay {
        font-size: 4em; /* Scale down overlay text for mobile */
      }
    }
  </style>
</head>
<body>
  <div id="fixed-header-area">
    <div class="nav">
      <a href="index.html" class="active">Index</a>
      <a href="about.html">About</a>
    </div>
    <div class="stats">
      <span id="loadingStatus">Loading data...</span>
      <div id="statsDisplay" style="display: none;"></div>
    </div>
    
    <div class="filter-toggle-container">
        <span class="filter-toggle-label">FILTERS</span>
        <label class="switch">
            <input type="checkbox" id="filterToggle">
            <span class="slider"></span>
        </label>
    </div>

    <div class="filter-container">
      <div class="filter-group" id="narrative-group">
          <div class="filter-group-header">NARRATIVE</div>
          <div class="filter-group-content">
              <div class="filter-title">Filter by Publication Year Range:</div>
              <div class="year-range-filter">
                  <input type="number" id="fromYearInput" placeholder="From Year">
                  <input type="number" id="toYearInput" placeholder="To Year">
              </div>

              <div class="filter-title">Filter by Region:</div>
              <div class="filter-pills" id="region-filter-pills">
                  <button class="pill active" data-type="region" data-value="all">All</button>
                  <button class="pill" data-type="region" data-value="Europe">Europe</button>
                  <button class="pill" data-type="region" data-value="Middle East">Middle East</button>
                  <button class="pill" data-type="region" data-value="Americas">Americas</button>
                  <button class="pill" data-type="region" data-value="Asia">Asia</button>
              </div>

              <div id="focus-filter-section" style="display: none;">
                  <div class="filter-title">Filter by Country/Area:</div>
                  <div class="filter-pills" id="focus-filter-pills">
                      <button class="pill active" data-type="focus" data-value="all">All</button>
                      </div>
              </div>
          </div>
      </div>

      <div class="filter-group" id="data-group">
          <div class="filter-group-header">DATA</div>
          <div class="filter-group-content">
              <div class="filter-title">Filter by Resolution:</div>
              <div class="filter-pills" id="meters-filter-pills">
                  <button class="pill active" data-type="resolutionCategory" data-value="all">All</button>
                  <button class="pill" data-type="resolutionCategory" data-value="<1m">&lt;1m</button>
                  <button class="pill" data-type="resolutionCategory" data-value="1-10m">1-10m</button>
                  <button class="pill" data-type="resolutionCategory" data-value=">10m">&gt;10m</button>
              </div>

              <div class="filter-title">Filter by Viz:</div>
              <div class="filter-pills" id="viz-filter-pills">
                  <button class="pill active" data-type="viz" data-value="all">All</button>
              </div>
              
              <div class="filter-title">Filter by Data Use Year:</div>
              <div class="filter-pills" id="years-filter-pills">
                  <button class="pill active" data-type="years" data-value="all">All</button>
                  </div>
          </div>
      </div>
      
      <div class="filter-group" id="source-group">
          <div class="filter-group-header">SOURCE</div>
          <div class="filter-group-content">
              <div class="filter-title">Filter by outlet:</div>
              <div class="filter-pills" id="outlet-filter-pills">
                  <button class="pill active" data-type="outlet" data-value="all">All</button>
                  <button class="pill" data-type="outlet" data-value="The New York Times">The New York Times</button>
                  <button class="pill" data-type="outlet" data-value="Washington Post">Washington Post</button>
                  <button class="pill" data-type="outlet" data-value="The Guardian">The Guardian</button>
                  <button class="pill" data-type="outlet" data-value="BBC">BBC</button>
                  <button class="pill" data-type="outlet" data-value="CNN">CNN</button>
                  <button class="pill" data-type="outlet" data-value="Reuters">Reuters</button>
                  <button class="pill" data-type="outlet" data-value="Sky News">Sky News</button>
              </div>
              
              <div class="filter-title">Filter by provider:</div>
              <div class="filter-pills" id="provider-filter-pills">
                  <button class="pill active" data-type="provider" data-value="all">All</button>
                  <button class="pill" data-type="provider" data-value="Planet Labs">Planet Labs</button>
                  <button class="pill" data-type="provider" data-value="Maxar">Maxar</button>
                  <button class="pill" data-type="provider" data-value="ESA">ESA</button>
                  <button class="pill" data-type="provider" data-value="NASA">NASA</button>
                  <button class="pill" data-type="provider" data-value="USGS">USGS</button>
                  <button class="pill" data-type="provider" data-value="Airbus">Airbus</button>
              </div>
          </div>
      </div>
    </div>
  </div>
  
  <div class="table-container">
    <table>
      <thead>
        <tr>
          <th>Date</th>
          <th>Title</th>
          <th>Link</th> <th>Outlet</th>
          <th>Region</th> <th>Country</th> <th>Context</th>
          <th>Category</th>
          <th>Data Use</th>
          <th>Provider</th>
          <th>Platform</th>
          <th>Representation</th>
          <th>Resolution</th>
          <th>Viz</th>
          <th>Interaction</th>
          <th>How To</th> </tr>
      </thead>
      <tbody>
        </tbody>
    </table>
  </div>
  
  <div id="initialOverlay" class="overlay">
    GEOSPATIAL NARRATIVES
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
  <script>
    let allData = [];
    let selectedRegion = 'all';
    let selectedFocuses = ['all'];
    let selectedYears = ['all'];
    let filtersActive = false;
    const countryRegions = {
      'Gaza Strip': 'Middle East',
      'Ukraine': 'Europe',
      'Russia': 'Europe',
      'Guantanamo Bay': 'Americas',
      'China': 'Asia',
      'Amazon Rainforest': 'Americas',
      'Syria': 'Middle East',
      'Iraq': 'Middle East',
      'Afghanistan': 'Asia',
      'North Korea': 'Asia',
      'United States': 'Americas',
      'Canada': 'Americas',
      'Brazil': 'Americas',
      'Germany': 'Europe',
      'France': 'Europe',
      'United Kingdom': 'Europe',
      'India': 'Asia',
      'Japan': 'Asia',
      'Australia': 'Asia', 
      'Egypt': 'Middle East',
    };
    
    document.addEventListener('DOMContentLoaded', function() {
      loadDataFromBackend();

      document.querySelectorAll('.filter-pills .pill').forEach(pill => {
        pill.addEventListener('click', handlePillClick);
      });

      document.getElementById('fromYearInput').addEventListener('input', filterTable);
      document.getElementById('toYearInput').addEventListener('input', filterTable);

      document.querySelectorAll('.filter-group-header').forEach(header => {
          header.addEventListener('click', function() {
              const group = this.closest('.filter-group');
              if (filtersActive) {
                group.classList.toggle('active');
                adjustTableHeight();
              }
          });
      });

      const filterToggle = document.getElementById('filterToggle');
      filterToggle.addEventListener('change', function() {
          filtersActive = this.checked;
          toggleAllFilters(filtersActive);
          filterTable();
      });

      const currentPath = window.location.pathname.split('/').pop();
      document.querySelectorAll('.nav a').forEach(link => {
        if (link.getAttribute('href') === currentPath && link.getAttribute('href') !== 'index.html') {
          document.querySelector('.nav a[href="index.html"]').classList.remove('active');
          link.classList.add('active');
        } else if (currentPath === '' && link.getAttribute('href') === 'index.html') {
        }
      });

      adjustTableHeight();
      window.addEventListener('resize', adjustTableHeight);

      const initialOverlay = document.getElementById('initialOverlay');
      const hideOverlay = () => {
        if (initialOverlay && !initialOverlay.classList.contains('hidden')) {
          initialOverlay.classList.add('hidden');
          document.removeEventListener('mousemove', hideOverlay);
          document.removeEventListener('scroll', hideOverlay);
          document.removeEventListener('click', hideOverlay);
          document.removeEventListener('keydown', hideOverlay);
        }
      };

      document.addEventListener('mousemove', hideOverlay);
      document.addEventListener('scroll', hideOverlay);
      document.addEventListener('click', hideOverlay);
      document.addEventListener('keydown', hideOverlay);
    });

    function adjustTableHeight() {
      const fixedHeader = document.getElementById('fixed-header-area');
      const tableContainer = document.querySelector('.table-container');
      if (fixedHeader && tableContainer) {
        const headerHeight = fixedHeader.offsetHeight;
        tableContainer.style.height = `calc(100vh - ${headerHeight}px)`;
      }
    }

    function extractYears(dataUseString) {
        if (!dataUseString) return [];
        const yearMatches = dataUseString.match(/\b\d{4}\b/g);
        return yearMatches ? Array.from(new Set(yearMatches)).sort() : [];
    }
    
    async function loadDataFromBackend() {
      const loadingStatus = document.getElementById('loadingStatus');
      const statsDisplay = document.getElementById('statsDisplay');
      
      try {
        loadingStatus.textContent = 'Loading data from server...';
        
        const response = await fetch('./data.csv');
        
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const csvText = await response.text();
        
        Papa.parse(csvText, {
          header: true,
          skipEmptyLines: true,
          dynamicTyping: false,
          complete: function(results) {
            if (results.errors.length > 0) {
              console.warn('CSV parsing warnings:', results.errors);
            }
            
            allData = results.data.map(row => {
              const providers = row.Provider ? row.Provider.split(/[,;]/).map(p => p.trim()).filter(p => p) : [];
              const resolutions = row.Resolution ? row.Resolution.split(/[,;]/).map(r => r.trim()).filter(r => r) : [];
              const platforms = row.Platform ? row.Platform.split(/[,;]/).map(p => p.trim()).filter(p => p) : [];
              
              let providerResolutionPairs = [];
              if (providers.length > 0 || resolutions.length > 0 || platforms.length > 0) {
                const maxLength = Math.max(providers.length, resolutions.length, platforms.length);
                for (let i = 0; i < maxLength; i++) {
                    const provider = providers[i] || providers[0] || '';
                    const resolution = resolutions[i] || resolutions[0] || '';
                    const platform = platforms[i] || platforms[0] || '';

                    providerResolutionPairs.push({
                        provider: provider,
                        resolution: resolution,
                        platform: platform,
                        resolutionCategory: getMeterCategory(resolution)
                    });
                }
              } else {
                providerResolutionPairs.push({
                  provider: '',
                  resolution: '',
                  platform: '',
                  resolutionCategory: ''
                });
              }
              
              return {
                date: row.Date || '',
                title: row['Title (Original)'] || row.Title || '',
                link: row.Link || row.Source || '', // Changed from source to link, allow Source as fallback
                outlet: row.Outlet || '',
                country: row.Country || row.Focus || '', // Changed from focus to country, allow Focus as fallback
                region: countryRegions[row.Country || row.Focus] || '', // New: derived from country/focus
                context: row.Context || '',
                category: row.Category || '',
                dataUse: extractYears(row['Data use'] || ''),
                providerResolutionPairs: providerResolutionPairs,
                representation: row.Representation || '',
                viz: row.Viz || '', 
                interaction: row.Interaction || '', 
                howTo: row['How To'] || '' // New: howTo
              };
            });
            
            allData = allData.filter(item => item.title || item.outlet);
            
            updateYearRangeInputs();
            updateFilters(); 
            renderTable();
            updateFilterCount(allData.length);
            
            loadingStatus.style.display = 'none';
            statsDisplay.style.display = 'block';
            
            console.log(`Loaded ${allData.length} records from backend`);
            adjustTableHeight();
          },
          error: function(error) {
            console.error('CSV parsing error:', error);
            loadingStatus.textContent = 'Error parsing data, loading sample data...';
            setTimeout(() => {
              loadSampleData();
            }, 1000);
          }
        });
        
      } catch (error) {
        console.error('Error loading data from backend:', error);
        loadingStatus.textContent = 'Backend unavailable, loading sample data...';
        setTimeout(() => {
              loadSampleData();
            }, 1000);
      }
    }
    
    function loadSampleData() {
      const loadingStatus = document.getElementById('loadingStatus');
      const statsDisplay = document.getElementById('statsDisplay');

      function getMeterCategory(resolution) {
          if (!resolution) return '';
          const numMatch = resolution.match(/(\d+\.?\d*)/);
          let res = null;
          if (numMatch) {
              res = parseFloat(numMatch[1]);
          }

          if (resolution.includes('<1m') || (res !== null && res > 0 && res < 1)) {
              return '<1m';
          } else if (resolution.includes('1-10m') || (res !== null && res >= 1 && res <= 10)) {
              return '1-10m';
          } else if (resolution.includes('>10m') || (res !== null && res > 10)) {
              return '>10m';
          }
          return '';
      }
      
      const baseData = [
        { date: '2024-10-06', title: 'Gaza in rubble and ruin', link: 'https://www.reuters.com/', outlet: 'Reuters', country: 'Gaza Strip', region: 'Middle East', context: 'Gaza War', category: 'Armed Conflict', dataUse: '2023', providerResolutionPairs: [{ provider: 'Planet Labs', platform: 'SkySat', resolution: '<1m', resolutionCategory: '<1m' }], representation: 'Optical', viz: 'RGB', interaction: 'None', howTo: 'Example text here'},
        { date: '2023-10-30', title: 'Guantanamo Bay changes', link: 'https://news.sky.com/', outlet: 'Sky News', country: 'Guantanamo Bay', region: 'Americas', context: 'Military Base', category: 'Infrastructure', dataUse: '2023', providerResolutionPairs: [{ provider: 'Planet Labs', platform: 'SkySat', resolution: '<1m', resolutionCategory: '<1m' }], representation: 'Optical', viz: 'RGB', interaction: 'Interactive Map', howTo: ''},
        { date: '2023-10-28', title: 'Mapping the Destruction in Gaza', link: 'https://washingtonpost.com/gaza-destruction', outlet: 'Washington Post', country: 'Gaza Strip', region: 'Middle East', context: 'Gaza War', category: 'Armed Conflict', dataUse: '2022, 2023', providerResolutionPairs: [{ provider: 'Maxar', platform: 'WorldView', resolution: '1-10m', resolutionCategory: '1-10m' },{ provider: 'Planet Labs', platform: 'SkySat', resolution: '<1m', resolutionCategory: '<1m' }], representation: 'Optical', viz: 'RGB', interaction: 'Before/After Slider', howTo: 'Another example'},
        { date: '2023-11-05', title: 'Damage in Northern Gaza', link: 'https://bbc.com/news/gaza-damage', outlet: 'BBC', country: 'Gaza Strip', region: 'Middle East', context: 'Gaza War', category: 'Armed Conflict', dataUse: '2023', providerResolutionPairs: [{ provider: 'Planet Labs', platform: 'SkySat', resolution: '<1m', resolutionCategory: '<1m' }], representation: 'Optical', viz: 'NDVI', interaction: 'Static Images', howTo: ''},
        { date: '2023-11-10', title: 'Destruction in Northern Gaza', link: 'https://theguardian.com/gaza-before-after', outlet: 'The Guardian', country: 'Gaza Strip', region: 'Middle East', context: 'Gaza War', category: 'Armed Conflict', dataUse: '2021, 2023', providerResolutionPairs: [{ provider: 'Planet Labs', platform: 'SkySat', resolution: '<1m', resolutionCategory: '<1m' },{ provider: 'Maxar', platform: 'WorldView', resolution: '1-10m', resolutionCategory: '1-10m' }], representation: 'Optical', viz: 'NRG', interaction: 'Interactive Comparison', howTo: ''},
        { date: '2023-11-15', title: 'Hospital Complex Damage', link: 'https://cnn.com/gaza-hospital', outlet: 'CNN', country: 'Gaza Strip', region: 'Middle East', context: 'Gaza War', category: 'Armed Conflict', dataUse: '2020, 2023', providerResolutionPairs: [{ provider: 'Maxar', platform: 'WorldView', resolution: '1-10m', resolutionCategory: '1-10m' }], representation: 'Optical', viz: 'RGB', interaction: 'Annotated Images', howTo: ''},
        { date: '2023-11-20', title: 'War-Torn Gaza: A View From Above', link: 'https://reuters.com/gaza-aerial', outlet: 'Reuters', country: 'Gaza Strip', region: 'Middle East', context: 'Gaza War', category: 'Armed Conflict', dataUse: '2023', providerResolutionPairs: [{ provider: 'Planet Labs', platform: 'SkySat', resolution: '<1m', resolutionCategory: '<1m' }], representation: 'Optical', viz: 'RGB', interaction: 'Photo Gallery', howTo: ''},
        { date: '2022-03-01', title: 'Destruction in Ukraine', link: 'https://nytimes.com/ukraine-destruction', outlet: 'The New York Times', country: 'Ukraine', region: 'Europe', context: 'Russia-Ukraine War', category: 'Armed Conflict', dataUse: '2022', providerResolutionPairs: [{ provider: 'Maxar', platform: 'WorldView', resolution: '1-10m', resolutionCategory: '1-10m' }], representation: 'Optical', viz: 'NDVI', interaction: 'Static Images', howTo: ''},
        { date: '2022-04-10', title: 'Tracking Russian Troop Movements by Satellite', link: 'https://cnn.com/russia-troop-movement', outlet: 'CNN', country: 'Russia', region: 'Europe', context: 'Russia-Ukraine War', category: 'Military', dataUse: '2022', providerResolutionPairs: [{ provider: 'Planet Labs', platform: 'SkySat', resolution: '<1m', resolutionCategory: '<1m' }], representation: 'Optical', viz: 'RGB', interaction: 'Annotated Images', howTo: ''},
        { date: '2024-02-14', title: 'New Infrastructure in China Revealed by Satellite', link: 'https://example.com/china-infra', outlet: 'BBC', country: 'China', region: 'Asia', context: 'Urban Development', category: 'Infrastructure', dataUse: '2019, 2024', providerResolutionPairs: [{ provider: 'Maxar', platform: 'GeoEye', resolution: '>10m', resolutionCategory: '>10m' }], representation: 'Optical', viz: 'NRG', interaction: 'Interactive Map', howTo: ''},
        { date: '2023-07-20', title: 'Deforestation Trends in Amazon', link: 'https://example.com/amazon-deforestation', outlet: 'The Guardian', country: 'Amazon Rainforest', region: 'Americas', context: 'Environmental', category: 'Environment', dataUse: '1989, 2000, 2023', providerResolutionPairs: [{ provider: 'European Space Agency', platform: 'Sentinel', resolution: '>10m', resolutionCategory: '>10m' }], representation: 'Optical', viz: 'False Color', interaction: 'Time-lapse Video', howTo: ''},
        { date: '2023-09-01', title: 'Syrian Refugee Camps Expansion', link: 'https://reuters.com/syria-camps', outlet: 'Reuters', country: 'Syria', region: 'Middle East', context: 'Humanitarian Crisis', category: 'Humanitarian', dataUse: '2023', providerResolutionPairs: [{ provider: 'Planet Labs', platform: 'SkySat', resolution: '1-10m', resolutionCategory: '1-10m' }], representation: 'Optical', viz: 'RGB', interaction: 'Before/After', howTo: ''},
        { date: '2021-11-11', title: 'Impact of Drought in Iraq', link: 'https://nytimes.com/iraq-drought', outlet: 'The New York Times', country: 'Iraq', region: 'Middle East', context: 'Climate Change', category: 'Environment', dataUse: '2021', providerResolutionPairs: [{ provider: 'Maxar', platform: 'WorldView', resolution: '>10m', resolutionCategory: '>10m' }], representation: 'Infrared', viz: 'False Color', interaction: 'Static Map', howTo: ''},
        { date: '2020-05-20', title: 'Opium Cultivation in Afghanistan', link: 'https://washingtonpost.com/afghanistan', outlet: 'Washington Post', country: 'Afghanistan', region: 'Asia', context: 'Illegal Activities', category: 'Agriculture', dataUse: '2020', providerResolutionPairs: [{ provider: 'Planet Labs', platform: 'SkySat', resolution: '<1m', resolutionCategory: '<1m' }], representation: 'Optical', viz: 'NDVI', interaction: 'Annotated Imagery', howTo: ''},
        { date: '2022-08-15', title: 'North Korean Missile Sites Updated', link: 'https://cnn.com/northkorea-missile', outlet: 'CNN', country: 'North Korea', region: 'Asia', context: 'Nuclear Program', category: 'Military', dataUse: '2022', providerResolutionPairs: [{ provider: 'Maxar', platform: 'WorldView', resolution: '1-10m', resolutionCategory: '1-10m' }], representation: 'Optical', viz: 'RGB', interaction: 'Comparative Imagery', howTo: ''}
      ];

      allData = [];
      const numberOfClones = 50; 
      for (let i = 0; i < numberOfClones; i++) {
        baseData.forEach(item => {
          const newItem = JSON.parse(JSON.stringify(item)); 
          newItem.title = `(Clone ${i + 1}) ${newItem.title}`; 
          newItem.date = `20${(20 + (i % 5))}-01-01`; 
          newItem.dataUse = extractYears(item.dataUse);
          allData.push(newItem);
        });
      }
      
      allData = allData.map(item => {
          item.providerResolutionPairs = item.providerResolutionPairs.map(pair => ({
              ...pair,
              resolutionCategory: getMeterCategory(pair.resolution)
          }));
          item.dataUse = item.dataUse.map(String); 
          // Ensure region is set for sample data items
          item.region = countryRegions[item.country] || '';
          return item;
      });
      
      updateYearRangeInputs();
      updateFilters(); 
      renderTable();
      updateFilterCount(allData.length);
      
      loadingStatus.style.display = 'none';
      statsDisplay.style.display = 'block';
      
      console.log(`Loaded ${allData.length} sample records`);
      adjustTableHeight();
    }

    function updateYearRangeInputs() {
        let earliestYear = Infinity;
        let latestYear = 0;
        let hasValidDate = false;

        allData.forEach(item => {
            if (item.date) {
                const year = parseInt(item.date.substring(0, 4));
                if (!isNaN(year)) {
                    earliestYear = Math.min(earliestYear, year);
                    latestYear = Math.max(latestYear, year);
                    hasValidDate = true;
                }
            }
        });

        const fromYearInput = document.getElementById('fromYearInput');
        const toYearInput = document.getElementById('toYearInput');

        if (hasValidDate) {
            fromYearInput.min = earliestYear;
            fromYearInput.max = latestYear;
            toYearInput.min = earliestYear;
            toYearInput.max = latestYear;
        } else {
            fromYearInput.min = 1900; 
            fromYearInput.max = new Date().getFullYear() + 5; 
            toYearInput.min = 1900;
            toYearInput.max = new Date().getFullYear() + 5;
            fromYearInput.value = '';
            toYearInput.value = '';
        }
    }
    
    function updateFilters() {
      const outlets = [...new Set(allData.map(item => item.outlet).filter(o => o))];
      const providers = [...new Set(allData.flatMap(item => item.providerResolutionPairs.map(p => p.provider)).filter(p => p))];
      // Changed focus to country for consistency with new data model
      const allUniqueCountries = [...new Set(allData.map(item => item.country).filter(f => f))]; 
      const allUniqueYears = [...new Set(allData.flatMap(item => item.dataUse).filter(y => y))].sort();
      const allUniqueViz = [...new Set(allData.map(item => item.viz).filter(i => i))]; 
      
      const outletContainer = document.getElementById('outlet-filter-pills'); 
      const existingHardcodedOutlets = ["The New York Times", "Washington Post", "The Guardian", "BBC", "CNN", "Reuters", "Sky News"];
      outletContainer.querySelectorAll('.pill[data-type="outlet"]:not([data-value="all"])').forEach(pill => {
          if (!existingHardcodedOutlets.includes(pill.getAttribute('data-value'))) {
              pill.remove();
          }
      });
      outlets.forEach(outlet => {
        if (!existingHardcodedOutlets.includes(outlet)) {
          const pill = document.createElement('button');
          pill.className = 'pill';
          pill.setAttribute('data-type', 'outlet');
          pill.setAttribute('data-value', outlet);
          pill.textContent = outlet;
          pill.addEventListener('click', handlePillClick);
          outletContainer.appendChild(pill);
        }
      });
      
      const providerContainer = document.getElementById('provider-filter-pills'); 
      const existingHardcodedProviders = ["Planet Labs", "Maxar", "ESA", "NASA", "USGS", "Airbus"];
      providerContainer.querySelectorAll('.pill[data-type="provider"]:not([data-value="all"])').forEach(pill => {
          if (!existingHardcodedProviders.includes(pill.getAttribute('data-value'))) {
              pill.remove();
          }
      });
      providers.forEach(provider => {
        if (!existingHardcodedProviders.includes(provider)) {
          const pill = document.createElement('button');
          pill.className = 'pill';
          pill.setAttribute('data-type', 'provider');
          pill.setAttribute('data-value', provider);
          pill.textContent = provider;
          pill.addEventListener('click', handlePillClick);
          providerContainer.appendChild(pill);
        }
      });

      const focusFilterSection = document.getElementById('focus-filter-section');
      const focusContainer = document.getElementById('focus-filter-pills'); 
      
      focusContainer.querySelectorAll('.pill[data-type="focus"]:not([data-value="all"])').forEach(pill => pill.remove());

      if (selectedRegion === 'all') {
        focusFilterSection.style.display = 'none';
        selectedFocuses = ['all'];
        document.querySelector('#focus-filter-pills .pill[data-value="all"]').classList.add('active');
      } else {
        focusFilterSection.style.display = 'block';
        
        // Use allUniqueCountries instead of allUniqueFocuses
        let countriesToShow = allUniqueCountries.filter(country => countryRegions[country] === selectedRegion);
        
        countriesToShow.sort().forEach(country => { 
          const pill = document.createElement('button');
          pill.className = 'pill';
          pill.setAttribute('data-type', 'focus'); // Keep data-type 'focus' for compatibility with existing pill handling
          pill.setAttribute('data-value', country);
          pill.textContent = country;
          pill.addEventListener('click', handlePillClick);
          if (selectedFocuses.includes(country)) {
              pill.classList.add('active');
          }
          focusContainer.appendChild(pill);
        });

        const currentRegionFocusesActive = Array.from(document.querySelectorAll('#focus-filter-pills .pill[data-type="focus"].active'))
                                             .filter(pill => pill.getAttribute('data-value') !== 'all')
                                             .map(pill => pill.getAttribute('data-value'));
        
        if (currentRegionFocusesActive.length === 0) {
            document.querySelector('#focus-filter-pills .pill[data-value="all"]').classList.add('active');
            selectedFocuses = ['all'];
        } else {
            selectedFocuses = selectedFocuses.filter(f => countriesToShow.includes(f) || f === 'all');
            if (selectedFocuses.length === 0 && countriesToShow.length > 0) {
                selectedFocuses = ['all'];
                document.querySelector('#focus-filter-pills .pill[data-value="all"]').classList.add('active');
            }
        }
      }

      const yearsContainer = document.getElementById('years-filter-pills');
      yearsContainer.querySelectorAll('.pill[data-type="years"]:not([data-value="all"])').forEach(pill => pill.remove());
      
      allUniqueYears.forEach(year => {
        const pill = document.createElement('button');
        pill.className = 'pill';
        pill.setAttribute('data-type', 'years');
        pill.setAttribute('data-value', year);
        pill.textContent = year;
        pill.addEventListener('click', handlePillClick);
        yearsContainer.appendChild(pill);
      });
      const currentYearsActive = Array.from(document.querySelectorAll('#years-filter-pills .pill[data-type="years"].active'))
                                           .filter(pill => pill.getAttribute('data-value') !== 'all')
                                           .map(pill => pill.getAttribute('data-value'));
      if (currentYearsActive.length === 0) {
          document.querySelector('#years-filter-pills .pill[data-value="all"]').classList.add('active');
          selectedYears = ['all'];
      } else {
          selectedYears = selectedYears.filter(y => allUniqueYears.includes(y) || y === 'all');
          if (selectedYears.length === 0 && allUniqueYears.length > 0) {
              selectedYears = ['all'];
              document.querySelector('#years-filter-pills .pill[data-value="all"]').classList.add('active');
          }
      }

      const vizContainer = document.getElementById('viz-filter-pills');
      const hardcodedVizOptions = ["RGB", "NRG", "NDVI", "False Color"];
      vizContainer.querySelectorAll('.pill[data-type="viz"]:not([data-value="all"])').forEach(pill => {
          if (!hardcodedVizOptions.includes(pill.getAttribute('data-value'))) {
              pill.remove();
          }
      });
      
      allUniqueViz.sort().forEach(viz => { 
          if (!hardcodedVizOptions.includes(viz)) {
              const pill = document.createElement('button');
              pill.className = 'pill';
              pill.setAttribute('data-type', 'viz');
              pill.setAttribute('data-value', viz);
              pill.textContent = viz;
              pill.addEventListener('click', handlePillClick);
              vizContainer.appendChild(pill);
          }
      });
      adjustTableHeight();
    }
    
    function toggleAllFilters(activate) {
        const filterGroups = document.querySelectorAll('.filter-group');
        const filterGroupHeaders = document.querySelectorAll('.filter-group-header');
        const fromYearInput = document.getElementById('fromYearInput');
        const toYearInput = document.getElementById('toYearInput');

        if (activate) {
            filterGroupHeaders.forEach(header => header.style.color = '#000');
            
            document.querySelectorAll('.filter-pills .pill').forEach(pill => {
                if (pill.getAttribute('data-value') === 'all') {
                    pill.classList.add('active');
                } else {
                    pill.classList.remove('active');
                }
            });
            fromYearInput.value = '';
            toYearInput.value = '';
            selectedRegion = 'all';
            selectedFocuses = ['all'];
            selectedYears = ['all'];

        } else {
            filterGroupHeaders.forEach(header => header.style.color = '#999');
            filterGroups.forEach(group => group.classList.remove('active')); // Close all filter groups
            document.querySelectorAll('.filter-pills .pill').forEach(pill => {
                if (pill.getAttribute('data-value') === 'all') {
                    pill.classList.add('active');
                } else {
                    pill.classList.remove('active');
                }
            });
            fromYearInput.value = '';
            toYearInput.value = '';
            selectedRegion = 'all';
            selectedFocuses = ['all'];
            selectedYears = ['all'];
        }
        adjustTableHeight();
    }

    function handlePillClick() {
      if (!filtersActive && this.getAttribute('data-value') !== 'all') {
        document.getElementById('filterToggle').checked = true;
        filtersActive = true;
        toggleAllFilters(true);
      }

      const filterType = this.getAttribute('data-type');
      const filterValue = this.getAttribute('data-value');
      
      const allPillsOfType = document.querySelectorAll(`.pill[data-type="${filterType}"]`);

      if (filterType === 'region') {
        selectedRegion = filterValue;
        selectedFocuses = ['all']; 

        allPillsOfType.forEach(p => p.classList.remove('active'));
        this.classList.add('active');

        updateFilters(); 
      } else if (filterType === 'focus') {
        if (filterValue === 'all') {
          selectedFocuses = ['all'];
          allPillsOfType.forEach(p => p.classList.remove('active'));
          this.classList.add('active');
        } else {
          if (selectedFocuses.includes('all')) {
            selectedFocuses = [];
            document.querySelector('#focus-filter-pills .pill[data-value="all"]').classList.remove('active');
          }
          
          if (selectedFocuses.includes(filterValue)) {
            selectedFocuses = selectedFocuses.filter(val => val !== filterValue);
            this.classList.remove('active');
          } else {
            selectedFocuses.push(filterValue);
            this.classList.add('active');
          }

          if (selectedFocuses.length === 0) {
            selectedFocuses = ['all'];
            document.querySelector('#focus-filter-pills .pill[data-value="all"]').classList.add('active');
          }
        }
      } else if (filterType === 'years') {
        if (filterValue === 'all') {
          selectedYears = ['all'];
          allPillsOfType.forEach(p => p.classList.remove('active'));
          this.classList.add('active');
        } else {
          if (selectedYears.includes('all')) {
            selectedYears = [];
            document.querySelector('#years-filter-pills .pill[data-value="all"]').classList.remove('active');
          }
          
          if (selectedYears.includes(filterValue)) {
            selectedYears = selectedYears.filter(val => val !== filterValue);
            this.classList.remove('active');
          } else {
            selectedYears.push(filterValue);
            this.classList.add('active');
          }

          if (selectedYears.length === 0) {
            selectedYears = ['all'];
            document.querySelector('#years-filter-pills .pill[data-value="all"]').classList.add('active');
          }
        }
      } else { // For outlet, provider, resolutionCategory, viz
        if (filterValue === 'all') {
          allPillsOfType.forEach(p => {
            p.classList.remove('active');
          });
          this.classList.add('active');
        } else {
          const allPill = document.querySelector(`.pill[data-type="${filterType}"][data-value="all"]`);
          if (allPill && allPill.classList.contains('active')) {
            allPill.classList.remove('active');
          }
          this.classList.toggle('active');
          
          if (document.querySelectorAll(`.pill[data-type="${filterType}"].active`).length === 0) {
            if (allPill) {
              allPill.classList.add('active');
            }
          }
        }
      }
      
      filterTable();
    }
    
    // Function to render the table with merged cells for common data
    function renderTable() {
      const tbody = document.querySelector('tbody');
      tbody.innerHTML = '';
      
      // Store which rows are visible based on filters, and for each item, which of its provider pairs are visible
      const filteredResults = [];
      allData.forEach(item => {
        const visiblePairs = item.providerResolutionPairs.filter(pair => {
            // Apply all filters to each provider pair, including the main item properties
            return applyAllFiltersToItemAndPair(item, pair);
        });

        if (visiblePairs.length > 0) {
            filteredResults.push({ item: item, visiblePairs: visiblePairs });
        }
      });

      let displayedRowCount = 0; // Track the actual number of rows displayed
      filteredResults.forEach(result => {
        const item = result.item;
        const visiblePairs = result.visiblePairs;
        const rowspan = visiblePairs.length;

        visiblePairs.forEach((pair, pairIndex) => {
          const row = document.createElement('tr');
          row.setAttribute('data-original-index', allData.indexOf(item)); // Store original item index
          row.setAttribute('data-pair-index', item.providerResolutionPairs.indexOf(pair)); // Store pair index

          if (pairIndex === 0) {
            // First row for this article, apply rowspan for common columns
            row.innerHTML = `
              <td rowspan="${rowspan}">${item.date}</td>
              <td rowspan="${rowspan}">${item.title}</td>
              <td rowspan="${rowspan}"><a href="${item.link}" target="_blank">Link</a></td> <td rowspan="${rowspan}">${item.outlet}</td>
              <td rowspan="${rowspan}">${item.region || ''}</td> <td rowspan="${rowspan}">${item.country}</td> <td rowspan="${rowspan}">${item.context}</td>
              <td rowspan="${rowspan}">${item.category}</td>
              <td rowspan="${rowspan}">${item.dataUse.join(', ')}</td>
              <td>${pair.provider}</td>
              <td>${pair.platform}</td>
              <td rowspan="${rowspan}">${item.representation}</td>
              <td>${pair.resolution}</td>
              <td rowspan="${rowspan}">${item.viz}</td>
              <td rowspan="${rowspan}">${item.interaction}</td>
              <td rowspan="${rowspan}">${item.howTo || ''}</td> `;
          } else {
            // Subsequent rows for this article, only show provider-specific columns
            row.innerHTML = `
              <td>${pair.provider}</td>
              <td>${pair.platform}</td>
              <td>${pair.resolution}</td>
            `;
          }
          tbody.appendChild(row);
          displayedRowCount++;
        });
      });
      updateFilterCount(displayedRowCount); // Update count based on actual rendered rows
    }
    
    // Helper function to apply all filters to a specific item and its provider pair
    function applyAllFiltersToItemAndPair(item, pair) {
        if (!filtersActive) return true; // If filters are inactive, always return true

        const outletPills = document.querySelectorAll('.pill[data-type="outlet"].active');
        const allOutletsActive = Array.from(outletPills).some(pill => pill.getAttribute('data-value') === 'all');
        const selectedOutlets = Array.from(outletPills)
            .map(pill => pill.getAttribute('data-value'))
            .filter(value => value !== 'all');
        
        const providerPills = document.querySelectorAll('.pill[data-type="provider"].active');
        const allProvidersActive = Array.from(providerPills).some(pill => pill.getAttribute('data-value') === 'all');
        const selectedProviders = Array.from(providerPills)
            .map(pill => pill.getAttribute('data-value'))
            .filter(value => value !== 'all');

        const resolutionCategoryPills = document.querySelectorAll('.pill[data-type="resolutionCategory"].active');
        const allResolutionCategoriesActive = Array.from(resolutionCategoryPills).some(pill => pill.getAttribute('data-value') === 'all');
        const selectedResolutionCategories = Array.from(resolutionCategoryPills)
            .map(pill => pill.getAttribute('data-value'))
            .filter(value => value !== 'all');

        const yearsPills = document.querySelectorAll('.pill[data-type="years"].active');
        const allYearsActive = Array.from(yearsPills).some(pill => pill.getAttribute('data-value') === 'all');
        const currentSelectedYears = Array.from(yearsPills)
                                    .map(pill => pill.getAttribute('data-value'))
                                    .filter(value => value !== 'all');
        selectedYears = currentSelectedYears.length === 0 && !allYearsActive ? ['all'] : currentSelectedYears; 

        const fromYearInput = document.getElementById('fromYearInput');
        const toYearInput = document.getElementById('toYearInput');
        const fromYear = fromYearInput.value ? parseInt(fromYearInput.value) : null;
        const toYear = toYearInput.value ? parseInt(toYearInput.value) : null;

        const vizPills = document.querySelectorAll('.pill[data-type="viz"].active');
        const allVizActive = Array.from(vizPills).some(pill => pill.getAttribute('data-value') === 'all');
        const selectedViz = Array.from(vizPills)
            .map(pill => pill.getAttribute('data-value'))
            .filter(value => value !== 'all');

        const outletMatch = allOutletsActive || selectedOutlets.includes(item.outlet);
        const providerMatch = allProvidersActive || selectedProviders.includes(pair.provider);
        const resolutionCategoryMatch = allResolutionCategoriesActive || selectedResolutionCategories.includes(pair.resolutionCategory);

        // Updated region and country (formerly focus) matching
        const regionMatch = (selectedRegion === 'all' || item.region === selectedRegion); 
        const countryMatch = (selectedFocuses.includes('all') || selectedFocuses.includes(item.country)); 
        
        const dataUseYearMatch = allYearsActive || item.dataUse.some(year => selectedYears.includes(year));

        let publicationYearMatch = true;
        if (item.date) {
            const publicationYear = parseInt(item.date.substring(0, 4));
            if (!isNaN(publicationYear)) {
                if (fromYear !== null && publicationYear < fromYear) {
                    publicationYearMatch = false;
                }
                if (toYear !== null && publicationYear > toYear) {
                    publicationYearMatch = false;
                }
            } else {
                if (fromYear !== null || toYear !== null) {
                  publicationYearMatch = false;
                }
            }
        } else {
            if (fromYear !== null || toYear !== null) {
              publicationYearMatch = false;
            }
        }
        const vizMatch = allVizActive || selectedViz.includes(item.viz);

        return outletMatch && providerMatch && resolutionCategoryMatch && regionMatch && countryMatch && dataUseYearMatch && publicationYearMatch && vizMatch;
    }

    function filterTable() {
        renderTable(); // Re-render the entire table based on current filters
    }
    
    function updateFilterCount(filteredCount) {
      const totalCount = allData.flatMap(item => item.providerResolutionPairs).length; // Total number of individual provider-resolution pairs
      const statsDisplay = document.getElementById('statsDisplay');
      if (statsDisplay) {
        if (filteredCount === totalCount) {
          statsDisplay.innerHTML = `Articles: ${totalCount}`;
        } else {
          statsDisplay.innerHTML = `Articles: ${filteredCount}/${totalCount}`;
        }
      }
    }
  </script>
</body>
</html>