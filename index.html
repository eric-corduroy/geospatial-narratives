<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Geospatial Narratives</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Geist:wght@100..900&family=Geist+Mono:wght@100..900&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200&icon_names=filter_list" />
  <link rel="icon" type="image/png" href="circle.png">
  <style>
    /* Add box-sizing to all elements for consistent box model behavior */
    *, *::before, *::after {
      box-sizing: border-box;
    }

    /* Text selection styling */
    ::selection {
      background: rgb(221, 255, 109); /* Red background when selecting text */
      color: rgb(0, 0, 0); /* White text on selection */
    }

    body {
      font-family: 'Geist Mono', monospace;
      background: #f2f2f2;
      margin: 0;
      padding: 0;
      overflow: hidden; /* Prevents body from scrolling horizontally */
      display: flex;
      flex-direction: column;
      height: 100vh;
      text-rendering: optimizeLegibility; /* Added for legibility */
    }
    .nav {
      display: flex;
      justify-content: flex-start;
      align-items: center;
      padding: 3px 40px 3px 20px; /* Increased top padding to move lower */
      font-size: 17.5px;
      font-weight: 450;
      color: #000;
      gap: 10px;
      background: rgb(221, 255, 109);
    }
    .nav a {
      font-size: 17.5px;
      font-weight: 450;
      color: rgb(155, 180, 72);
      border-bottom: none;
      padding: 5px 10px;
    }
    .nav a:hover {
      color: #000;
    }
    .nav a.active {
      color: #000; /* Changed from #5f56ff to #000 */
    }
  
    .csv-upload {
      display: none;
    }

       /* New style for the update date */
    .update-date {
        font-family: 'Geist Mono', monospace;
        font-size: 15px; /* Smaller font size for date */
        font-weight: 300;
        color: #9f9e9e; /* Softer color for date */
        padding: 10px 0 0 29px; /* Padding to position it */
    }

    .stats {
      font-size: 96px; /* Same as the counter text */
      font-weight: 400;
      padding-top: 20px;
      padding-bottom: 10px;
      padding-left: 20px;
      color: #000;
    }
    .filter-container {
      padding: 0;
      background: #f2f2f2;
      /* border-top: 1px solid #000; /* Removed line on top */
    }
    .filter-group {
      background: #fff;
      border: none;
      border-radius: 0;
      margin-bottom: 0;
      overflow: hidden;
    }
    .filter-group:not(:first-child) {
      border-top: 1px solid #000;
    }
    .filter-group-header {
      padding: 6px 20px; /* Adjusted padding */
      font-size: 18px;
      font-weight: 500;
      background: #e6e6e6;
      cursor: pointer;
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-bottom: none;
      color: #999; /* Faint grey when inactive */
      /* transition: color 0.3s ease; /* Smooth transition for color change - removed */
    }

    /* New rule for filter group headers when filters are generally active */
    body.filters-active .filter-group-header {
        color: #000; /* Black when main filter toggle is on */
    }


    .filter-group-content {
      max-height: 0;
      overflow: hidden;
      transition: max-height 0.3s ease-out;
      padding: 0 20px;
      background-color: #e6e6e6;
    }
    .filter-group.active .filter-group-content {
      max-height: 600px; /* Keep this to allow content to expand, actual height is content-driven */
      padding-bottom: 10px; /* Adjusted padding */
    }
    .filter-title {
      font-size: 14px; /* Made smaller */
      font-weight: 500;
      margin-top: 10px; /* Reduced space */
      margin-bottom: 5px; /* Reduced space */
      color: #666; /* Closer to background gray */
    }
    .filter-group-content .filter-title:first-of-type {
        margin-top: 0;
    }
    .filter-pills {
      display: flex;
      flex-wrap: nowrap; /* Ensures horizontal scrolling */
      gap: 8px;
      overflow-x: auto; /* Enables horizontal scrolling */
      padding-bottom: 8px;
      -webkit-overflow-scrolling: touch; /* Smoother scrolling on iOS */
    }
    .filter-pills::-webkit-scrollbar {
        display: none; /* Hide scrollbar for Webkit browsers */
    }
    .filter-pills {
        -ms-overflow-style: none; /* Hide scrollbar for IE/Edge */
        scrollbar-width: none; /* Hide scrollbar for Firefox */
    }
    .pill {
      flex-shrink: 0;
      padding: 6px 12px;
      border-radius: 16px;
      border: 1px solid #999;
      background: transparent;
      cursor: pointer;
      font-size: 13px;
      transition: all 0.2s ease;
      color: #000;
    }
    .pill:hover {
      background: rgba(0, 0, 0, 0.1);
    }
    .pill.active {
      background: #000; /* Changed from #5f56ff to #000 */
      color: white;
      border-color: #000; /* Changed from #5f56ff to #000 */
    }
    .year-range-filter {
      display: flex;
      gap: 10px;
      margin-top: 8px;
      align-items: center; /* Vertically align items */
    }
    .year-range-filter input[type="number"] {
      padding: 6px 10px;
      border: 1px solid #999;
      background: transparent;
      border-radius: 10px;
      font-size: 13px;
      width: 80px;
      color: #000;
      
    }
    .table-view-container, .feed-view-container {
      margin: 0;
      flex-grow: 1;
      overflow-y: auto;
      /* overflow-x: auto; This was removed to prevent horizontal scroll */
      position: relative;
      background: #f2f2f2;
     padding-bottom: 50px;
    }
    table {
      width: 100%;
      /* min-width: 1200px; This was removed as we are adjusting font size instead of scrolling */
      border-collapse: collapse;
      background: #fff;
      table-layout: fixed;
    }
    th {
      text-align: left;
      padding: 4px 12px;
      border-bottom: 1px solid #D3D3D3;
      border-top: 1px solid #D3D3D3;
      font-family: 'Geist Mono', monospace;
      vertical-align: top;
      font-size: 13px; /* Base font size */
      font-weight: 500;
      word-wrap: break-word; /* Allows text to break to the next line */
    }
    td {
      text-align: left;
      padding: 4px 12px;
      border-bottom: 1px solid #D3D3D3;
      border-top: 1px solid #D3D3D3;
      font-family: 'Geist Mono', monospace;
      vertical-align: top;
      font-size: 13px; /* Base font size */
      font-weight: 400;
      word-wrap: break-word; /* Allows text to break to the next line */
    }
    /* Specific styles for columns 1-7 (Narrative-specific data) */
    th:nth-child(-n+7),
    td:nth-child(-n+7) {
      border-bottom: 1px solid #000;
    }
    th:nth-child(-n+7) {
      border-top: none; /* No top border for header cells in columns 1-7 */
    }
    td:nth-child(-n+7) {
      border-top: 1px solid #000;
    }

    /* Fixed width for specific columns */
    th:nth-child(1),
    td:nth-child(1) {
      width: 6%; /* Date */
      min-width: 6%;
      max-width: 6%;
    }
    th:nth-child(2),
    td:nth-child(2) {
      width: 13%; /* Title */
      min-width: 13%;
      max-width: 13%;
    }
    th:nth-child(3),
    td:nth-child(3) {
      width: 3.5%; /* Link */
      min-width: 3.5%;
      max-width: 3.5%;
    }
    th:nth-child(4),
    td:nth-child(4) {
      width: 9%; /* Outlet */
      min-width: 9%;
      max-width: 9%;
    }
    th:nth-child(5),
    td:nth-child(5) {
      width: 7%; /* Country */
      min-width: 7%;
      max-width: 7%;
    }
    th:nth-child(6),
    td:nth-child(6) {
      width: 9.5%; /* Context */
      min-width: 9.5%;
      max-width: 9.5%;
    }
    th:nth-child(7),
    td:nth-child(7) {
      width: 7.5%; /* Category */
      min-width: 7.5%;
      max-width: 7.5%;
    }
    /* Fixed width for Data Detail Columns (8-14) */
    th:nth-child(8),
    td:nth-child(8) {
      width: 3%; /* Data use */
      min-width: 3%;
      max-width: 3%;
    }
    th:nth-child(9),
    td:nth-child(9) {
      width: 6%; /* Provider */
      min-width: 6%;
      max-width: 6%;
    }
    th:nth-child(10),
    td:nth-child(10) {
      width: 5.5%; /* Platform */
      min-width: 5.5%;
      max-width: 5.5%;
    }
    th:nth-child(11), /* Sensor (Representation) */
    td:nth-child(11) {
      width: 5.5%; /* Was 7% */
      min-width: 5.5%;
      max-width: 5.5%;
    }
    th:nth-child(12), /* New: Domain */
    td:nth-child(12) {
      width: 5%; /* New */
      min-width: 5%;
      max-width: 5%;
    }
    th:nth-child(13), /* Res (Resolution) */
    td:nth-child(13) {
      width: 4.5%; /* Was 4% */
      min-width: 4.5%;
      max-width: 4.5%;
    }
    th:nth-child(14), /* Viz */
    td:nth-child(14) {
      width: 4%; /* Keep */
      min-width: 4%;
      max-width: 4%;
    }

    thead {
      position: sticky;
      top: 0;
      z-index: 10;
    }
    th {
      background: #000;
      color: white;
      border-top: none;
      border-bottom: 1px solid #000;
    }
    /* Explicitly left align headers of columns 8-14 and make them black */
    th:nth-child(n+8) {
      background-color: #000;
      text-align: left;
    }
    /* Left align content of columns 8-14 */
    td:nth-child(n+8) {
      text-align: left;
    }
    a {
      color: #997b21;
      text-decoration: none;
      border-bottom: none;
    }
    .month {
      color: gray;
    }
    .provider-item {
      display: block;
      margin-bottom: 4px;
      padding-bottom: 4px;
    }
    .provider-item:not(:last-child) {
      border-bottom: 1px solid #ddd;
    }
    .provider-resolution-group {
      font-size: 12px;
      line-height: 1.4;
    }

    /* Toggle Switches Container */
    .toggles-container {
      background: #f2f2f2;
      padding: 0 40px 10px 20px;
      display: flex;
      justify-content: flex-start;
      align-items: center;
      gap: 20px;
      margin-top: 10px;
    }

    .filter-toggle-group, .feed-toggle-group {
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .filter-toggle-label, .feed-toggle-label {
      font-size: 18px;
      font-weight: 500;
      color: #000000;
    }

    /* The switch - the box around the slider */
    .switch {
      position: relative;
      display: inline-block;
      width: 40px;
      height: 24px;
    }

    /* Hide default HTML checkbox */
    .switch input {
      opacity: 0;
      width: 0;
      height: 0;
    }

    /* The slider */
    .slider {
      position: absolute;
      cursor: pointer;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: #ccc;
      -webkit-transition: .4s;
      transition: .4s;
      border-radius: 24px;
    }

    .slider:before {
      position: absolute;
      content: "";
      height: 18px;
      width: 18px;
      left: 3px;
      bottom: 3px;
      background-color: white;
      -webkit-transition: .4s;
      transition: .4s;
      border-radius: 50%;
    }

    input:checked + .slider {
      background-color: #000;
    }

    input:focus + .slider {
      box-shadow: 0 0 1px #000;
    }

    input:checked + .slider:before {
      -webkit-transform: translateX(16px);
      -ms-transform: translateX(16px);
      transform: translateX(16px);
    }

    /* Overlay styles */
    .overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: transparent;
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 1000;
      font-size: 10em;
      font-weight: bold;
      color: #333;
      text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
      pointer-events: none;
      opacity: 1;
      transition: opacity 0.5s ease-out;
    }
    .overlay.hidden {
      opacity: 0;
      visibility: hidden;
    }

    /* Specific styles for data detail columns */
    .data-detail-cell {
      font-size: 13px; /* Base font size */
      padding: 4px 8px;
      background-color: rgb(221, 255, 109);
      padding-left: 12px;
    }

    /* Light grey top border for the first row of each article, across all columns */
    tr.article-start td {
      border-top: 1px solid #D3D3D3;
    }

    /* FIX: Override the light grey top border for data-detail-cells when it's the article start */
    tr.article-start .data-detail-cell {
        border-top: 1px solid #000;
    }

    /* Black bottom border for the last data point row of an article, across all columns */
    tr.last-cdp-of-article td {
      border-bottom: 1px solid #000;
    }
    /* Ensure data-detail-cell gets a black bottom border if it's the last data point of an article */
    tr.last-cdp-of-article .data-detail-cell {
        border-bottom: 1px solid #000;
    }

    /* Override for data-detail-cells that are NOT the last cdp of an article */
    /* This ensures they maintain light grey bottom borders if they are intermediate rows */
    tr:not(.last-cdp-of-article) .data-detail-cell {
        border-bottom: 1px solid rgba(0, 0, 0, 0.2);
    }

    /* Show/Hide View Containers */
    .table-view-container.hidden,
    .feed-view-container.hidden {
      display: none;
    }

    /* Feed View Specific Styles (similar to quote-only view) */
    .feed-view-container {
      padding: 20px 40px;
      background: #fff;
      overflow-y: auto;
      border-top: 1px solid #000;
    }

    .feed-view-container .article-item {
      font-size: 80px; /* Increased font size, similar to quotes */
      font-weight: 500;
      margin-bottom: 20px;
      line-height: 1.2;
      color: #000000;
      border-bottom: 1px solid #eee; /* Light separator */
      padding-bottom: 15px;
      cursor: pointer; /* Clickable */
      display: flex; /* Changed to flex to align details to bottom */
      flex-direction: column; /* Stack title and details vertically */
      justify-content: flex-start; /* Align content to the start (top) */
      text-decoration: none; /* Remove underline from link */
      text-transform: uppercase; /* All caps */
      white-space: normal; /* Allow text to wrap */
      overflow: visible; /* Allow content to be visible */
      text-overflow: clip; /* Remove ellipsis */
      font-family: 'Geist', sans-serif; /* Use Geist font */
      text-rendering: geometricPrecision; /* Added for geometric precision */
      word-spacing: normal; /* Default value */
      letter-spacing: normal; /* Default value */
    }

    .feed-view-container .article-item:last-child {
      border-bottom: none; /* No border for the last item */
      margin-bottom: 0;
    }
    .feed-view-container .article-item a {
        color: inherit; /* Inherit color from parent div */
        text-decoration: none; /* No underline */
    }

    .article-details {
      font-size: 14px; /* Details font size */
      font-weight: 350; /* Not bold */
      color: #969696; /* A bit lighter color for details */
      margin-top: 5px; /* Reduced space above details */
      text-align: left; /* Aligned to the left */
      text-transform: none; /* Details should not be all caps */
      padding-left: 10px; /* Small indent */
      font-family: 'Geist Mono', monospace; /* Use Geist Mono for details */
    }

    /* Spacing for article count numbers */
    .article-count-number {
      margin-left: 30px; /* Default for desktop */
    }

    sup .article-count-number {
      margin-left: 1px; /* Default for desktop superscript */
    }

    /* New CSS for Material Symbols */
    .material-symbols-outlined {
      font-variation-settings:
      'FILL' 0,
      'wght' 400,
      'GRAD' 0,
      'opsz' 24
    }
      .tba-text {
    color: #B2CC70; /* Or any color you prefer, e.g., orange, red, etc. */
  }

    /* --- Responsive Design --- */

    /* New media query for screens smaller than or equal to 1600px */
    @media (max-width: 1600px) {
      th, td, .data-detail-cell {
        font-size: 11.5px; /* 11pt equivalent for smaller screens */
      }
    }

    /* For screens smaller than 768px (tablets and smaller) */
    @media (max-width: 1268px) {
      .nav {
        padding: 15px 20px 15px 15px;
        font-size: 18px;
        gap: 5px;
      }
      .nav a {
        font-size: 18px;
        padding: 3px 8px;
      }
    
      .stats {
        font-size: 60px;
        padding: 15px 20px 5px 20px;
      }
      .toggles-container {
        padding: 0 20px 10px 15px;
        gap: 15px;
      }
      .filter-toggle-label, .feed-toggle-label {
        font-size: 16px;
      }
      .filter-group-header {
        font-size: 16px;
        padding: 6px 15px; /* Adjusted padding */
      }
      .filter-group-content {
        padding: 0 15px;
      }
      .filter-title {
        font-size: 12px;
      }
      .pill {
        font-size: 12px;
        padding: 5px 10px;
      }
      .year-range-filter input[type="number"] {
        font-size: 12px;
        width: 60px;
      }

      /* HIDE ALL COLUMNS FROM THE 5TH ONWARDS FOR SMALL VIEWPORT (Columns 8-14 are hidden) */
      th:nth-child(n+5),
      td:nth-child(n+5) {
        display: none;
      }

      /* Adjust widths for the first four visible columns to fill the viewport */
      th:nth-child(1),
      td:nth-child(1) {
        width: 20%; /* Date */
        min-width: 20%;
        max-width: 20%;
      }
      th:nth-child(2),
      td:nth-child(2) {
        width: 40%; /* Title */
        min-width: 40%;
        max-width: 40%;
      }
      th:nth-child(3),
      td:nth-child(3) {
        width: 15%; /* Link */
        min-width: 15%;
        max-width: 15%;
      }
       th:nth-child(4),
      td:nth-child(4) {
        width: 25%; /* Outlet */
        min-width: 25%;
        max-width: 25%;
      }

      th, td {
        font-size: 12px; /* Adjusted to 10px for even smaller screens */
        padding: 6px 8px;
      }
      .overlay {
        font-size: 7em;
      }
      .data-detail-cell {
        font-size: 0px; /* Adjusted for consistency */
        padding: 0px 0px;
      }
      .feed-view-container {
        padding: 15px 20px;
      }
      .feed-view-container .article-item {
        font-size: 40px; /* Half of 80px -> 40px */
        margin-bottom: 15px;
        padding-bottom: 10px;
      }
      .article-details {
        font-size: 12px; /* Smaller details font size */
        margin-top: 8px;
        padding-left: 8px;
      }
    }

   /* For screens smaller than 480px (mobile phones) */
    @media (max-width: 480px) {
      .nav {
        padding: 5px 20px 5px 5px;
        font-size: 18px;
        gap: 5px;
      }
      .nav a {
        font-size: 17px;
        padding: 3px 8px;
      }
      .update-date {
        font-size: 12px;
        padding: 10px 0 0 13px;
      }
      .stats {
        font-size: 42px;
        padding-top: 17px;
        padding-left: 1.5px;
        padding-bottom: 10px;
        padding-left: 10px;
      }
      .toggles-container {
        padding: 0 20px 10px 12px;
        gap: 15px;
      }
      .filter-toggle-label, .feed-toggle-label {
        font-size: 16px;
      }
      .filter-group-header {
        font-size: 16px;
        padding: 6px 15px; /* Adjusted padding */
      }
      .filter-group-content {
        padding: 0 15px;
      }
      .filter-title {
        font-size: 12px;
      }
      .pill {
        font-size: 12px;
        padding: 5px 10px;
      }
      .year-range-filter input[type="number"] {
        font-size: 12px;
        width: 60px;
        padding: 5px 15px;
      }

      /* HIDE ALL COLUMNS FROM THE 4TH ONWARDS FOR SMALL VIEWPORT */
      th:nth-child(n+4),
      td:nth-child(n+4) {
        display: none;
      }

      /* Adjust widths for the first three visible columns to fill the viewport */
      th:nth-child(1),
      td:nth-child(1) {
        width: 24%; /* Date */
        min-width: 24%;
        max-width: 24%;
      }
      th:nth-child(2),
      td:nth-child(2) {
        width: 61%; /* Title */
        min-width: 61%;
        max-width: 61%;
      }
      th:nth-child(3),
      td:nth-child(3) {
        width: 15%; /* Link */
        min-width: 15%;
        max-width: 15%;
      }

      th, td {
        font-size: 12px; /* Adjusted to 10px for even smaller screens */
        line-height: 1.3;
        padding: 6px 8px;
      }
      .overlay {
        font-size: 7em;
      }
      .data-detail-cell {
        font-size: 0px; /* Adjusted for consistency */
        padding: 0px 0px;
      }
      .feed-view-container {
        padding: 10px 15px;
      }
      .feed-view-container .article-item {
        font-size: 23px; /* Adjusted for responsive */
        letter-spacing: -0.025em;
        line-height: 1.3;
        font-weight: medium;
        margin-bottom: 10px;
        padding-bottom: 8px;
      }
      .article-details {
        font-size: 11px; /* Even smaller details font size */
        margin-top: 5px;
        padding-left: 1px;
      }

      /* Mobile-specific spacing for article count numbers */
      .article-count-number {
        margin-left: 8px;
      }

      sup .article-count-number {
        margin-left: 0px;
        font-size: 75%; /* Adjust as needed, e.g., 60% for slightly larger */
        position: relative;
        top: -0.2em;
      }
    }
  </style>
</head>
<body>
  <div id="fixed-header-area">
    <div class="nav">
      <a href="index.html" class="active">Index</a>
      <a href="literacy.html">Literacy</a>
      <a href="about.html">About</a>
    </div>
      <div class="update-date">
        updated: 2025-09-17
    </div>
    <div class="stats">
      <span id="loadingStatus">Loading data...</span>
      <div id="statsDisplay" style="display: none;"></div>
    </div>

    <div class="toggles-container">
        <div class="filter-toggle-group">
            <span class="filter-toggle-label"><span class="material-symbols-outlined">filter_list</span></span>
            <label class="switch">
                <input type="checkbox" id="filterToggle">
                <span class="slider"></span>
            </label>
        </div>
        <div class="feed-toggle-group">
            <span class="feed-toggle-label">FEED</span>
            <label class="switch">
                <input type="checkbox" id="feedToggle">
                <span class="slider"></span>
            </label>
        </div>
    </div>

    <div class="filter-container">
      <div class="filter-group" id="narrative-group">
          <div class="filter-group-header">NARRATIVE</div>
          <div class="filter-group-content">
              <div class="filter-title">Publication Year Range:</div>
              <div class="year-range-filter">
                  <button class="pill active" data-type="publicationYear" data-value="all">All</button>
                  <input type="number" id="fromYearInput" placeholder="Year">
                  <input type="number" id="toYearInput" placeholder="Year">
              </div>

              <div class="filter-title">Region:</div>
              <div class="filter-pills" id="region-filter-pills">
                  <button class="pill active" data-type="region" data-value="all">All</button>
                  <button class="pill" data-type="region" data-value="Africa">Africa</button>
                  <button class="pill" data-type="region" data-value="Asia">Asia</button>
                  <button class="pill" data-type="region" data-value="Europe">Europe</button>
                  <button class="pill" data-type="region" data-value="North America">North America</button>
                  <button class="pill" data-type="region" data-value="South America">South America</button>
                  <button class="pill" data-type="region" data-value="Oceania">Oceania</button>
                  
              </div>

              <div id="focus-filter-section" style="display: none;">
                  <div class="filter-title">Country/Area:</div>
                  <div class="filter-pills" id="focus-filter-pills">
                      <button class="pill active" data-type="focus" data-value="all">All</button>
                      </div>
              </div>
          </div>
      </div>

      <div class="filter-group" id="data-group">
          <div class="filter-group-header">DATA</div>
          <div class="filter-group-content">
              <div class="filter-title">Resolution:</div>
              <div class="filter-pills" id="meters-filter-pills">
                  <button class="pill active" data-type="resolutionCategory" data-value="all">All</button>
                  <button class="pill" data-type="resolutionCategory" data-value="<1m">&lt;1m</button>
                  <button class="pill" data-type="resolutionCategory" data-value="1-5m">1-5m</button>
                  <button class="pill" data-type="resolutionCategory" data-value="5-30m">5-30m</button>
                  <button class="pill" data-type="resolutionCategory" data-value="30-250m">30-250m</button>
                  <button class="pill" data-type="resolutionCategory" data-value="250m-1km">250m-1km</button>
                  <button class="pill" data-type="resolutionCategory" data-value=">1km">&gt;1km</button>
                  </div>

              <div class="filter-title">Visualization:</div>
              <div class="filter-pills" id="viz-filter-pills">
                  <button class="pill active" data-type="viz" data-value="all">All</button>
              </div>

              <div class="filter-title">Representation:</div>
              <div class="filter-pills" id="representation-filter-pills">
                  <button class="pill active" data-type="representation" data-value="all">All</button>
              </div>

              <div class="filter-title">Domain:</div>
              <div class="filter-pills" id="domain-filter-pills">
                  <button class="pill active" data-type="domain" data-value="all">All</button>
              </div>

              <div class="filter-title">Data Use Year:</div>
              <div class="filter-pills" id="years-filter-pills">
                  <button class="pill active" data-type="years" data-value="all">All</button>
                  </div>
          </div>
      </div>

      <div class="filter-group" id="source-group">
          <div class="filter-group-header">SOURCE</div>
          <div class="filter-group-content">
              <div class="filter-title">Outlet:</div>
              <div class="filter-pills" id="outlet-filter-pills">
                  <button class="pill active" data-type="outlet" data-value="all">All</button>
                  <button class="pill" data-type="outlet" data-value="The New York Times">The New York Times</button>
                  <button class="pill" data-type="outlet" data-value="Washington Post">Washington Post</button>
                  <button class="pill" data-type="outlet" data-value="The Guardian">The Guardian</button>
                  <button class="pill" data-type="outlet" data-value="BBC">BBC</button>
                  <button class="pill" data-type="outlet" data-value="CNN">CNN</button>
                  <button class="pill" data-type="outlet" data-value="Reuters">Reuters</button>
                  <button class="pill" data-type="outlet" data-value="Sky News">Sky News</button>
              </div>

              <div class="filter-title">Provider:</div>
              <div class="filter-pills" id="provider-filter-pills">
                  <button class="pill active" data-type="provider" data-value="all">All</button>
                  <button class="pill" data-type="provider" data-value="Planet Labs">Planet Labs</button>
                  <button class="pill" data-type="provider" data-value="Maxar">Maxar</button>
                  <button class="pill" data-type="provider" data-value="ESA">ESA</button>
                  <button class="pill" data-type="provider" data-value="NASA">NASA</button>
                  <button class="pill" data-type="provider" data-value="USGS">USGS</button>
                  <button class="pill" data-type="provider" data-value="Airbus">Airbus</button>
              </div>
          </div>
      </div>
    </div>
  </div>

  <div id="tableViewContainer" class="table-view-container">
    <table>
      <thead>
        <tr>
          <th>Date</th>
          <th>Title</th>
          <th>Link</th> <th>Outlet</th>
          <th>Country</th> <th>Context</th>
          <th>Category</th>
          <th>Use</th>
          <th>Provider</th>
          <th>Platform</th>
          <th>Sensor</th>
          <th>Domain</th> <th>Res</th>
          <th>Viz</th>
          </tr>
      </thead>
      <tbody>
        </tbody>
    </table>
  </div>

  <div id="feedViewContainer" class="feed-view-container hidden">
    </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
  <script>
    let allData = [];
    let selectedRegion = 'all';
    let selectedFocuses = ['all'];
    let selectedYears = ['all'];
    let filtersActive = false;
    let currentView = 'table'; // 'table' or 'feed'

    const countryRegions = {
  'Afghanistan': 'Asia',
  'Albania': 'Europe',
  'Algeria': 'Africa',
  'Andorra': 'Europe',
  'Angola': 'Africa',
  'Antigua and Barbuda': 'North America',
  'Argentina': 'South America',
  'Armenia': 'Asia',
  'Australia': 'Oceania',
  'Austria': 'Europe',
  'Azerbaijan': 'Asia',
  'Bahamas': 'North America',
  'Bahrain': 'Asia',
  'Bangladesh': 'Asia',
  'Barbados': 'North America',
  'Belarus': 'Europe',
  'Belgium': 'Europe',
  'Belize': 'North America',
  'Benin': 'Africa',
  'Bhutan': 'Asia',
  'Bolivia, Plurinational State of': 'South America',
  'Bosnia and Herzegovina': 'Europe',
  'Botswana': 'Africa',
  'Brazil': 'South America',
  'Brunei Darussalam': 'Asia',
  'Bulgaria': 'Europe',
  'Burkina Faso': 'Africa',
  'Burundi': 'Africa',
  'Cabo Verde': 'Africa',
  'Cambodia': 'Asia',
  'Cameroon': 'Africa',
  'Canada': 'North America',
  'Central African Republic': 'Africa',
  'Chad': 'Africa',
  'Chile': 'South America',
  'China': 'Asia',
  'Colombia': 'South America',
  'Comoros': 'Africa',
  'Congo': 'Africa',
  'Congo, The Democratic Republic of the': 'Africa',
  'Costa Rica': 'North America',
  'Croatia': 'Europe',
  'Cuba': 'North America',
  'Cyprus': 'Asia',
  'Czechia': 'Europe',
  'Côte d\'Ivoire': 'Africa',
  'Denmark': 'Europe',
  'Djibouti': 'Africa',
  'Dominica': 'North America',
  'Dominican Republic': 'North America',
  'Ecuador': 'South America',
  'Egypt': 'Africa',
  'El Salvador': 'North America',
  'Equatorial Guinea': 'Africa',
  'Eritrea': 'Africa',
  'Estonia': 'Europe',
  'Eswatini': 'Africa',
  'Ethiopia': 'Africa',
  'Fiji': 'Oceania',
  'Finland': 'Europe',
  'France': 'Europe',
  'Gabon': 'Africa',
  'Gambia': 'Africa',
  'Gaza Strip': 'Asia',
  'Georgia': 'Asia',
  'Germany': 'Europe',
  'Ghana': 'Africa',
  'Greece': 'Europe',
  'Grenada': 'North America',
  'Guatemala': 'North America',
  'Guinea': 'Africa',
  'Guinea-Bissau': 'Africa',
  'Guyana': 'South America',
  'Haiti': 'North America',
  'Honduras': 'North America',
  'Hungary': 'Europe',
  'Iceland': 'Europe',
  'India': 'Asia',
  'Indonesia': 'Asia',
  'Iran': 'Asia',
  'Iraq': 'Asia',
  'Ireland': 'Europe',
  'Israel': 'Asia',
  'Italy': 'Europe',
  'Jamaica': 'North America',
  'Japan': 'Asia',
  'Jordan': 'Asia',
  'Kazakhstan': 'Asia',
  'Kenya': 'Africa',
  'Kiribati': 'Oceania',
  'Korea, Democratic People\'s Republic of': 'Asia',
  'Korea, Republic of': 'Asia',
  'Kuwait': 'Asia',
  'Kyrgyzstan': 'Asia',
  'Lao People\'s Democratic Republic': 'Asia',
  'Latvia': 'Europe',
  'Lebanon': 'Asia',
  'Lesotho': 'Africa',
  'Liberia': 'Africa',
  'Libya': 'Africa',
  'Liechtenstein': 'Europe',
  'Lithuania': 'Europe',
  'Luxembourg': 'Europe',
  'Madagascar': 'Africa',
  'Malawi': 'Africa',
  'Malaysia': 'Asia',
  'Maldives': 'Asia',
  'Mali': 'Africa',
  'Malta': 'Europe',
  'Marshall Islands': 'Oceania',
  'Mauritania': 'Africa',
  'Mauritius': 'Africa',
  'Mexico': 'North America',
  'Micronesia, Federated States of': 'Oceania',
  'Moldova, Republic of': 'Europe',
  'Monaco': 'Europe',
  'Mongolia': 'Asia',
  'Montenegro': 'Europe',
  'Morocco': 'Africa',
  'Mozambique': 'Africa',
  'Myanmar': 'Asia',
  'Namibia': 'Africa',
  'Nauru': 'Oceania',
  'Nepal': 'Asia',
  'Netherlands': 'Europe',
  'New Zealand': 'Oceania',
  'Nicaragua': 'North America',
  'Niger': 'Africa',
  'Nigeria': 'Africa',
  'North Macedonia': 'Europe',
  'Norway': 'Europe',
  'Oman': 'Asia',
  'Pakistan': 'Asia',
  'Palau': 'Oceania',
  'Palestine, State of': 'Asia',
  'Panama': 'North America',
  'Papua New Guinea': 'Oceania',
  'Paraguay': 'South America',
  'Peru': 'South America',
  'Philippines': 'Asia',
  'Poland': 'Europe',
  'Portugal': 'Europe',
  'Qatar': 'Asia',
  'Romania': 'Europe',
  'Russian Federation': 'Europe',
  'Rwanda': 'Africa',
  'Saint Kitts and Nevis': 'North America',
  'Saint Lucia': 'North America',
  'Saint Vincent and the Grenadines': 'North America',
  'Samoa': 'Oceania',
  'San Marino': 'Europe',
  'Sao Tome and Principe': 'Africa',
  'Saudi Arabia': 'Asia',
  'Senegal': 'Africa',
  'Serbia': 'Europe',
  'Seychelles': 'Africa',
  'Sierra Leone': 'Africa',
  'Singapore': 'Asia',
  'Slovakia': 'Europe',
  'Slovenia': 'Europe',
  'Solomon Islands': 'Oceania',
  'Somalia': 'Africa',
  'South Africa': 'Africa',
  'South Sudan': 'Africa',
  'Spain': 'Europe',
  'Sri Lanka': 'Asia',
  'Sudan': 'Africa',
  'Suriname': 'South America',
  'Sweden': 'Europe',
  'Switzerland': 'Europe',
  'Syria': 'Asia',
  'Tajikistan': 'Asia',
  'Tanzania, United Republic of': 'Africa',
  'Thailand': 'Asia',
  'Timor-Leste': 'Asia',
  'Togo': 'Africa',
  'Tonga': 'Oceania',
  'Trinidad and Tobago': 'North America',
  'Tunisia': 'Africa',
  'Turkey': 'Asia',
  'Turkmenistan': 'Asia',
  'Tuvalu': 'Oceania',
  'Uganda': 'Africa',
  'Ukraine': 'Europe',
  'United Arab Emirates': 'Asia',
  'UK': 'Europe',
  'USA': 'North America',
  'Uruguay': 'South America',
  'Uzbekistan': 'Asia',
  'Vanuatu': 'Oceania',
  'Venezuela, Bolivarian Republic of': 'South America',
  'Viet Nam': 'Asia',
  'Yemen': 'Asia',
  'Zambia': 'Africa',
  'Zimbabwe': 'Africa'
    };

    // --- GLOBAL FUNCTIONS ---
    // Moved getMeterCategory here to be accessible by both loadDataFromBackend and loadSampleData
    function getMeterCategory(resolution) {
        if (!resolution) return '';
        const lowerCaseResolution = resolution.toLowerCase();
        
        // Handle exact string matches first (e.g., if the category text is directly in the data)
        if (lowerCaseResolution.includes('<1m')) return '<1m';
        if (lowerCaseResolution.includes('1-5m')) return '1-5m';
        if (lowerCaseResolution.includes('5-30m')) return '5-30m';
        if (lowerCaseResolution.includes('30-250m')) return '30-250m';
        if (lowerCaseResolution.includes('250m-1km')) return '250m-1km';
        if (lowerCaseResolution.includes('>1km')) return '>1km';

        // Numerical parsing for resolutions in meters or kilometers
        const numMatch = resolution.match(/(\d+\.?\d*)/);
        if (numMatch) {
            let res = parseFloat(numMatch[1]);
            let unit = (lowerCaseResolution.includes('km') || lowerCaseResolution.includes('kilometers')) ? 'km' : 'm';

            // Convert everything to meters for comparison
            if (unit === 'km') {
                res *= 1000;
            }

            if (res > 0 && res < 1) {
                return '<1m';
            } else if (res >= 1 && res <= 5) {
                return '1-5m';
            } else if (res > 5 && res <= 30) {
                return '5-30m';
            } else if (res > 30 && res <= 250) {
                return '30-250m';
            } else if (res > 250 && res <= 1000) { // 1000m is 1km
                return '250m-1km';
            } else if (res > 1000) {
                return '>1km';
            }
        }
        
        return '';
    }
    // --- END GLOBAL FUNCTIONS ---

    function extractYears(dataUseString) {
        if (!dataUseString) return [];
        const yearMatches = dataUseString.match(/\b\d{4}\b/g);
        return yearMatches ? Array.from(new Set(yearMatches)).sort() : [];
    }

    function adjustContentViewHeight() {
      const fixedHeader = document.getElementById('fixed-header-area');
      const togglesContainer = document.querySelector('.toggles-container');
      const tableViewContainer = document.getElementById('tableViewContainer');
      const feedViewContainer = document.getElementById('feedViewContainer'); // Changed from titleOnlyViewContainer

      if (fixedHeader && togglesContainer && (tableViewContainer || feedViewContainer)) {
        const headerHeight = fixedHeader.offsetHeight;
        const togglesHeight = togglesContainer.offsetHeight;
        const remainingHeight = `calc(100vh - ${headerHeight}px - ${togglesHeight}px)`;

        if (tableViewContainer) {
            tableViewContainer.style.height = remainingHeight;
        }
        if (feedViewContainer) { // Updated to feedViewContainer
            feedViewContainer.style.height = remainingHeight;
        }
      }
    }
    // --- END GLOBAL FUNCTIONS ---

    function checkHashForView() {
        const feedToggle = document.getElementById('feedToggle');
        const isFeedInHash = window.location.hash.includes('feed');
        
        // Update model and view state based on hash
        currentView = isFeedInHash ? 'feed' : 'table';
        
        // Update the toggle switch state
        if (feedToggle.checked !== isFeedInHash) {
            feedToggle.checked = isFeedInHash;
        }
        
        // The loadDataFromBackend will call filterTable, which will call updateView,
        // so we don't need to call updateView here unless we are handling a hashchange
        // AFTER data has loaded, which we will handle later.
        // For initial load, we just set the state before loading the data.
    }

    document.addEventListener('DOMContentLoaded', function() {
      // 1. Check hash and set initial view state immediately
      checkHashForView(); 

      // 2. Load data
      loadDataFromBackend();

      document.querySelectorAll('.filter-pills .pill').forEach(pill => {
        pill.addEventListener('click', handlePillClick);
      });

      // Event listener for the "All" button in the publication year filter
document.querySelector('.pill[data-type="publicationYear"][data-value="all"]').addEventListener('click', function () {
    document.getElementById('fromYearInput').value = '';
    document.getElementById('toYearInput').value = '';

    document.querySelectorAll('.pill[data-type="publicationYear"]').forEach(pill => {
        pill.classList.remove('active');
    });
    this.classList.add('active');

    filterTable();
});

document.getElementById('fromYearInput').addEventListener('input', function () {
    const allPill = document.querySelector('.pill[data-type="publicationYear"][data-value="all"]');
    allPill.classList.remove('active');
    filterTable();
});
document.getElementById('toYearInput').addEventListener('input', function () {
    const allPill = document.querySelector('.pill[data-type="publicationYear"][data-value="all"]');
    allPill.classList.remove('active');
    filterTable();
});


      document.querySelectorAll('.filter-group-header').forEach(header => {
        header.addEventListener('click', function() {
          const group = this.closest('.filter-group');
          if (filtersActive) {
            group.classList.toggle('active');
            adjustContentViewHeight();
          }
        });
      });

      const filterToggle = document.getElementById('filterToggle');
      filterToggle.addEventListener('change', function() {
        filtersActive = this.checked;
        if (filtersActive) {
            document.body.classList.add('filters-active');
        } else {
            document.body.classList.remove('filters-active');
        }
        toggleAllFilters(true);
        filterTable();
      });

      // Feed Toggle Switch (renamed from feedToggle/titleToggle)
      const feedToggle = document.getElementById('feedToggle');
      feedToggle.addEventListener('change', function() {
          currentView = this.checked ? 'feed' : 'table';
          
          // Update the URL hash without reloading
          if (this.checked) {
              history.pushState(null, null, '#feed');
          } else {
              history.pushState(null, null, ' '); // Clears the hash, but preserves the history entry
              // The next line is important to ensure the URL bar updates to just the path
              if (window.location.hash) {
                history.pushState("", document.title, window.location.pathname + window.location.search);
              }
          }

          updateView();
      });

      // New: Listen for hash changes (e.g., if the user uses the browser's back/forward buttons)
      window.addEventListener('hashchange', function() {
          checkHashForView(); // Read the new hash
          updateView(); // Re-render the view
      });


      const currentPath = window.location.pathname.split('/').pop();
      document.querySelectorAll('.nav a').forEach(link => {
        if (link.getAttribute('href') === currentPath && link.getAttribute('href') !== 'index.html') {
          document.querySelector('.nav a[href="index.html"]').classList.remove('active');
          link.classList.add('active');
        } else if (currentPath === '' && link.getAttribute('href') === 'index.html') {
          // This ensures index.html is active when directly loading the root or index.html
        }
      });

      adjustContentViewHeight();
      window.addEventListener('resize', adjustContentViewHeight);

      const initialOverlay = document.getElementById('initialOverlay');
      const hideOverlay = () => {
        if (initialOverlay && !initialOverlay.classList.contains('hidden')) {
          initialOverlay.classList.add('hidden');
          document.removeEventListener('mousemove', hideOverlay);
          document.removeEventListener('scroll', hideOverlay);
          document.removeEventListener('click', hideOverlay);
          document.removeEventListener('keydown', hideOverlay);
        }
      };

      document.addEventListener('mousemove', hideOverlay);
      document.addEventListener('scroll', hideOverlay);
      document.addEventListener('click', hideOverlay);
      document.addEventListener('keydown', hideOverlay);
    });

    const loadDataFromBackend = async () => {
        const loadingStatus = document.getElementById('loadingStatus');
        const statsDisplay = document.getElementById('statsDisplay');
        try {
            loadingStatus.textContent = 'Loading data from server...';
            const response = await fetch('./data.csv');
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            const csvText = await response.text();
            const parsedData = Papa.parse(csvText, { header: true, skipEmptyLines: true }).data;

            const articlesMap = new Map(); // Use a Map to group rows by article link

            parsedData.forEach(row => {
                const articleLink = row.Link; // Assuming 'Link' is unique for each article

                if (!articlesMap.has(articleLink)) {
                    // If this is the first row for this article, initialize its consolidated data
                    articlesMap.set(articleLink, {
                        date: row.Date || '',
                        title: row.Title || '',
                        link: row.Link || '',
                        outlet: row.Outlet || '',
                        country: row.Country || '',
                        context: row.Context || '',
                        category: row.Category || '',
                        // Initialize arrays to collect all data points for this article
                        dataUses: [],
                        providers: [],
                        platforms: [],
                        resolutions: [],
                        representations: [],
                        domains: [], // NEW: Initialize domains array
                        vizs: []
                    });
                }

                // Get the consolidated article object
                const article = articlesMap.get(articleLink);

                // Append data from the current row to the consolidated arrays
                // Ensure no empty strings are added if the original CSV cell is blank
                if (row['Data use']) article.dataUses.push(...row['Data use'].split(/[,;]/).map(du => du.trim()).filter(du => du));
                if (row.Provider) article.providers.push(...row.Provider.split(/[,;]/).map(p => p.trim()).filter(p => p));
                if (row.Platform) article.platforms.push(...row.Platform.split(/[,;]/).map(pl => pl.trim()).filter(pl => pl));
                if (row.Resolution) article.resolutions.push(...row.Resolution.split(/[,;]/).map(r => r.trim()).filter(r => r));
                if (row.Representation) article.representations.push(...row.Representation.split(/[,;]/).map(r => r.trim()).filter(r => r));
                if (row.Domain) article.domains.push(...row.Domain.split(/[,;]/).map(d => d.trim()).filter(d => d)); // NEW: Populate domains
                if (row.Viz) article.vizs.push(...row.Viz.split(/[,;]/).map(v => v.trim()).filter(v => v));
            });

            // Now, transform the consolidated articles into the final allData structure
            allData = Array.from(articlesMap.values()).map(article => {
                // Remove duplicates from collected arrays (e.g., if 'TBA' appears multiple times for one article)
                article.dataUses = [...new Set(article.dataUses)];
                article.providers = [...new Set(article.providers)];
                article.platforms = [...new Set(article.platforms)];
                article.resolutions = [...new Set(article.resolutions)];
                article.representations = [...new Set(article.representations)];
                article.domains = [...new Set(article.domains)]; // NEW: De-duplicate domains
                article.vizs = [...new Set(article.vizs)];

                const publicationYear = article.date ? new Date(article.date).getFullYear() : null;
                const region = countryRegions[article.country] || '';

                // Determine the maximum number of data points for this consolidated article
                // Ensure that even if all arrays are empty, there's at least one data point to display an empty row if needed
                const maxLen = Math.max(
                    article.dataUses.length,
                    article.providers.length,
                    article.platforms.length,
                    article.resolutions.length,
                    article.representations.length,
                    article.domains.length, // NEW: Include domains length
                    article.vizs.length,
                    1 // Ensure at least one cdp for articles with no specific data points
                );

                // Create combinedDataPoints based on the consolidated, de-duplicated lists
                const combinedDataPoints = Array.from({ length: maxLen }).map((_, i) => ({
                    dataUseYear: article.dataUses[i] || article.dataUses[0] || '', // Use first if subsequent is missing
                    provider: article.providers[i] || article.providers[0] || '',
                    platform: article.platforms[i] || article.platforms[0] || '',
                    resolution: article.resolutions[i] || article.resolutions[0] || '',
                    resolutionCategory: getMeterCategory(article.resolutions[i] || article.resolutions[0] || ''),
                    representation: article.representations[i] || article.representations[0] || '',
                    domain: article.domains[i] || article.domains[0] || '', // NEW: Add domain
                    viz: article.vizs[i] || article.vizs[0] || ''
                }));

                return {
                    date: article.date,
                    publicationYear: publicationYear,
                    title: article.title,
                    link: article.link,
                    outlet: article.outlet,
                    country: article.country,
                    region: region,
                    context: article.context,
                    category: article.category,
                    combinedDataPoints: combinedDataPoints.filter(cdp =>
                        Object.values(cdp).some(value => value !== '')
                    ).length > 0 ? combinedDataPoints : [{ // If all cdp fields are empty, ensure one empty cdp
                        dataUseYear: '',
                        provider: '',
                        platform: '',
                        resolution: '',
                        resolutionCategory: '',
                        representation: '',
                        domain: '', // NEW: Add empty domain
                        viz: ''
                    }]
                };
            });

            initializeFilters();
            filterTable();
            loadingStatus.style.display = 'none';
            statsDisplay.style.display = 'block';

        } catch (error) {
            console.error('Error loading or parsing data:', error);
            loadingStatus.textContent = 'Failed to load data.'; // Indicate failure to user
            statsDisplay.style.display = 'none'; // Hide stats if data load fails
        }
    };


    function initializeFilters() {
        const uniqueOutlets = [...new Set(allData.map(item => item.outlet).filter(o => o))];
        populatePills('outlet-filter-pills', uniqueOutlets, 'outlet');

        const uniqueProviders = [...new Set(allData.flatMap(item => item.combinedDataPoints.map(cdp => cdp.provider).filter(p => p)))];
        populatePills('provider-filter-pills', uniqueProviders, 'provider');

        const uniqueVizs = [...new Set(allData.flatMap(item => item.combinedDataPoints.map(cdp => cdp.viz).filter(v => v)))];
        populatePills('viz-filter-pills', uniqueVizs, 'viz');

        const uniqueRepresentations = [...new Set(allData.flatMap(item => item.combinedDataPoints.map(cdp => cdp.representation).filter(r => r)))];
        populatePills('representation-filter-pills', uniqueRepresentations, 'representation');

        // NEW: Initialize Domain filter
        const uniqueDomains = [...new Set(allData.flatMap(item => item.combinedDataPoints.map(cdp => cdp.domain).filter(d => d)))];
        populatePills('domain-filter-pills', uniqueDomains, 'domain');


        // Populate Data Use Years
        const uniqueYears = [...new Set(allData.flatMap(item => item.combinedDataPoints.map(cdp => cdp.dataUseYear).filter(y => y)))].sort().reverse();
        populatePills('years-filter-pills', uniqueYears, 'years');

        // Populate Focus Countries dynamically with all initially
        const allUniqueCountries = [...new Set(allData.map(item => item.country).filter(c => c))].sort();
        populatePills('focus-filter-pills', allUniqueCountries, 'focus');
    }

    function populatePills(containerId, values, type) {
        const container = document.getElementById(containerId);
        container.innerHTML = ''; // Clear existing pills

        // Create and append the "All" pill first
        const allButton = document.createElement('button');
        allButton.classList.add('pill', 'active');
        allButton.setAttribute('data-type', type);
        allButton.setAttribute('data-value', 'all');
        allButton.textContent = 'All';
        allButton.addEventListener('click', handlePillClick);
        container.appendChild(allButton);

        // Append other values
        values.forEach(value => {
            if (value && value !== 'all' && value !== 'TBA') { // Skip 'TBA'
                const button = document.createElement('button');
                button.classList.add('pill');
                button.setAttribute('data-type', type);
                button.setAttribute('data-value', value);
                button.textContent = value;
                button.addEventListener('click', handlePillClick);
                container.appendChild(button);
            }
        });
    }

    function handlePillClick(event) {
        const clickedPill = event.target;
        const type = clickedPill.getAttribute('data-type');
        const value = clickedPill.getAttribute('data-value');
        const parentContainer = clickedPill.closest('.filter-pills');

        if (type === 'region') {
            selectedRegion = value;
            document.querySelectorAll('.pill[data-type="region"]').forEach(pill => pill.classList.remove('active'));
            clickedPill.classList.add('active');

            const focusFilterSection = document.getElementById('focus-filter-section');
            
            if (selectedRegion === 'all') {
                focusFilterSection.style.display = 'none';
                const allUniqueCountries = [...new Set(allData.map(item => item.country).filter(c => c))].sort();
                populatePills('focus-filter-pills', allUniqueCountries, 'focus');
                selectedFocuses = ['all'];
            } else {
                focusFilterSection.style.display = 'block';
                const countriesInSelectedRegion = [...new Set(allData
                    .filter(item => item.region === selectedRegion)
                    .map(item => item.country)
                    .filter(c => c)
                )].sort();
                populatePills('focus-filter-pills', countriesInSelectedRegion, 'focus');
                selectedFocuses = ['all']; // Reset to 'all' for the newly filtered countries
            }
        } else if (type === 'focus') {
            if (value === 'all') {
                document.querySelectorAll('.pill[data-type="focus"]').forEach(pill => pill.classList.remove('active'));
                clickedPill.classList.add('active');
                selectedFocuses = ['all'];
            } else {
                const allPill = document.querySelector('.pill[data-type="focus"][data-value="all"]');
                if (allPill.classList.contains('active')) {
                    allPill.classList.remove('active');
                    selectedFocuses = [value];
                } else {
                    if (clickedPill.classList.contains('active')) {
                        selectedFocuses = selectedFocuses.filter(f => f !== value);
                    } else {
                        selectedFocuses.push(value);
                    }
                }
                clickedPill.classList.toggle('active');
                if (selectedFocuses.length === 0) {
                    allPill.classList.add('active');
                    selectedFocuses = ['all'];
                }
            }
        } else if (type === 'years') {
            if (value === 'all') {
                document.querySelectorAll('.pill[data-type="years"]').forEach(pill => pill.classList.remove('active'));
                clickedPill.classList.add('active');
                selectedYears = ['all'];
            } else {
                const allPill = document.querySelector('.pill[data-type="years"][data-value="all"]');
                if (allPill.classList.contains('active')) {
                    allPill.classList.remove('active');
                    selectedYears = [value];
                } else {
                    if (clickedPill.classList.contains('active')) {
                        selectedYears = selectedYears.filter(y => y !== value);
                    } else {
                        selectedYears.push(value);
                    }
                }
                clickedPill.classList.toggle('active');
                if (selectedYears.length === 0) {
                    allPill.classList.add('active');
                    selectedYears = ['all'];
                }
            }
        } else if (type === 'publicationYear') {
            document.getElementById('fromYearInput').value = '';
            document.getElementById('toYearInput').value = '';
            document.querySelectorAll('.pill[data-type="publicationYear"]').forEach(pill => pill.classList.remove('active'));
            clickedPill.classList.add('active');
        } else {
            if (value === 'all') {
                parentContainer.querySelectorAll('.pill').forEach(pill => pill.classList.remove('active'));
                clickedPill.classList.add('active');
            } else {
                const allPill = parentContainer.querySelector('.pill[data-value="all"]');
                if (allPill && allPill.classList.contains('active')) {
                    allPill.classList.remove('active');
                }
                clickedPill.classList.toggle('active');

                if (!parentContainer.querySelector('.pill.active')) {
                    allPill.classList.add('active');
                }
            }
        }
        filterTable();
    }

    function toggleAllFilters(forceClose = false) {
        const filterGroups = document.querySelectorAll('.filter-group');
        filterGroups.forEach(group => {
            if (!filtersActive || forceClose) {
                group.classList.remove('active');
            } else {
                group.classList.remove('active');
            }
        });
        adjustContentViewHeight();
    }

    function updateView() {
        const tableViewContainer = document.getElementById('tableViewContainer');
        const feedViewContainer = document.getElementById('feedViewContainer'); // Changed from titleOnlyViewContainer

        // Hide all view containers first
        tableViewContainer.classList.add('hidden');
        feedViewContainer.classList.add('hidden');

        // Show the active view container
        if (currentView === 'table') {
            tableViewContainer.classList.remove('hidden');
        } else if (currentView === 'feed') { // Changed from 'title'
            feedViewContainer.classList.remove('hidden');
        }
        filterTable();
        adjustContentViewHeight();
    }


    function renderTable() {
        const tbody = document.querySelector('table tbody');
        tbody.innerHTML = '';

        const fromYear = parseInt(document.getElementById('fromYearInput').value);
        const toYear = parseInt(document.getElementById('toYearInput').value);

        const selectedOutlets = Array.from(document.querySelectorAll('.pill[data-type="outlet"].active'))
            .map(pill => pill.getAttribute('data-value'))
            .filter(value => value !== 'all');
        const allOutletsActive = selectedOutlets.length === 0 || selectedOutlets.includes('all');

        const filteredResults = [];

        allData.forEach(item => {
            const visibleCombinedDataPoints = item.combinedDataPoints.filter(cdp => {
                return applyAllFiltersToItemAndCombinedDataPoint(item, cdp, fromYear, toYear, allOutletsActive, selectedOutlets);
            });

            if (visibleCombinedDataPoints.length > 0) {
                filteredResults.push({ item: item, visibleCombinedDataPoints: visibleCombinedDataPoints });
            }
        });

        filteredResults.forEach((result, articleIndex) => {
            const item = result.item;
            const visibleCombinedDataPoints = result.visibleCombinedDataPoints;
            const rowspan = visibleCombinedDataPoints.length;

            visibleCombinedDataPoints.forEach((cdp, cdpIndex) => {
                const row = document.createElement('tr');
                row.setAttribute('data-original-index', allData.indexOf(item));
                row.setAttribute('data-combined-data-point-index', cdpIndex);

                if (cdpIndex === 0) {
                    row.classList.add('article-start');
                }

                if (cdpIndex === visibleCombinedDataPoints.length - 1) {
                    row.classList.add('last-cdp-of-article');
                }

                if (cdpIndex === 0) {
                    row.innerHTML = `
                        <td rowspan="${rowspan}">${item.date}</td>
                        <td rowspan="${rowspan}">${item.title}</td>
                        <td rowspan="${rowspan}"><a href="${item.link}" target="_blank">Link</a></td>
                        <td rowspan="${rowspan}">${item.outlet}</td>
                        <td rowspan="${rowspan}">${item.country}</td>
                        <td rowspan="${rowspan}">${item.context}</td>
                        <td rowspan="${rowspan}">${item.category}</td>
                        <td class="data-detail-cell ${cdp.dataUseYear === 'TBA' ? 'tba-text' : ''}">${cdp.dataUseYear}</td>
                        <td class="data-detail-cell ${cdp.provider === 'TBA' ? 'tba-text' : ''}">${cdp.provider}</td>
                        <td class="data-detail-cell ${cdp.platform === 'TBA' ? 'tba-text' : ''}">${cdp.platform}</td>
                        <td class="data-detail-cell ${cdp.representation === 'TBA' ? 'tba-text' : ''}">${cdp.representation}</td>
                        <td class="data-detail-cell ${cdp.domain === 'TBA' ? 'tba-text' : ''}">${cdp.domain}</td> <td class="data-detail-cell ${cdp.resolution === 'TBA' ? 'tba-text' : ''}">${cdp.resolution}</td>
                        <td class="data-detail-cell ${cdp.viz === 'TBA' ? 'tba-text' : ''}">${cdp.viz}</td>
                    `;
                } else {
                    row.innerHTML = `
                        <td class="data-detail-cell ${cdp.dataUseYear === 'TBA' ? 'tba-text' : ''}">${cdp.dataUseYear}</td>
                        <td class="data-detail-cell ${cdp.provider === 'TBA' ? 'tba-text' : ''}">${cdp.provider}</td>
                        <td class="data-detail-cell ${cdp.platform === 'TBA' ? 'tba-text' : ''}">${cdp.platform}</td>
                        <td class="data-detail-cell ${cdp.representation === 'TBA' ? 'tba-text' : ''}">${cdp.representation}</td>
                        <td class="data-detail-cell ${cdp.domain === 'TBA' ? 'tba-text' : ''}">${cdp.domain}</td> <td class="data-detail-cell ${cdp.resolution === 'TBA' ? 'tba-text' : ''}">${cdp.resolution}</td>
                        <td class="data-detail-cell ${cdp.viz === 'TBA' ? 'tba-text' : ''}">${cdp.viz}</td>
                    `;
                }
                tbody.appendChild(row);
            });
        });
        updateFilterCount(filteredResults.length);
    }

    function renderFeedOnlyView() { // Renamed from renderTitleOnlyView
        let feedContainer = document.getElementById('feedViewContainer'); // Renamed ID
        if (!feedContainer) { // Create if it doesn't exist
            feedContainer = document.createElement('div');
            feedContainer.id = 'feedViewContainer';
            feedContainer.classList.add('feed-view-container'); // Renamed class
            document.body.appendChild(feedContainer);
        }
        feedContainer.innerHTML = '';

        const fromYear = parseInt(document.getElementById('fromYearInput').value);
        const toYear = parseInt(document.getElementById('toYearInput').value);

        const selectedOutlets = Array.from(document.querySelectorAll('.pill[data-type="outlet"].active'))
            .map(pill => pill.getAttribute('data-value'))
            .filter(value => value !== 'all');
        const allOutletsActive = selectedOutlets.length === 0 || selectedOutlets.includes('all');

        const filteredArticles = []; // Renamed from filteredTitles
        const uniqueArticleTitles = new Set(); // To ensure unique articles

        allData.forEach(item => {
            const hasMatchingCdp = item.combinedDataPoints.some(cdp => {
                return applyAllFiltersToItemAndCombinedDataPoint(item, cdp, fromYear, toYear, allOutletsActive, selectedOutlets);
            });

            if (hasMatchingCdp && item.title && !uniqueArticleTitles.has(item.title)) {
                filteredArticles.push(item); // Push the entire item
                uniqueArticleTitles.add(item.title);
            }
        });

        if (filteredArticles.length === 0) {
            feedContainer.innerHTML = '<p style="padding: 20px; text-align: center; color: #666;">No articles found matching the selected filters.</p>';
        } else {
            filteredArticles.forEach(item => {
                const articleWrapper = document.createElement('div');
                articleWrapper.classList.add('article-item'); // Apply main styling

                const articleTitle = document.createElement('div');
                articleTitle.classList.add('article-title'); // Add a class for the title text if needed
                articleTitle.innerHTML = `<a href="${item.link}" target="_blank">${item.title}</a>`;

                const articleDetails = document.createElement('div');
                articleDetails.classList.add('article-details');

                let detailsParts = [];
                if (item.outlet) detailsParts.push(item.outlet);
                if (item.date) detailsParts.push(item.date);

                articleDetails.textContent = detailsParts.join(', ');

                articleWrapper.appendChild(articleTitle);
                articleWrapper.appendChild(articleDetails);

                feedContainer.appendChild(articleWrapper);
            });
        }
        updateFilterCount(filteredArticles.length);
    }


    function applyAllFiltersToItemAndCombinedDataPoint(item, cdp, fromYear, toYear, allOutletsActive, selectedOutlets) {
        if (!filtersActive) return true;

        const outletMatch = allOutletsActive || selectedOutlets.includes(item.outlet);
        const regionMatch = (selectedRegion === 'all' || item.region === selectedRegion);
        const countryMatch = (selectedFocuses.includes('all') || selectedFocuses.includes(item.country));

        let publicationYearMatch = true;
        const publicationYearPillAllActive = document.querySelector('.pill[data-type="publicationYear"][data-value="all"]').classList.contains('active');

        if (!publicationYearPillAllActive) {
            if (item.publicationYear !== null) {
                if (fromYear && item.publicationYear < fromYear) {
                    publicationYearMatch = false;
                }
                if (toYear && item.publicationYear > toYear) {
                    publicationYearMatch = false;
                }
            } else {
                publicationYearMatch = false; // If no publication year, it doesn't match a specific range
            }
        }


        const providerPills = document.querySelectorAll('.pill[data-type="provider"].active');
        const allProvidersActive = Array.from(providerPills).some(pill => pill.getAttribute('data-value') === 'all');
        const selectedProviders = Array.from(providerPills)
            .map(pill => pill.getAttribute('data-value'))
            .filter(value => value !== 'all');

        const resolutionCategoryPills = document.querySelectorAll('.pill[data-type="resolutionCategory"].active');
        const allResolutionCategoriesActive = Array.from(resolutionCategoryPills).some(pill => pill.getAttribute('data-value') === 'all');
        const selectedResolutionCategories = Array.from(resolutionCategoryPills)
            .map(pill => pill.getAttribute('data-value'))
            .filter(value => value !== 'all');

        const yearsPills = document.querySelectorAll('.pill[data-type="years"].active');
        const allYearsActive = Array.from(yearsPills).some(pill => pill.getAttribute('data-value') === 'all');
        const currentSelectedYears = Array.from(yearsPills)
                                    .map(pill => pill.getAttribute('data-value'))
                                    .filter(value => value !== 'all');
        selectedYears = currentSelectedYears.length === 0 && !allYearsActive ? ['all'] : currentSelectedYears;


        const vizPills = document.querySelectorAll('.pill[data-type="viz"].active');
        const allVizActive = Array.from(vizPills).some(pill => pill.getAttribute('data-value') === 'all');
        const selectedViz = Array.from(vizPills)
            .map(pill => pill.getAttribute('data-value'))
            .filter(value => value !== 'all');

        const representationPills = document.querySelectorAll('.pill[data-type="representation"].active');
        const allRepresentationsActive = Array.from(representationPills).some(pill => pill.getAttribute('data-value') === 'all');
        const selectedRepresentations = Array.from(representationPills)
            .map(pill => pill.getAttribute('data-value'))
            .filter(value => value !== 'all');

        // NEW: Domain filter logic
        const domainPills = document.querySelectorAll('.pill[data-type="domain"].active');
        const allDomainsActive = Array.from(domainPills).some(pill => pill.getAttribute('data-value') === 'all');
        const selectedDomains = Array.from(domainPills)
            .map(pill => pill.getAttribute('data-value'))
            .filter(value => value !== 'all');


        const dataUseYearMatch = allYearsActive || selectedYears.includes(cdp.dataUseYear);
        const providerMatch = allProvidersActive || selectedProviders.includes(cdp.provider);
        const resolutionCategoryMatch = allResolutionCategoriesActive || selectedResolutionCategories.includes(cdp.resolutionCategory);
        const vizMatch = allVizActive || selectedViz.includes(cdp.viz);
        const representationMatch = allRepresentationsActive || selectedRepresentations.includes(cdp.representation);
        const domainMatch = allDomainsActive || selectedDomains.includes(cdp.domain); // NEW: Domain Match


        return outletMatch && regionMatch && countryMatch && publicationYearMatch &&
               dataUseYearMatch && providerMatch && resolutionCategoryMatch &&
               vizMatch && representationMatch && domainMatch; // NEW: Include domainMatch
    }


    function filterTable() {
        if (currentView === 'table') {
            renderTable();
        } else {
            renderFeedOnlyView(); // Call the new feed rendering function
        }
    }

    function updateFilterCount(filteredCount) {
      const totalCount = allData.length;
      const statsDisplay = document.getElementById('statsDisplay');
      if (statsDisplay) {
        // Determine if any filters are actively narrowing down the literature data
        const hasActiveFilters = document.querySelectorAll('.filter-pills .pill.active:not([data-value="all"])').length > 0 ||
                                 document.getElementById('fromYearInput').value !== '' ||
                                 document.getElementById('toYearInput').value !== '';

        // Add a class for the span that will contain the numbers
        const numberSpanClass = 'article-count-number';

        if (currentView === 'table' || currentView === 'feed') { // Apply to both table and feed views
            if (hasActiveFilters && filtersActive) {
                // Now using the CSS class for spacing instead of inline style
                statsDisplay.innerHTML = `Articles:<span class="${numberSpanClass}">${filteredCount}</span><sup style="font-size: 0.5em; vertical-align: super; color: lightgrey;">/<span class="${numberSpanClass}">${totalCount}</span></sup>`;
            } else {
                // Now using the CSS class for spacing instead of inline style
                statsDisplay.innerHTML = `Articles:<span class="${numberSpanClass}">${totalCount}</span>`;
            }
        }
      }
    }
  </script>
</body>
</html>
